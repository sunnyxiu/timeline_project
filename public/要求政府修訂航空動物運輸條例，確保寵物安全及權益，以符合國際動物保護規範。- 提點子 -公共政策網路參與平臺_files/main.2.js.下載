var _scanIframeTimer;var _scanIframeTimeInterval=125;var _lineIframeMap={};
$(function(){_initForVisible();_initMenuForMobile();_initMSIEMessage();window._uniVCodeView=new VCodeViewModel({"vCodeKey":$("#uniVCodeViewConfig").attr("data-vCodeKey")});$(".gotop, .top-btn").click(function(){$("html,body").animate({scrollTop:0},"slow");return false}).keydown(function(event){if(event.keyCode===13){event.preventDefault();$(this).trigger("click")}});$(".loginside").keydown(function(event){if(event.keyCode===13){event.preventDefault();$(this).addClass("hover")}});$(".qqaa_login").keydown(function(event){if(event.keyCode===
13){event.preventDefault();$(this).trigger("click")}}).blur(function(){$(".loginside").removeClass("hover")});$("[data-toUrl]").click(function(){var $this=$(this);if($this.attr("data-toTarget")==="_blank"){window.open($this.attr("data-toUrl"));return}window.location.href=$this.attr("data-toUrl")}).keydown(function(event){if(event.keyCode===13){event.preventDefault();$(this).trigger("click")}}).on("touchstart",function(event){event.stopPropagation();event.preventDefault();$(this).trigger("click");
return false});$('[data-touchTourl\x3d"true"]').bind("touchstart",function(e){var url=$(this).attr("href");if(url==null||url.legnth===0)return;window.location.href=url});$('[data-keydownAsClick\x3d"true"]').keydown(function(event){if(event.keyCode===13||event.keyCode===32){$(this).trigger("click");event.preventDefault()}});if("onhashchange"in window)window.onhashchange=function(){handleHashChanged(window.location.hash)};else{var storedHash=window.location.hash;window.setInterval(function(){if(window.location.hash!==
storedHash){storedHash=window.location.hash;handleHashChanged(storedHash)}},100)}addAccessibilityIframeOnReady();_scanIframeTimer=setInterval(addAccessibilityIframe,_scanIframeTimeInterval);$("a").each(function(){var link=$(this);var href=link.attr("href");if(href==null||href==="")return;if(href.indexOf("/attachments/fe84c0e7-c2c9-483f-97c3-a6383b3fa064")!==-1){href+="/download/公共政策網路參與實施要點.pdf";link.attr("href",href)}});$('span[data-toggle\x3d"collapse"]').keydown(function(e){if(e.keyCode===13){e.preventDefault();
$(this).trigger("click");return false}return true});$(".detail_edit a").each(_linkTitleFromRemote);$("a.accessJumper").click(function(event){window.location.hash="#jumper";$("#M").focus();event.preventDefault();return false}).keydown(function(event){if(event.keyCode===13||event.keyCode===32){$(this).trigger("click");return false}return true});$("#unreadNotificationFlag").userUnreadNotification();$("form.alwaysCanSubmit").each(function(){var $this=$(this);$this.append($("\x3cinput\x3e",{type:"hidden",
name:"ct",value:(new Date).getTime()}))});$("[data-toLink]").each(function(){$(this).css({"cursor":"pointer"})}).click(function(event){event.preventDefault();event.stopPropagation();var t=$(this);var href=t.attr("data-toLink");if(href==="")return;var target=t.attr("data-toTarget");if(target==="_blank"){window.open(href);return}window.location.href=href}).keydown(function(event){if(event.keyCode===13||event.keyCode===32){event.preventDefault();$(this).trigger("click")}});$("input.radioATarget").focus(function(event){$(this).siblings(".radioABorder").show()}).blur(function(event){$(this).siblings(".radioABorder").hide()});
$("label.c-label-checkbox").keydown(_labelClickHandler);$("#share-btn-area-d a:first").keydown(function(e){if(e.keyCode===9&&e.shiftKey===true)$("#share-btn-area-s-d").trigger("click");return true});$("#share-btn-area-d a:last").keydown(function(e){if(e.keyCode===9&&e.shiftKey===false)$("#share-btn-area-s-d").trigger("click");return true});$(".shareLineButton").each(function(index){var id="shareLineButton_"+index;var $this=$(this);$this.attr("id",id);var timer=_lineIframeMap[id];if(timer!=null)return;
timer=setInterval(function(){var ifr=$this.find("iframe");if(ifr.length===0)return;var maskButton=$this.find("button.shareLineButtonMask");if(maskButton.length!==0)return;$this.data("lineIframe",ifr[0]);var showTitle=$this.attr("data-show-title");if(showTitle==="")showTitle=null;ifr.attr("tabindex","-1").load(function(){});var $parent=ifr.parent();var dataUrl=ifr.attr("data-url");$("\x3cbutton/\x3e",{"tabindex":"0","class":"shareLineButtonMask","title":showTitle||ifr.attr("title")}).css({"position":"absolute",
"width":$parent.width(),"height":$parent.height(),"z-index":100,"background-color":"white"}).append($("\x3cimg/\x3e",{"src":contextPath+"/images/line_60.png","alt":showTitle||ifr.attr("title")})).prependTo($this).fadeTo(10,0).click(function(e){var $this=$(this);if($this.data("clicked")==="1")return;$this.data("clicked","1");e.preventDefault();e.stopPropagation();var openUrl="https://social-plugins.line.me/lineit/share?url\x3d"+encodeURIComponent(dataUrl);var t=0,i=0;void 0!==window.screenX&&window.screenX>=
0&&window.screenY>=0?(t=(window.screen.availWidth-503)/2,i=(window.screen.availHeight-510)/2):void 0!==window.screenLeft&&window.screenLeft>=0&&window.screenTop>=0&&(t=(window.screen.availWidth-503)/2,i=(window.screen.availHeight-510)/2);window.open(openUrl,"shareToLine","width\x3d503,height\x3d510,left\x3d"+t+",top\x3d"+i+",resizable\x3dyes,scrollbars\x3dno,chrome\x3dyes,centerscreen\x3dyes");$this.data("clicked","0");return false}).keydown(function(e){if(e.keyCode===13){e.preventDefault();e.stopPropagation();
$(this).trigger("click");return false}return true}).focus(function(e){$(this).parent().addClass("active")}).blur(function(e){$(this).parent().removeClass("active")})},100);_lineIframeMap[id]=timer});$(".btn-loca button").click(function(){if($(".modal").hasClass(".show"));else $(".top").css("z-index","999")});$(".close-btn").click(function(){$(".top").css("z-index","99999")});$(window).scroll(function(){var scroll=$(window).scrollTop();var $pageSearch=$(".page_search");if(scroll>=50){$pageSearch.addClass("header-boxshadow");
return}if(!$pageSearch.hasClass("c-show-not-index"))$pageSearch.removeClass("header-boxshadow")});$(".c-site-search-btn").click(function(e){e.preventDefault();var $pageSearch=$(".page_search").toggle();if($pageSearch.is(":visible")){$("#searchBoxKeyword").focus();if($pageSearch.hasClass("c-show-not-index"))$pageSearch.addClass("header-boxshadow")}return false});_initDetailPage();_initKoBindCommonTool()});
function _koApplyBindToMainContainer(viewModel,containerId){_customKoBindingCommon();var useContainerId=containerId||"koBindMainContainer";var target=document.getElementById(useContainerId);if(target)ko.applyBindings(viewModel,target);else ko.applyBindings(viewModel)}function _initForVisible(){$(".script_on_visible").show();$(".script_on_visible_b").css({"display":"block"});$(".script_on_invisible_n").hide().removeClass("script_on_invisible_n")}
function _labelClickHandler(e){if(e.keyCode===13){e.preventDefault();var $label=$(this);var $cbk=$("#"+$label.attr("for"));$cbk.trigger("click");return false}return true}
function _showOuterMessageDialog(options){var opts=$.extend({"title":"","message":"","maxWidth":"80%","minWidth":"350px","disableCloseBtn":false,"closeBtnText":"關閉","selector":"","buttons":[]},options);var $box=$("#outerMessageDialog");var $content=$("#outerMessageDialogContent");var $dialog=$box.find(".modal-dialog");if(opts.maxWidth)$dialog.css("max-width",opts.maxWidth);if(opts.minWidth)$dialog.css("min-width",opts.minWidth);var $footer=$box.find(".modal-footer").empty();$("#outerMessageDialogTitle").html(opts.title||
"\x26nbsp;");if(opts.selector!="")$(opts.selector).appendTo($content).show();else if(opts.message!="")$content.html(opts.message);if($.isArray(opts.buttons)&&opts.buttons.length>0)$.each(opts.buttons,function(index,btn){$("\x3cbutton/\x3e",{"class":"btn btn-primary c-modal-button","data-m-key":btn.mKey,"html":btn.text}).click({btnOptions:btn},function(e){var btnOpt=e.data.btnOptions;if(typeof btnOpt.click=="function")btnOpt.click();var autoClose=!btnOpt.notAutoClose;if(autoClose)$("#outerMessageDialog").modal("hide");
var rmByCallback=btnOpt.rmByCallback;if(typeof rmByCallback=="function"){var v1=rmByCallback();if(v1===true)$(this).remove();return}var rmAfterClick=btnOpt.rmAfterClick;if(rmAfterClick)$(this).remove()}).appendTo($footer)});if(!opts.disableCloseBtn)$("\x3cbutton/\x3e",{"class":"btn btn-primary-outline-b","text":opts.closeBtnText}).click(opts,function(e){var s=e.data.selector;if(s!="")$(s).hide().appendTo($("body"));$("#outerMessageDialog").modal("hide")}).appendTo($footer);$box.modal("show")}
function _initMSIEMessage(){var userAgent=navigator.userAgent.toLowerCase();if(userAgent.match("msie")!=null){var version=parseInt(userAgent.substr(userAgent.indexOf("msie")+5,2));if(version<9)_showOuterMessageDialog({"title":"建議使用瀏覽器公告","selector":"#loginDialog"})}}
function _initMenuForMobile(){$(".menu_btn").unbind("click");$(".nav_mobile").css({"left":"-500px"});$(".menu_btn").bind("click",function(){if($(".menu_btn").hasClass("close")){$(".nav_mobile").show().animate({"left":"0"},300);$(".wrapper").animate({"margin-left":"0px"},300);$(".menu_btn").removeClass("close")}else{$(".nav_mobile").animate({"left":"-500px"},300,"swing",function(){$(this).hide()});$(".wrapper").animate({"margin-left":"200px"},300);$(".menu_btn").addClass("close")}});$(".nav_mobile div.black_bg").click(function(){$(".menu_btn").trigger("click")});
window.addEventListener("resize",function(event){if(screen.width>768)$(".nav_mobile").hide()});$(".mobileLoginBtn").click(function(event){event.preventDefault();var $this=$(this);$this.toggleClass("openMemberInfoBox");if($this.hasClass("openMemberInfoBox"))$this.siblings("div.layer_2").show();else $this.siblings("div.layer_2").hide()})}
function _initKoBindCommonTool(){var bottomNavBarElt=$("#bottomNavBar");if(bottomNavBarElt.length>0){ko.applyBindings(new FooterNavBar($.extend(_moduleLoader,{})),bottomNavBarElt[0]);$(window).scroll(function(){var last=window["_lastScrollTop"]||0;var cur=$(this).scrollTop();var curDir;if(cur>last)curDir="down";else curDir="up";window["_lastScrollTop"]=cur;var lastDir=window["_lastScrollDirection"]||"";if(lastDir===curDir)return;if(curDir==="down"){bottomNavBarElt.find(".flex-between").removeClass("hideNav");
$("#sidebarBox2 .fixed-btn-m").removeClass("hideNav")}else if(curDir==="up"){bottomNavBarElt.find(".flex-between").addClass("hideNav");$("#sidebarBox2 .fixed-btn-m").addClass("hideNav")}window["_lastScrollDirection"]=curDir})}var bottomSideBarElt=$("#bottomSideBar");if(bottomSideBarElt.length>0)ko.applyBindings(new BottomSideBarView,bottomSideBarElt[0]);$("div[data-c-mv]").each(function(){var $this=$(this),toEltId=$this.attr("data-c-mv");var $cont=$("#"+toEltId);if($cont.length===0)return;$this.appendTo($cont)});
$("#bottomSideBar,#bottomSideBarOnDesktop").each(function(){var $box=$(this);$box.find(".openTool").click(function(e){e.preventDefault();$(this).addClass("hideNav");$box.find(".share-btn,.fanclub-btn,.close-btn").removeClass("hideNav");$box.find("a.share-btn").focus();return false}).keydown(function(e){if(e.keyCode===13||e.keyCode===32){e.preventDefault();$(this).trigger("click")}});$box.find(".close-btn").click(function(e){e.preventDefault();var $f1=$("#share-btn-area"),$f2=$("#share-btn-area-d"),
$f3=$("#share-btn-area-m");if($f1.hasClass("show"))$("#share-btn-area-link").trigger("click");if($f2.hasClass("show"))$("#share-btn-area-s-d").trigger("click");if($f3.hasClass("show"))$("#share-btn-area-s-m").trigger("click");$(this).addClass("hideNav");$box.find(".share-btn,.fanclub-btn").addClass("hideNav");$box.find(".openTool").removeClass("hideNav");$box.find(".openTool").focus();return false}).keydown(function(e){if(e.keyCode===13||e.keyCode===32){e.preventDefault();$(this).trigger("click")}})});
var bottomAdviseElt=$("#bottomAdvisePanel");window["_bottomAdvisePanelView"]=new BottomAdvisePanelView;if(bottomAdviseElt.length>0)ko.applyBindings(window["_bottomAdvisePanelView"],bottomAdviseElt[0]);$("#bottomAdvisePanelAccordionContent").on("shown.bs.collapse",function(){if(window["_bottomAdvisePanelView"])window["_bottomAdvisePanelView"].open()}).on("hidden.bs.collapse",function(){if(window["_bottomAdvisePanelView"])window["_bottomAdvisePanelView"].close()}).on("shown.bs.collapse hidden.bs.collapse",
function(){var $link=$("#bottomAdvisePanelAccordionHeader a"),$bca=$("#bottomContainerAccordion");var isExpanded=$link.attr("aria-expanded");if(isExpanded==="true")$bca.attr("title","點擊收合顯示對平臺服務的建議");else $bca.attr("title","點擊展開顯示對平臺服務的建議")});$("#bottomContainerAccordion").keydown(function(e){if(e.keyCode===13){var $target=$(e.target);if($target.attr("id")==="bottomContainerAccordion"){e.preventDefault();$("#bottomAdvisePanelAccordionHeader a").trigger("click");return false}}return true})}
function _initDetailPage(){$(".fb-btn").click(function(e){var shareUrl=$(this).attr("data-shareUrl");if(shareUrl){e.preventDefault();e.stopPropagation();window.open(shareUrl);return false}return true});$("a.c-fb-btn.c-share-btn").each(function(){var $this=$(this);var shareUrl=window.location.href;var targetUrl="https://www.facebook.com/share.php";var qs=$.param({u:shareUrl});$this.attr("href",targetUrl+"?"+qs)});$("a.c-twitter-btn.c-share-btn").each(function(){var $this=$(this);var shareUrl=window.location.href;
var targetUrl="https://twitter.com/intent/tweet";var qs=$.param({url:shareUrl});$this.attr("href",targetUrl+"?"+qs)});$("a.c-telegram-btn.c-share-btn").each(function(){var $this=$(this);var shareUrl=window.location.href;var targetUrl="https://telegram.me/share/url";var qs=$.param({url:shareUrl});$this.attr("href",targetUrl+"?"+qs)});try{if(window["LineIt"])LineIt.loadButton()}catch(ex){}$("a.line-btn,a.c-line-btn").click(function(e){e.preventDefault();var shareUrl=$(this).attr("data-shareUrl");if($(this).hasClass("c-share-btn"))shareUrl=
window.location.href;var targetUrl="https://social-plugins.line.me/lineit/share";var qs=$.param({url:shareUrl});window.open(targetUrl+"?"+qs);return false});$("div.c-response-click-more").each(function(i,panel){var $panel=$(panel),$contentBox=$panel.children("div.c-govResp-content"),$moreBtn=$panel.find("div.c-readmore a");var itemId=$contentBox.attr("id");$moreBtn.attr("data-connect-id",itemId).click(function(e){e.preventDefault();var $btn=$(this);var contentBoxId=$btn.attr("data-connect-id");var $cBox=
$("#"+contentBoxId);$cBox.toggleClass("gov-height-auto");if($btn.hasClass("c-shown"))$btn.attr("aria-expanded","false").removeClass("c-shown").text("查看更多").siblings("div.c-govResp-content").attr("aria-expanded","false");else $btn.attr("aria-expanded","true").addClass("c-shown").text("隱藏內容").siblings("div.c-govResp-content").attr("aria-expanded","true");return false});var autoHide=function(){if($contentBox[0].scrollHeight>$contentBox[0].clientHeight)$moreBtn.show();else $moreBtn.hide()};autoHide()});
$("div.c-gov-response-item").not(".c-idea-resp-container").each(function(i,panel){var $panel=$(panel),$contentBox=$panel.children("div.c-govResp-content"),$moreBtn=$panel.find("div.readmore a");$contentBox.addClass("gov-height-auto");$moreBtn.hide()});$("div.c-gov-response-item.c-idea-resp-container").each(function(i,panel){var $panel=$(panel),$contentBox=$panel.children("div.c-govResp-content"),$moreBtn=$panel.find("div.readmore a");if($contentBox.attr("data-resp-show")==="true"){$contentBox.addClass("gov-height-auto c-show");
return}$contentBox.addClass("gov-height-auto c-hide");var itemId=$contentBox.attr("id");var $verBox=$contentBox.find(".c-resp-ver");var enableVersionBox=$verBox.length>0;var clsName=".c-govResp-field-onTop",clsName1="c-govResp-field-onTop";if(enableVersionBox){$verBox.each(function(idx,box){var $box=$(box);var $onTop=$box.find(clsName);if($onTop.length==0)$box.find(".c-govResp-field").first().addClass(clsName1)});$moreBtn.attr("data-enable-verBox","true")}else{var $onTop=$contentBox.find(clsName);
if($onTop.length==0)$contentBox.find(".c-govResp-field").first().addClass(clsName1);$moreBtn.attr("data-enable-verBox","false")}$moreBtn.attr("data-connect-id",itemId).click(function(e){e.preventDefault();var $btn=$(this);var contentBoxId=$btn.attr("data-connect-id");var $cBox=$("#"+contentBoxId);$cBox.toggleClass("c-open c-hide");if($btn.hasClass("c-shown"))$btn.attr("aria-expanded","false").removeClass("c-shown").text("查看更多").attr("title","點擊查看更多回應內容").siblings("div.c-govResp-content").attr("aria-expanded",
"false");else $btn.attr("aria-expanded","true").addClass("c-shown").text("隱藏內容").attr("title","點擊隱藏回應內容").siblings("div.c-govResp-content").attr("aria-expanded","true");return false});var hideMoreBtnIfNeed=function(){var fieldCount=0;var enableFlag=$moreBtn.attr("data-enable-verBox");if(enableFlag=="true")fieldCount=$contentBox.find(".c-resp-ver.c-verBox-show .c-govResp-field").length;else fieldCount=$contentBox.find(".c-govResp-field").length;if(fieldCount>1)$moreBtn.show();else{$moreBtn.hide();
$contentBox.removeClass("c-hide").addClass("c-open")}};hideMoreBtnIfNeed();$moreBtn.data("cRespItem",{"autoHide":hideMoreBtnIfNeed})});$("div.c-gov-response-item.c-idea-resp-container").each(function(i,panel){var $panel=$(panel),$moreBtn=$panel.find("div.readmore a");$panel.find(".c-resp-version").click(function(){var $verLink=$(this),verStr=$verLink.attr("data-resp-ver"),respId=$verLink.attr("data-resp-id");var targetId="";if(verStr=="first")targetId=respId+"_contentFirst";else if(verStr=="last")targetId=
respId+"_contentLast";if(targetId=="")return;$("#"+targetId).removeClass("hide").addClass("c-verBox-show").show().siblings("div.c-resp-ver").removeClass("c-verBox-show").hide();var cRespItem=$moreBtn.data("cRespItem");if(cRespItem&&typeof cRespItem.autoHide=="function")cRespItem.autoHide()})})}window.onIssuuReadersLoaded=function(){$("div.issuuembed[data-configid]").each(function(){var configId=$(this).attr("data-configid");var viewer=window.IssuuReaders.get(configId);if(viewer==null)return;addAccessibilityIframeOnReady()})};
function _initBlockUI(style){if(!$.blockUI)return;var styleValue="s1";if(style)styleValue=style;if("s1"==styleValue)$.extend(true,$.blockUI.defaults,{"message":'\x3cdiv\x3e\x3cimg src\x3d"'+contextPath+'/images/loading.gif"/\x3e\x3c/div\x3e',"css":{"z-index":"10011","backgroundColor":"transparent","border":"none"},"overlayCSS":{"z-index":"10000","opacity":"0.8"}});else if("s2"==styleValue){var wrap='\x3ch1\x3e\x3cdiv style\x3d"margin-top:10px;margin-bottom:10px;"\x3etext\x3c/div\x3e\x3c/h1\x3e';var txt=
"請稍候...";if(_locale=="en_US")txt="Please wait";$.extend(true,$.blockUI.defaults,{"message":wrap.replace("text",txt),"css":{"z-index":"10011"},"overlayCSS":{"z-index":"10000","opacity":"0.65"}})}}
function _filterLinkStayHost(url){var href=url;if(href==null||href=="")return null;if(href.indexOf("?")!=-1){var sa=href.split("?");href=sa[0]}var pattern=/^((http|https):\/\/)/;if(pattern.test(href)==false)return href;var sb=href.split("//");if(sb.length>=1){var tt=sb[1];var scheme=sb[0];var hrefHostName=null;if(tt!=null&&tt.length>0){var sc=tt.split("/");if(sc.length>0)hrefHostName=sc[0]}if(scheme.length>0&&hrefHostName!=null&&hrefHostName.length>0)href=scheme+"//"+hrefHostName}return href}
function _linkTitleFromRemote(){var gate=false;if(gate)return;var link=$(this);var href=link.attr("href");if(href==null||href=="")return;href=_filterLinkStayHost(href);var mailtoPattern=/^mailto:/;if(mailtoPattern.test(href)){link.attr("title","電子信箱(另開新連結)");return}var pattern=/^((http|https):\/\/)/;if(pattern.test(href)==false)return;var currentHost=window.location.hostname;var regex=new RegExp("^((http|https)://"+currentHost+")");if(regex.test(href)==true)return;var useText=true;if(useText){var titleText=
link.text();if(titleText!=null&&titleText.length>0){titleText=titleText.replace("'","");titleText=titleText.replace('"',"");link.attr("title","另開新視窗前往「"+titleText+"」")}return}$.base64.utf8encode=true;$.ajax({url:contextPath+"/api/remotePageTitle",headers:{"x-join-token":$.base64.btoa(href)},data:{url:href},success:function(resp){if(!resp.success)return;var title=resp.result||"";link.attr("title","另開新視窗前往"+title);var aText=link.text();if(pattern.test(aText)==true)link.text(title)}})}
function addAccessibilityIframeOnReady(){$("iframe").each(function(index){var $iframe=$(this);var src=$iframe.attr("src");iframeToLink($iframe,src);iframeAddTitleIfNotExist($iframe)})}function addAccessibilityIframe(){$("iframe").each(function(index){var $iframe=$(this);iframeAddTitleIfNotExist($iframe)})}
function iframeToLink($iframe,src){if(src.indexOf("e.issuu.com")!=-1){var link=$("\x3ca/\x3e",{href:src,title:"另開新視窗前往"+src,target:"_blank",html:"點擊另開新視窗閱讀文件"});var targetContainer=$iframe.parents("div.issuuembed").first();if(targetContainer){link.insertBefore(targetContainer);targetContainer.remove()}else{link.insertBefore($iframe);$iframe.remove()}}else if(src.indexOf("www.slideshare.net")!=-1){var link=$("\x3ca/\x3e",{href:src,title:"另開新視窗前往"+src,target:"_blank",html:"點擊另開新視窗閱讀投影片"});link.insertBefore($iframe);
$iframe.remove()}}function iframeAddTitleIfNotExist($iframe){var title=$iframe.attr("title");if(title==null||title=="")$iframe.attr("title","其他網站之內容")}
function handleHashChanged(hashVal){if(hashVal=="#middle")_moveToAnchorTag({pattern:/middle/gi,element:"#M",notAnimate:true,success:function(){}});else if(hashVal=="#jumper")_moveToAnchorTag({pattern:/jumper/gi,element:"#M",notAnimate:true,success:function(){}});else if(hashVal=="#top")_moveToAnchorTag({pattern:/top/gi,element:"#U",notAnimate:true});else if(hashVal=="#bottom")_moveToAnchorTag({pattern:/bottom/gi,element:"#B",notAnimate:true});else if(hashVal=="#search")_moveToAnchorTag({pattern:/search/gi,
element:"#s",notAnimate:true});else if(hashVal=="#ePage")_moveToAnchorTag({pattern:/ePage/gi,element:"#E",notAnimate:true});else if(hashVal=="#endorses")_moveToAnchorTag({pattern:/endorses/gi,element:"#endorses",notAnimate:true})}
function _moveToAnchorTag(opt){var hash=location.hash.replace("#","");if(hash==null||hash=="")return;if(hash.match(opt.pattern)!=null){if(opt.same)opt.element="#"+hash;var t1=$(opt.element);if(t1.length==0)return;var $page=$(".page_new_box");var bodyPadding=_calBodyPaddingTop();if(opt.ignoreBodyPadding)bodyPadding=0;var autoHideDescp=$("#discription").height()||0;var topVal=(bodyPadding+autoHideDescp-t1.height())*-1;if(t1.attr("data-fixed"))topVal=parseInt(t1.attr("data-fixed"));if(opt.notAnimate){topVal=
bodyPadding*-1;$("html,body").scrollTop(t1.offset().top+topVal)}else{t1.css({top:topVal});$("html,body").animate({scrollTop:t1.offset().top},1E3)}if(opt.success)opt.success(t1);if(hash=="search")setTimeout(function(){$(".focusContinueV2").focus()},250)}}
function _fetchShareCount(url,callback){$.ajax({dataType:"json",url:"//graph.facebook.com/",data:{id:url,fields:"og_object{engagement}"},customCallback:callback,success:function(resp){if(!this.customCallback||typeof this.customCallback!="function")return;if(!resp.og_object||!resp.og_object.engagement)return;try{this.customCallback({"facebook":resp.og_object.engagement.count,"googleplus":0})}catch(ex){}}})}
function _hasInvalidChar(str){if(str==null||typeof str!=="string")return false;if(str==="")return false;var regex=new RegExp(/([<>"'`&]+)/g);return regex.test(str)}function _hasScriptTag(str){if(str==null||typeof str!=="string")return false;if(str==="")return false;var regex=/<[^>]*script>/g;return regex.exec(str)!=null}
function _validateValueX1(value,isRequired){if(value==null||value.length===0)return!isRequired;if(_hasScriptTag(value))return false;if(_hasInvalidChar(value))return false;return true}function _i18nMsgV1(defVal,enVal){var useLoc=window["_locale"]||"";if(useLoc==="en_US")return enVal;return defVal}function activeTopMenuItem(targetItem){if(targetItem==null||targetItem.length==0)return;$(".nav li a").removeClass("active");$("#"+targetItem).addClass("active")}
function _showUnreadCount(eltKey,count){var text="+"+count;var elts=$('[data-unreadKey\x3d"'+eltKey+'"]').attr("data-count",count).text(text).attr("title","機關有新回應議題數量："+count);if(count>0)elts.show();else elts.hide()}function _decreaseUnreadAllCount(){var elt=$('[data-unreadKey\x3d"all"]');var count=elt.attr("data-count");count=parseInt(count)-1;if(isNaN(count))return;_showUnreadCount("all",count)}
(function($){$.fn.userUnreadNotification=function(option){return this.each(function(){var url=contextPath+"/member/notification/count";$.getJSON(url,function(resp){if(!resp.success)return;var allCount=0;for(var key in resp.result){var count=resp.result[key];_showUnreadCount(key,count);allCount+=count}_showUnreadCount("all",allCount)})})};$.fn.disableTextSelection=function(){return this.attr("unselectable","on").css({"-moz-user-select":"-moz-none","-moz-user-select":"none","-o-user-select":"none",
"-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"}).on("selectstart",false)}})(jQuery);
(function($){var b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a256="",r64=[256],r256=[256],i=0;var UTF8={encode:function(strUni){var strUtf=strUni.replace(/[\u0080-\u07ff]/g,function(c){var cc=c.charCodeAt(0);return String.fromCharCode(192|cc>>6,128|cc&63)}).replace(/[\u0800-\uffff]/g,function(c){var cc=c.charCodeAt(0);return String.fromCharCode(224|cc>>12,128|cc>>6&63,128|cc&63)});return strUtf},decode:function(strUtf){var strUni=strUtf.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,
function(c){var cc=(c.charCodeAt(0)&15)<<12|(c.charCodeAt(1)&63)<<6|c.charCodeAt(2)&63;return String.fromCharCode(cc)}).replace(/[\u00c0-\u00df][\u0080-\u00bf]/g,function(c){var cc=(c.charCodeAt(0)&31)<<6|c.charCodeAt(1)&63;return String.fromCharCode(cc)});return strUni}};while(i<256){var c=String.fromCharCode(i);a256+=c;r256[i]=i;r64[i]=b64.indexOf(c);++i}function code(s,discard,alpha,beta,w1,w2){s=String(s);var buffer=0,i=0,length=s.length,result="",bitsInBuffer=0;while(i<length){var c=s.charCodeAt(i);
c=c<256?alpha[c]:-1;buffer=(buffer<<w1)+c;bitsInBuffer+=w1;while(bitsInBuffer>=w2){bitsInBuffer-=w2;var tmp=buffer>>bitsInBuffer;result+=beta.charAt(tmp);buffer^=tmp<<bitsInBuffer}++i}if(!discard&&bitsInBuffer>0)result+=beta.charAt(buffer<<w2-bitsInBuffer);return result}var Plugin=$.base64=function(dir,input,encode){return input?Plugin[dir](input,encode):dir?null:this};Plugin.btoa=Plugin.encode=function(plain,utf8encode){plain=Plugin.raw===false||Plugin.utf8encode||utf8encode?UTF8.encode(plain):plain;
plain=code(plain,false,r256,b64,8,6);return plain+"\x3d\x3d\x3d\x3d".slice(plain.length%4||4)};Plugin.atob=Plugin.decode=function(coded,utf8decode){coded=String(coded).split("\x3d");var i=coded.length;do{--i;coded[i]=code(coded[i],true,r64,a256,6,8)}while(i>0);coded=coded.join("");return Plugin.raw===false||Plugin.utf8decode||utf8decode?UTF8.decode(coded):coded}})(jQuery);var _beforeShowEditorTop=0;
function openEditorView(opt){var $container=$(opt.container).show();var currentTop="";_beforeShowEditorTop=Math.max($("body,html").scrollTop(),$("body").scrollTop());var moveTo=$container.find(".color_page").position().top;moveTo-=57/2;if(moveTo<0)top=0;$("body,html").scrollTop(moveTo)}function closeEditorView(opt){$(opt.container).hide();$("body,html").scrollTop(_beforeShowEditorTop);if(opt.complete&&typeof opt.complete=="function")opt.complete()}
function _customKoBindingLeftChar(opt){var exOpt=$.extend({charLimit:500},opt);ko.bindingHandlers.leftChar={update:function(element,valueAccessor,allBindings,viewModel){var value=valueAccessor();var valueUnwrapped=ko.unwrap(value);if(valueUnwrapped==null)valueUnwrapped="";var limit=exOpt.charLimit;var c=limit-valueUnwrapped.length;var msg="",invalidMsg="";var color="";if(c<0){msg="已超過字數限制，請重新輸入";color="red";invalidMsg="error"}else{msg="剩餘"+c.toString()+"字可輸入";color="black";invalidMsg=""}var elt=$(element).text(msg).css({"color":color});
try{elt.parent().siblings("textarea")[0].setCustomValidity(invalidMsg)}catch(ex){}}}}
function _customKoBindingPopupBox(){ko.bindingHandlers.popupBoxNavi={init:function(element,valueAccessor,allBings,viewModel,bindingContext){var option=valueAccessor();var $elt=$(element);var items=$elt.find("*[tabindex]");var first=items.first();var last=items.last();first.keydown(function(event){if(event.keyCode==9)if(event.shiftKey){event.preventDefault();last.focus()}});last.keydown(function(event){if(event.keyCode==9)if(!event.shiftKey){event.preventDefault();first.focus()}})},update:function(element,
valueAccessor,allBings,viewModel,bindingContext){}};ko.bindingHandlers.enterKeyFireClickEndorse={init:function(element,valueAccessor,allBindings,viewModel,bindingContext){$(element).keydown(function(event){if(event.keyCode==13){$(this).trigger("click");event.preventDefault()}return true})},update:function(element,valueAccessor,allBindings,viewModel,bindingContext){}}}
function _customKoBindingLoadmask(){ko.bindingHandlers.overlayLoadmask={init:function(element,valueAccessor,allBings,viewModel,bindingContext){var option=valueAccessor();var viewId=option.viewId||"simpleLoadmaskView";var loadmaskView=viewModel[viewId];if(loadmaskView==null){loadmaskView=new SimpleLoadmaskView;viewModel[viewId]=loadmaskView}var exOpt=$.extend({element:element},option);var showMe=$.proxy(function(){var $elt=$(this.element);var $parent=$elt.parent();$parent.css({"position":"relative",
"overflow":"hidden"});var fadeInOut=this.fadeInOut||false;if(fadeInOut){$elt.siblings(".rdqMsgFadeInOnloaded").hide();$parent.height(200)}(new Spinner({position:"relative",color:"#000",scale:1})).spin($elt.show()[0])},exOpt);var hideMe=$.proxy(function(){var $elt=$(this.element);var $parent=$elt.parent();$parent.css({"position":"","overflow":""});$elt.hide().find(".spinner").remove();var fadeInOut=this.fadeInOut||false;if(fadeInOut){$elt.siblings(".rdqMsgFadeInOnloaded").fadeIn("slow");$parent.css({height:""})}},
exOpt);var valueChangedHandler=function(newValue){if(newValue)showMe();else hideMe()};loadmaskView.show.subscribe(valueChangedHandler);if(loadmaskView.show())showMe()},update:function(element,valueAccessor,allBindings,viewModel,bindingContext){}};ko.bindingHandlers.simpleLoadmask={init:function(element,valueAccessor,allBings,viewModel,bindingContext){var option=valueAccessor();var viewId=option.viewId||"simpleLoadmaskView";var loadmaskView=viewModel[viewId];if(loadmaskView==null){loadmaskView=new SimpleLoadmaskView;
viewModel[viewId]=loadmaskView}var exOpt=$.extend({element:element},option);var valueChangedHandler=$.proxy(function(newValue){var $elt=$(this.element);if(newValue)(new Spinner({position:"relative",scale:this.scale||1})).spin($elt.show()[0]);else $elt.hide().find(".spinner").remove()},exOpt);loadmaskView.show.subscribe(valueChangedHandler)},update:function(element,valueAccessor,allBings,viewModel,bindingContext){}};ko.bindingHandlers.revokeReasonBox={init:function(element,valueAccessor,allBindingsAccessor,
viewModel){var $elt=$(element);var boxView=valueAccessor();$elt.on("shown.bs.modal",function(e){boxView.afterShown()}).on("hidden.bs.modal",function(e){boxView.afterHidden()});boxView.isShown.subscribe(function(newValue){if(newValue)$elt.modal("show");else $elt.modal("hide")})}}}
function _customKoBindingCommon(){ko.bindingHandlers.pageNumberPicker={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var setting=valueAccessor();var valueAcc=setting.value;var $elt=$(element);$elt.addClass("c-page-number-picker").change(function(e){var currentPage=parseInt($(this).val());valueAcc(currentPage)});_makePageNumberPicker(element);var attrPageCurrent=$elt.attr("data-c-page-current");if(attrPageCurrent!=null){var optionSize=$elt.find("option").length;if(optionSize===
0)$elt.trigger("join-page-reload",[valueAcc])}},update:function(element,valueAccessor,allBindingsAccessor,viewModel){}};ko.bindingHandlers.asSubmitButton={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var func=ko.utils.unwrapObservable(valueAccessor());$(element).keydown({viewModel:viewModel,func:func},function(event){if(event.keyCode===13){var $this=$(this);event.preventDefault();$(window).trigger("join.navi.push",[$this]);$.proxy(event.data.func,event.data.viewModel)();return false}return true})}};
ko.bindingHandlers.bfDataMgrText={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var observable=valueAccessor();observable.subscribe(function(newValue){})}};ko.bindingHandlers.cPageSizeOnChange={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var $elt=$(element);var setting=valueAccessor();$elt.change({setting:setting},function(e){var $this=$(this);var currentSize=parseInt($this.val());if(isNaN(currentSize))return;var setting=e.data.setting;var mode=setting.mode;
var page=setting.page;var totalCount=-1;var totalPagesAC=null,pageNumberAC=null;switch(mode){case "qa":pageNumberAC=page["currentPageIndexStr"];totalCount=page["totalSize"]();break;case "rdqBoard":pageNumberAC=page["number"];totalCount=page["totalCount"]();break;default:if(typeof page["totalPage"]==="function")totalPagesAC=page["totalPage"];if(typeof(page["pageNumberAC"]==="function"))pageNumberAC=page["number"];if(typeof page["totalCount"]==="function")totalCount=page["totalCount"]();break}if(totalCount===
-1)return;var newTotalPage=Math.ceil(totalCount/currentSize);if(pageNumberAC)pageNumberAC(1);if(totalPagesAC)if(totalCount===0)totalPagesAC(1);else totalPagesAC(newTotalPage);var pageNumberPickerId=setting.slt1;if(pageNumberPickerId)_firePageNumberPickerM("#"+pageNumberPickerId,{"current":pageNumberAC===null?0:pageNumberAC(),"max":newTotalPage,"currentAccessor":pageNumberAC})})}};ko.bindingHandlers.wwPageNation={init:function(element,valueAccessor,allBindingsAccessor,viewModel){},update:function(element,
valueAccessor,allBindingsAccessor,viewModel){var $elt=$(element);var ts=ko.utils.unwrapObservable(valueAccessor());var pVal=$elt.attr("data-p-ts")||"0";if(parseInt(pVal)===ts)return;$elt.attr("data-p-ts",ts);var pageInfo=viewModel["page"];if(pageInfo===null||pageInfo.totalPage()<=1){$elt.html("");return}var stepVal=2;if(!isNaN(parseInt($elt.attr("data-page-step"))))stepVal=parseInt($elt.attr("data-page-step"));$elt.html("").pagenation({step:stepVal,items:pageInfo.totalCount(),itemsPerPage:pageInfo.size(),
startPage:pageInfo.number(),onClickCallback:$.proxy(function(page){viewModel.page.number(page);viewModel.goPage()},viewModel)})}};ko.bindingHandlers.wwPageNation2={init:function(element,valueAccessor,allBindingsAccessor,viewModel){},update:function(element,valueAccessor,allBindingsAccessor,viewModel){var $elt=$(element);var ts=ko.utils.unwrapObservable(valueAccessor());var pVal=$elt.attr("data-p-ts")||"0";if(parseInt(pVal)===ts)return;$elt.attr("data-p-ts",ts);var pageInfo=viewModel["page"];if(pageInfo===
null||pageInfo.maxPageIndex()<=1){$elt.html("");return}$elt.html("").pagenation({step:2,items:pageInfo.totalSize(),itemsPerPage:pageInfo.pageSize(),startPage:pageInfo.currentPageIndex(),onClickCallback:$.proxy(function(page){viewModel.page.currentPageIndex(page);viewModel.goPage()},viewModel)})}};ko.bindingHandlers.wwPageNation3={init:function(element,valueAccessor,allBindingsAccessor,viewModel){},update:function(element,valueAccessor,allBindingsAccessor,viewModel){var $elt=$(element);var setting=
ko.utils.unwrapObservable(valueAccessor());var ts=setting.timestamp();var useViewModel=setting.vm;var pVal=$elt.attr("data-p-ts")||"0";if(parseInt(pVal)===ts)return;$elt.attr("data-p-ts",ts);var pageInfo=useViewModel["page"];if(pageInfo===null||pageInfo.totalPage()<=1){$elt.html("");return}$elt.html("").pagenation({step:2,items:pageInfo.totalCount(),itemsPerPage:pageInfo.size(),startPage:pageInfo.number(),onClickCallback:$.proxy(function(page){viewModel.page.number(page);viewModel.goPage()},viewModel)})}};
ko.bindingHandlers.majorCategorySelect2={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var $elt=$(element);var settings=ko.utils.unwrapObservable(valueAccessor());var vm=settings.view;$elt.select2({placeholder:settings.placeholder,allowClear:true,width:"100%",selectionCssClass:"c-major-cate-select2",dropdownCssClass:"c-major-cate-dropdown"}).on("select2:open",function(){var $c1=$(".c-major-cate-dropdown").parent();$c1.css("z-index",999999999)}).on("select2:close",function(){var $c1=
$(".c-major-cate-dropdown").parent();$c1.css("z-index",1)}).on("change",{viewModel:vm,boxId:settings.boxId},function(e){var viewModel=e.data.viewModel;var $this=$(this);var currentValue=$this.val();var needToMove=false;if(currentValue==null){viewModel.doChange([]);needToMove=false}else{var selectedValue=[];selectedValue=selectedValue.concat(currentValue);viewModel.doChange(selectedValue);needToMove=true}var boxId=e.data.boxId;if(needToMove&&boxId){var $box=$(boxId),$bodyCont=$box.find("div.modal-body");
var $lastStep=$box.find("li.step").last();var sp=$bodyCont.scrollTop();var moveTo=$lastStep.position().top-$bodyCont.position().top;if(moveTo>sp)$bodyCont.scrollTop(moveTo)}}).on("select2:unselect",function(e){});vm.notifySelect2.subscribe(function(newValue){var val=$elt.val();var mapperCode=vm.buildSelectedMajorMapperCode();$elt.val(mapperCode).trigger("change.select2")});$elt.siblings(".select2-container").find("textarea.select2-search__field").attr("title",settings.placeholder)},update:function(element,
valueAccessor,allBindingsAccessor,viewModel){}};ko.bindingHandlers.eyeMaskValue={init:function(element,valueAccessor){var $elt=$(element);var settings=ko.utils.unwrapObservable(valueAccessor());var $eltShadow=$("#"+$elt.attr("id")+"Shadow");var eyeView=settings.eyeView;var enable=eyeView.options.enable;if(enable===false)return;eyeView.show.subscribe(function(newValue){if(newValue)$eltShadow.addClass("hide");$elt.attr("data-show-value",newValue?"true":"false")});$eltShadow.on("focus",function(e){$elt.removeClass("hide").focus();
$(this).addClass("hide")});$elt.blur(function(e){var $this=$(this);var isShow=$this.attr("data-show-value")==="true";if(isShow)return;$eltShadow.removeClass("hide");$this.addClass("hide")}).on("input",function(e){var $this=$(this);settings.value($this.val());var isComposition=$this.attr("data-composition")==="true";if(isComposition)return;var val=$this.val();eyeView.value(val.replace(/./g,"*"))}).on("compositionstart",function(e){$(this).attr("data-composition","true")}).on("compositionend",function(e){var $this=
$(this);$(this).attr("data-composition","false");var val=$this.val();if(val.length===0)return;eyeView.value(val.replace(/./g,"*"))})},update:function(element,valueAccessor){}}}
function _customKoBindingSelectPicker(){ko.bindingHandlers.select2Picker={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var $elt=$(element);var settings=ko.utils.unwrapObservable(valueAccessor());var vm=settings.view;var valueFName=settings.value||"selectedValues";var sWidth=settings.width||"100%";$elt.select2({placeholder:settings.placeholder,allowClear:true,width:sWidth,language:{noResults:function(){return"沒有找到相符的項目"}}}).on("change",{viewModel:vm,valueFName:valueFName},function(e){var viewModel=
e.data.viewModel;var vf=e.data.valueFName;var currentValue=$(this).val();if(currentValue==null)viewModel[vf]([]);else{var selectedValue=[];selectedValue=selectedValue.concat(currentValue);viewModel[vf](selectedValue)}}).on("select2:unselect",function(e){});if(settings.disableSearch);vm[valueFName].subscribe(function(newValue){var val=$elt.val();if(val==null)$elt.val(newValue).trigger("change.select2")});$elt.siblings(".select2-container").find("textarea.select2-search__field").attr("title",settings.placeholder)},
update:function(element,valueAccessor,allBindingsAccessor,viewModel){}};ko.bindingHandlers.outlookCategorySelect2={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var $elt=$(element);var settings=ko.utils.unwrapObservable(valueAccessor());var vm=settings.view;$elt.select2({placeholder:settings.placeholder,allowClear:true,width:"100%",language:{noResults:function(){return"沒有找到相符的項目"}}}).on("change",{viewModel:vm},function(e){var viewModel=e.data.viewModel;var currentValue=$(this).val();
if(currentValue==null)viewModel.doChange([]);else{var selectedValue=[];selectedValue=selectedValue.concat(currentValue);viewModel.doChange(selectedValue)}}).on("select2:unselect",function(e){});vm.notifySelect2.subscribe(function(newValue){var val=$elt.val();var mapperCode=vm.buildSelectedMajorMapperCode();if(val==null)$elt.val(mapperCode).trigger("change.select2")})},update:function(element,valueAccessor,allBindingsAccessor,viewModel){}};ko.bindingHandlers.c1SortBtn={init:function(element,valueAccessor,
allBindingsAccessor,viewModel){var $elt=$(element);var settings=ko.utils.unwrapObservable(valueAccessor());var makeTitleFunc=function(){var m={"v2ByDate":{"text":"最新","desc":"依新到舊排序","asc":"依舊到新排序","none":""},"v2ByMessageCount":{"text":"討論數","desc":"依多到少排序","asc":"依少到多排序","none":""},"v2ByEndorseCount":{"text":"附議數","desc":"依多到少排序","asc":"依少到多排序","none":""}};var useData=m[$elt.attr("data-sort-value")];var curSDV=$elt.attr("data-sort-dir")||"none";var nextSDV="none";if(curSDV==="desc")nextSDV="asc";
else if(curSDV==="asc"||curSDV==="none")nextSDV="desc";var showTitle="點擊以"+useData.text+"進行"+useData[nextSDV];$elt.attr("title",showTitle).attr("aria-label",showTitle)};makeTitleFunc();var sortObs=settings.sort;var dirObs=settings.dir;dirObs.subscribe(function(dirValue){if(sortObs()!==$elt.attr("data-sort-value")){$elt.removeClass("file-filter-arrow desc acs").attr("data-sort-dir","none");makeTitleFunc();return}$elt.attr("data-sort-dir",dirValue);if(dirValue==="none")$elt.removeClass("file-filter-arrow desc acs");
else if(dirValue==="desc")$elt.addClass("file-filter-arrow desc").removeClass("acs");else if(dirValue==="asc")$elt.addClass("file-filter-arrow acs").removeClass("desc");makeTitleFunc()})},update:function(element,valueAccessor,allBindingsAccessor,viewModel){}}}
function _customKoBindingSearchItem(){ko.bindingHandlers.topicChildrenAccordion={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var $elt=$(element);var setting=ko.utils.unwrapObservable(valueAccessor());var vm=setting.view;$elt.attr("aria-controls",vm.accordionId()).attr("data-target","#"+vm.accordionId()).click(function(event){event.preventDefault();var $this=$(this);var targetId=$this.attr("data-target");$(targetId).collapse("toggle");return false}).keydown(function(event){if(event.keyCode===
13){event.preventDefault();$(this).trigger("click");return false}return true})},update:function(element,valueAccessor,allBindingsAccessor,viewModel){}};ko.bindingHandlers.cSearchTab={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var $elt=$(element);var setting=ko.utils.unwrapObservable(valueAccessor());var layerNumber=setting.layer;var tabId=setting.tabId;var tab=viewModel.findTab(layerNumber,tabId);var tagName=$elt.prop("tagName");if(tagName==="A"){$elt.click({currentViewModel:viewModel,
tab:tab},function(e){e.preventDefault();e.data.currentViewModel.doActiveTab(e.data.tab);return false}).keydown(function(e){if(e.keyCode===13){var $link=$(this);$(window).trigger("join.navi.push",[$link]);$link.trigger("click");return false}return true});if(tab.isActive())$elt.addClass("active");ko.applyBindingsToNode($elt[0],{"css":{"active":tab.isActive}})}else if(tagName==="BUTTON"){$elt.click({currentViewModel:viewModel,tab:tab},function(e){e.preventDefault();e.data.currentViewModel.doActiveTab(e.data.tab);
return false}).keydown(function(e){if(e.keyCode===13){var $link=$(this);$(window).trigger("join.navi.push",[$link]);$link.trigger("click");return false}return true});if(tab.isActive())$elt.addClass("active");ko.applyBindingsToNode($elt[0],{"css":{"active":tab.isActive},"text":tab.showText})}else if(tagName==="LABEL"){var forElt=$elt.attr("for");var $forElt=$("#"+forElt);var inputTagName=$forElt.prop("tagName"),inputType=$forElt.attr("type");if(inputTagName==="INPUT"&&inputType.toUpperCase()==="RADIO"){$elt.click({currentViewModel:viewModel,
tab:tab},function(e){e.data.currentViewModel.doActiveTab(e.data.tab);return true}).keydown(function(e){if(e.keyCode===13){var $link=$(this);$(window).trigger("join.navi.push",[$link]);$link.trigger("click");return false}return true});ko.applyBindingsToNode($forElt[0],{"checked":tab.isActive});ko.applyBindingsToNode($elt[0],{"text":tab.showText});if(tab.isActive())$forElt.prop("checked",true)}}}};ko.bindingHandlers.naviTabBar={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var $elt=
$(element);$elt.addClass("scroll_tabs_theme_light main-tabs").scrollTabs();$elt.find(".scroll_tab_inner").css({"overflow-x":"auto","height":"60px"});$elt.css({"overflow-y":"hidden"});$elt.find("a.nav-link").click(function(e){e.preventDefault();$(this).tab("show");return false}).on("show.bs.tab",function(event){var $this=$(this),$parent=$this.parent();$parent.siblings("li.nav-item").find("a.nav-link").removeClass("active");var moduleValue=$this.attr("data-module");viewModel.doChangeSearchView(moduleValue);
$(window).trigger("join.bfCache.save",[{id:$elt.attr("id")||"myNaviTabBar",data:moduleValue}])}).keydown(function(e){if(e.keyCode===13){var $this=$(this);$(window).trigger("join.navi.push",[$this]);if($this.hasClass("active"))$(window).trigger("join.navi.focus");return true}})},update:function(element,valueAccessor,allBindingsAccessor,viewModel){}};ko.bindingHandlers.naviTabBar2={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var $elt=$(element);$elt.addClass("scroll_tabs_theme_light main-tabs").scrollTabs();
$elt.find(".scroll_tab_inner").css({"overflow-x":"auto","height":"60px"});$elt.css({"overflow-y":"hidden"});$elt.find("a.nav-link").click(function(e){e.preventDefault();$(this).tab("show");return false})},update:function(element,valueAccessor,allBindingsAccessor,viewModel){}};ko.bindingHandlers.statusBarScrollTab={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var $elt=$(element);var statusTabs=ko.utils.unwrapObservable(valueAccessor());$.each(statusTabs,function(i,tab){$("\x3cli/\x3e").append($("\x3ca/\x3e",
{"href":"#","class":"btn c-statusTab","data-c-navi-level":"param","data-c-navi-next":"data","data-bind":"text: showText, css:{'active': isActive}, statusBarItem: true"})).appendTo($elt)});if(statusTabs.length<=1)$elt.hide().removeClass("scroll_tabs_theme_light");else{$elt.scrollTabs();$elt.find(".scroll_tab_inner").css({"overflow-x":"auto","height":"60px"});$elt.css({"overflow-y":"hidden"})}$elt.find("a.btn").each(function(index,aElt){var data=statusTabs[index];ko.applyBindings(data,aElt)});return{controlsDescendantBindings:true}},
update:function(element,valueAccessor,allBindingsAccessor,viewModel){}};ko.bindingHandlers.statusBarNaviTab={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var $elt=$(element);var statusTabs=ko.utils.unwrapObservable(valueAccessor());$.each(statusTabs,function(i,tab){$("\x3cli/\x3e").append($("\x3ca/\x3e",{"href":"#","class":"btn c-statusTab","data-c-navi-level":"param","data-c-navi-next":"data","data-bind":"text: showText, css:{'active': isActive}, statusBarItem: true"})).appendTo($elt)});
$elt.find("a.btn").each(function(index,aElt){var data=statusTabs[index];ko.applyBindings(data,aElt)});return{controlsDescendantBindings:true}},update:function(element,valueAccessor,allBindingsAccessor,viewModel){}};ko.bindingHandlers.statusBarItem={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var $elt=$(element);$elt.click({viewModel:viewModel},function(event){event.preventDefault();var vm=event.data.viewModel;vm.clickToActive();return false}).keydown(function(event){if(event.keyCode===
13){var $this=$(this);event.preventDefault();$(window).trigger("join.navi.push",[$this]);$this.trigger("click");return false}})},update:function(element,valueAccessor,allBindingsAccessor,viewModel){}}}function SimpleLoadmaskView(){this.show=ko.observable(false)}function _findRecaptchaVal(form){var $form=$(form);var recaptchaRespVal="";$.each($form.serializeArray(),function(i,pair){if(pair.name=="g-recaptcha-response")recaptchaRespVal=pair.value});return recaptchaRespVal}
Number.prototype.formatMoney=function(c,d,t){var n=this,c=isNaN(c=Math.abs(c))?2:c,d=d==undefined?".":d,t=t==undefined?",":t,s=n<0?"-":"",i=String(parseInt(n=Math.abs(Number(n)||0).toFixed(c))),j=(j=i.length)>3?j%3:0;return s+(j?i.substr(0,j)+t:"")+i.substr(j).replace(/(\d{3})(?=\d)/g,"$1"+t)+(c?d+Math.abs(n-i).toFixed(c).slice(2):"")};
function _customKoBindingSocialBtn(){ko.bindingHandlers.fbButton={init:function(element,valueAccessor,allBindings,viewModel,binding){var $elt=$(element);$elt.click(function(e){e.preventDefault();e.stopPropagation();var shareUrl=$(this).attr("data-shareUrl");if(shareUrl)window.open(shareUrl);return false})}};ko.bindingHandlers.lineButton2={init:function(element,valueAccessor,allBindings,viewModel,binding){try{if(window["LineIt"])LineIt.loadButton()}catch(ex){}var $elt=$(element);$elt.click(function(e){e.preventDefault();
e.stopPropagation();var shareUrl=$(this).attr("data-shareUrl");if(window["LineIt"]&&shareUrl){var targetUrl="https://social-plugins.line.me/lineit/share";var qs=$.param({url:shareUrl});window.open(targetUrl+"?"+qs)}return false})}}}
function _customKoBindingLineButton(){ko.bindingHandlers.lineButton={init:function(element,valueAccessor,allBindings,viewModel,binding){},update:function(element,valueAccessor,allBindings,viewModel,binding){var value=valueAccessor();var $elt=$(element);$elt.parent().siblings("button").on("click",function(){addLine()});var addLine=function(){$elt.empty();var div=$("\x3cdiv/\x3e",{"data-lang":"zh_Hant","data-type":"share-c","data-size":"small","data-url":value}).addClass("line-it-button");$elt.append(div);
var isLoad=false;changeLineTimer=setInterval(function(){if(window.LineIt!=undefined){if(isLoad==false){window.LineIt.loadButton();isLoad=true}var $iframe=$elt.find("iframe");if($iframe.hasClass("lineButtonSize")==false){$iframe.addClass("lineButtonSize");clearInterval(changeLineTimer)}}},100)}}}}var _scanWinCloseTimer;var _easyLoginWindow;function goLogin(){_createScanWindowCloseTimer({name:"mywindow",url:contextPath+"/login/easy"})}
function _resetScanWindowCloseTimer(){if(_scanWinCloseTimer!=null){clearInterval(_scanWinCloseTimer);_scanWinCloseTimer=null}if(_easyLoginWindow!=null&&!_easyLoginWindow.closed){_easyLoginWindow.close();_easyLoginWindow=null}}function _reloadAfterClosePopup(toUrl){if(window.location.pathname==="/logout"){window.location.href=contextPath+"/index";return}if(toUrl!=null&&toUrl.length>0){window.location.assign(toUrl);return}window.location.reload()}
function _reloadAfterClosePopupIfNeed(childWin){if(_scanWinCloseTimer!=null&&_easyLoginWindow==childWin){_reloadAfterClosePopup();return true}return false}function _toReverificationIfNeed(childWin,opt){if(_scanWinCloseTimer==null)return false;if(_easyLoginWindow!=childWin)return false;_resetScanWindowCloseTimer();var toUrl="";if(opt.toUrl)toUrl=contextPath+opt.toUrl;if(toUrl==null||toUrl.length==0)return false;_reloadAfterClosePopup(toUrl);return true}
function _createScanWindowCloseTimer(openOptions){_resetScanWindowCloseTimer();_easyLoginWindow=_openWindowPopup(openOptions);_scanWinCloseTimer=setInterval(function(){if(_easyLoginWindow!=null&&!_easyLoginWindow.closed)return;clearInterval(_scanWinCloseTimer);_easyLoginWindow=null;_scanWinCloseTimer=null;_reloadAfterClosePopup()},250)}
function _openWindowPopup(options){var opt=$.extend({name:"",url:"",width:920,height:387},options);var left=(screen.width-opt.width)/2;var top=(screen.height-opt.height)/4;var fea="width\x3d"+opt.width+",height\x3d"+opt.height+",top\x3d"+top+",left\x3d"+left+",toolbar\x3dno,menubar\x3dno,resizable\x3dno,location\x3dno,scrollbars\x3dyes";return window.open(opt.url,opt.name,fea)}
var _majorOutlookCateMap={1:{"name":"外交國防法務","class1":"cate-nationalDefense"},2:{"name":"內政","class1":"cate-internalAffairs"},3:{"name":"綜合行政","class1":"cate-administration"},4:{"name":"財政經濟","class1":"cate-economic"},5:{"name":"農業環保","class1":"cate-agriculture"},6:{"name":"交通建設","class1":"cate-traffic"},7:{"name":"教育科技文化","class1":"cate-education"},8:{"name":"衛生勞動","class1":"cate-health"},"ly_1":{"name":"內政","class1":"cate-internalAffairs"},"ly_2":{"name":"外交及國防","class1":"cate-nationalDefense"},
"ly_3":{"name":"經濟","class1":"cate-economic"},"ly_4":{"name":"財政","class1":"cate-economic"},"ly_5":{"name":"教育及文化","class1":"cate-education"},"ly_6":{"name":"交通","class1":"cate-traffic"},"ly_7":{"name":"司法及法制","class1":"cate-basic"},"ly_8":{"name":"社會福利及衛生環境","class1":"cate-agriculture"}};var _actMajorOutlookCateMap={1:{"name":"公共建設","class1":"cate-publicUp"},2:{"name":"社會發展","class1":"cate-socialUp"},3:{"name":"科技發展","class1":"cate-technologyUp"}};
function MajorOutlookCategoryModel(data){var self=this;ko.mapping.fromJS(data,{"ideaMinor":{create:function(item){return new MinorOutlookCategoryModel("idea",item)}},"policyMinor":{create:function(item){return new MinorOutlookCategoryModel("policy",item)}},"actMinor":{create:function(item){return new MinorOutlookCategoryModel("act",item)}}},this);this.isMajor=true;this.selected=ko.observable(false);this.selected.subscribe(function(newValue){});this.toggleSelected=function(event){this.selected(!this.selected())};
this.clear=function(){self.selected(false);ko.utils.arrayForEach(this.ideaMinor(),function(minorItem){minorItem.clear()});ko.utils.arrayForEach(this.policyMinor(),function(minorItem){minorItem.clear()});ko.utils.arrayForEach(this.actMinor(),function(minorItem){minorItem.clear()})};this.displayMinorCategory=function(){var a=[];ko.utils.arrayForEach(this.ideaMinor(),function(minorItem){a.push(minorItem)});return a};this.selectedMinor=function(){var a=[];$.each(this.displayMinorCategory(),function(index,
item){if(item.selected())a.push(item.data.uid())});return a};this.selectedIfNeed=function(){var anySelected=false;$.each(self.ideaMinor(),function(i,minor){if(minor.selected())anySelected|=true});$.each(self.policyMinor(),function(i,minor){if(minor.selected())anySelected|=true});$.each(self.actMinor(),function(i,minor){if(minor.selected())anySelected|=true});self.selected(anySelected)};this.findSelectedMinorAll=function(){var r=[];var a1=this.findSelectedMinor("ideaMinor");var a2=this.findSelectedMinor("policyMinor");
var a3=this.findSelectedMinor("actMinor");if(a1.length>0)r=r.concat(a1);if(a2.length>0)r=r.concat(a2);if(a3.length>0)r=r.concat(a3);return r};this.findSelectedIdeaMinor=function(){return this.findSelectedMinor("ideaMinor")};this.findSelectedMinor=function(minorType){var a=[];$.each(self[minorType](),function(index,minor){if(minor.selected())a.push(minor)});return a};this.loadMinor=function(minorList){if(minorList==null)return;$.each(self.ideaMinor(),function(i,minor){var uid=minor.data.uid();var isSelected=
minorList.indexOf(uid)!=-1;minor.selected(isSelected)})}}function MinorOutlookCategoryModel(type,data){ko.mapping.fromJS(data,{},this);this.minorType=type;this.isMajor=false;this.selected=ko.observable(false);this.clear=function(){this.selected(false)};this.checkboxId=ko.pureComputed(function(){return"chb_"+this.data.uid()},this)}function JoinModuleItemModel(id,name){this.id=id;this.name=name;this.selected=ko.observable(false)}
function BottomAdvisePanelView(){var self=this;this.isOpened=ko.observable(false);this.isOpenedStr=ko.pureComputed(function(){if(this.isOpened())return"點擊收合填寫服務表單";else return"點擊展開填寫服務表單"},this);this.ariaExpandedStr=ko.pureComputed(function(){if(this.isOpened())return"true";else return"false"},this);this.toggleShow=function(){$("#bottomAdvisePanelAccordionHeader a").trigger("click");if(this.isOpened())this.close();else this.open()};this.open=function(){if(this.isOpened())return;this.isOpened(true);
this.onOpen()};this.onOpen=function(){this.vCodeView.isReady(true);this.refreshVCodeImg()};this.close=function(){if(!this.isOpened())return;this.isOpened(false);this.onClose()};this.onClose=function(){this.vCodeView.isReady(false);this.vCodeImgSrc("")};this.vCodeView=new VCodeViewModel({type:"f2",vCodeKey:$("#bottomAdvisePanel").attr("data-vCodeKey")});this.isShowVCode=ko.pureComputed(function(){return this.vCodeView.isReady()},this);this.vCodeImgSrc=ko.observable("");this.refreshVCodeImg=function(){self.vCodeImgSrc(self.vCodeView.remakeImgSrc())};
this.playVCodeAudio=function(){self.vCodeView.playAudio()};this.clearVCode=function(){$("#vCodeInputAtBottom").val("");this.refreshVCodeImg()};this.onKeyDownVCode=function(vm,e){if(e.keyCode===13){e.preventDefault();e.stopPropagation();return false}return true};this.doSend=function(form){var $form=$(form);if(!$form.valid())return false;var data=$form.form2json();data.fromPageUrl=window.location.href;data.vCodeAnswer=self.vCodeView.buildAnswer(data.vCode);data.vCode=null;console.log("check data",data);
$.ajax({type:"POST",url:contextPath+"/contactus/api",data:JSON.stringify(data),contentType:"application/json",viewModel:self,formElt:$form,success:function(resp){if(resp!=="ok"){var msgMap={"-3":"圖形驗證碼錯誤"};alert(msgMap[resp]||"發生錯誤");if(resp==="-3")this.viewModel.clearVCode();return}alert("傳送完成");this.formElt[0].reset();this.viewModel.toggleShow();this.viewModel.vCodeImgSrc("")},error:function(){alert("發生錯誤")}})}}
function FooterNavBar(options){var self=this;var opts=$.extend({"propose":false,"endorse":false,"policy":false,"act":false,"budget":false,"pdis":false,"cy":false,"localGov":false,"govContact":false,"historySearch":false,"toEyWeb":false,"currentEntranceType":""},options);this.iconInfoMap={"propose":{"name":"想提議","className":"btn suggestion-btn","url":contextPath+"/idea/propose/search"},"endorse":{"name":"來附議","className":"btn approve-btn","url":contextPath+"/idea/index"},"policy":{"name":"眾開講","className":"btn message-btn",
"url":contextPath+"/policies/index"},"act":{"name":"來監督","className":"btn inspect-btn","url":contextPath+"/acts/index"},"budget":{"name":"參與式預算","className":"btn budget-btn","url":contextPath+"/pb/index"},"pdis":{"name":"協作會議","className":"btn metting-btn","url":contextPath+"/pdis/index"},"cy":{"name":"參與審計","className":"btn join-audit-btn","url":$("[data-to-cy-url]").first().attr("data-to-cy-url")},"localGov":{"name":"縣市專區","className":"btn city-area-btn","url":contextPath+"/entranceLocal"},"govContact":{"name":"找首長",
"className":"btn mayors-btn","url":contextPath+"/govcontact/index"},"historySearch":{"name":"歷史資料","className":"btn history-btn","url":contextPath+"/history/search"},"toEyWeb":{"name":"回行政院","className":"btn backhome-btn","url":"//"+window["_eyServerName"]}};this.items=ko.observableArray([]);this.itemCountPerRow=4;this.noneItem=function(){return{"type":"none","name":"\x26nbsp;","className":"btn none-btn"}};this.firstRowItems=ko.pureComputed(function(){var a=[];var index=0;var gate=this.itemCountPerRow;
while(index<gate){if(this.items().length>index)a.push(this.items()[index]);else a.push(this.noneItem());index++}return a},this);this.secondRowItems=ko.pureComputed(function(){var a=[];var index=0;var gate=this.itemCountPerRow;while(index<gate){var itemIndex=index+gate;if(this.items().length>itemIndex)a.push(this.items()[itemIndex]);else a.push(this.noneItem());index++}return a},this);this.isOpened=ko.observable(false);this.isOpenedStr=ko.pureComputed(function(){if(this.isOpened())return"true";else return"false"},
this);this.moreButtonTitle=ko.pureComputed(function(){if(this.isOpened())return"點擊收合更多功能項目";else return"點擊展開更多功能項目"},this);this.isShowMoreButton=ko.pureComputed(function(){return this.items().length>this.itemCountPerRow},this);this.open=function(){if(this.isOpened())return;this.isOpened(true);$(".float-box").addClass("boxheight");$(".fixed-btn-m").addClass("toolheight");$(".heafer-collapse-open").css("transform","rotate(180deg)");$("#more-btn").slideToggle("slow")};this.close=function(){if(!this.isOpened())return;
this.isOpened(false);$(".float-box").removeClass("boxheight");$(".fixed-btn-m").removeClass("toolheight");$(".heafer-collapse-open").css("transform","rotate(360deg)");$("#more-btn").slideToggle("slow")};this.clickMore=function(){if(this.isOpened())this.close();else this.open()};this.init=function(){if(opts.currentEntranceType==="ey")this.initForEy();else this.initForNotEy()};this.initForEy=function(){for(var k in self.iconInfoMap){if(!opts[k])continue;this.items.push($.extend(self.iconInfoMap[k],
{"type":"item"}))}var $firstRow=$("#bottomNavBar1");$.each(this.firstRowItems(),function(index,item){var $target=$firstRow.find(".mobile-btn-box");if(item.type==="item")$("\x3ca/\x3e",{"href":item.url,"class":item.className,"text":item.name,"title":item.name,"role":"button"}).insertBefore($target);else if(item.type==="none")$("\x3ca/\x3e",{"class":item.className,"text":""}).insertBefore($target)});var $secondRow=$("#bottomNavBar2");$.each(this.secondRowItems(),function(index,item){var $target=$secondRow.find(".mobile-btn-box");
if(item.type==="item")$("\x3ca/\x3e",{"href":item.url,"class":item.className,"text":item.name,"title":item.name,"role":"button"}).insertBefore($target);else if(item.type==="none")$("\x3ca/\x3e",{"class":item.className,"text":""}).insertBefore($target)})};this.initForNotEy=function(){$("#more-btn,#bottomNavBar1").find("a.btn").each(function(idx,item){var $item=$(item);var linkName=$item.attr("data-link-name");var info=self.iconInfoMap[linkName];if(info==null)return;$item.attr("href",info.url);self.items.push($.extend(info,
{"type":"item"}))})};this.init()}function BottomSideBarView(){this.isOpenedShareBox=ko.observable(false);this.toggleShareBox=function(){var val=this.isOpenedShareBox();this.isOpenedShareBox(!val)}}
function TopicItemView(module,data){var self=this;this.module=ko.observable(module);this.isEmptyModule=ko.pureComputed(function(){return this.module()==="empty"},this);this.isLoadDataDone=ko.observable(false);this.uid=ko.observable(null);this.title=ko.observable(null);this.majorCategoryList=ko.observableArray([]);this.useCategoryIconMap="_majorOutlookCateMap";this.useSectionMode=false;this.sectionList=ko.observableArray([]);this.attentionCount=ko.observable(0);this.messageCount=ko.observable(0);var dateFormat=
"YYYY-MM-DD";this.displayDateText=ko.observable("");var rocDateFormat="MM-DD";this.displayRocDateText=ko.observable("");this.isOverOfflineDate=ko.observable(false);this.masterOrgName=ko.observable("");this.subOrgName=ko.observableArray([]);this.entranceType=ko.observable(null);this.children=ko.observableArray([]);this.status=ko.observable();this.displayStatusText=ko.observable();this.meta={};this.odata=data;this.visibleControl;this.loadData=function(module,data){this.majorCategoryList(data.majorOutlookCategoryList);
this.sectionList(data.sectionList);this.masterOrgName(data.masterOrganizationName);this.subOrgName(data.subOrganizationName);this.entranceType(data.entranceType);this.visibleControl=new IdeaMetaVisibleControlView(self);if(module==="idea"){this.uid(data.id);this.title(data.title);this.attentionCount(data.attentionCount);this.messageCount(data.debateMessageCount);var displayDate=moment(data.approvedTime);if(displayDate.isValid()){this.displayDateText(displayDate.format(dateFormat));this.displayRocDateText(displayDate.year()-
1911+"-"+displayDate.format(rocDateFormat))}this.meta.endorseCount=ko.observable(data.endorseCount);this.status(data.status);this.meta.daysLeft=ko.observable("");if(data.daysLeft!=null&&data.daysLeft>0)if(this.entranceType()==="ly"){var hourVal=data.hoursLeft;if(hourVal>0&&hourVal<24)this.meta.daysLeft("倒數"+hourVal+"小時");else this.meta.daysLeft("倒數"+data.daysLeft+"天")}else this.meta.daysLeft("倒數"+data.daysLeft+"天");if(data.status==="Advice"||data.status==="Completed")this.displayStatusText("已成案");
else if(data.status==="FirstFailed"||data.status==="SecondFailed")this.displayStatusText("未成案");else if(data.status==="Rejected"||data.status==="Revoked")this.displayStatusText("未進入附議");var visibleDataCounter=true;if(data.status==="Rejected")visibleDataCounter=false;this.meta.visibleDataCounter=ko.observable(visibleDataCounter);this.meta.commentCount=ko.observable(data.commentCount);this.meta.publishDateText=ko.observable("");var publishDate=moment(data.publishDate);if(publishDate.isValid())this.meta.publishDateText(publishDate.format(dateFormat))}else if(module===
"policy"){this.uid(data.policyUid);this.title(data.policyTitle);this.status(data.policyStatus);this.finished=ko.observable(data.finished===true);this.attentionCount(data.totalAttentionCount);var displayDate=moment(data.publishDate);if(displayDate.isValid()){this.displayDateText(displayDate.format(dateFormat));this.displayRocDateText(displayDate.year()-1911+"-"+displayDate.format(rocDateFormat))}if(data.offlineDate&&(new Date).getTime()>data.offlineDate)this.isOverOfflineDate(true);this.messageCount(data.totalCommentCount);
this.meta.voteCount=ko.observable(data.totalVoteCount||data.sumVoteOptionCount);if(data.publishPolicyChildren)$.each(data.publishPolicyChildren,function(index,child){self.children.push(new TopicItemView(self.module(),child))});else if(data.children)$.each(data.children,function(index,child){self.children.push(new TopicItemView(self.module(),child))});if(this.isOverOfflineDate())this.displayStatusText("已結束");else this.displayStatusText("進行中");this.meta.policyFeatureVersion=ko.observable(data.policyFeatureVersion);
this.meta.voteFlag=ko.observable(data.voteFlag);var hasCustomVoteFea=data.policyFeatureVersion!=="Policy_2015";var voteOptions=[];if(hasCustomVoteFea){if(data.availableVoteOptions!=null&&$.isArray(data.availableVoteOptions))$.each(data.availableVoteOptions,function(idx,item){var viewItem=new PolicyVoteView(item,idx);viewItem.policyData=data;voteOptions.push(viewItem)})}else{var view1=new PolicyVoteView({"name":"贊成","voteCount":data.agreeCount||0},0);view1.policyData=data;voteOptions.push(view1);var view2=
new PolicyVoteView({"name":"反對","voteCount":data.disagreeCount||0},1);view2.policyData=data;voteOptions.push(view2)}this.meta.availableVoteOptions=ko.observableArray(voteOptions)}else if(module==="act"){this.uid(data.actUid);this.title(data.actTitle);this.status(data.actStatus);this.attentionCount(data.attentionCount);var displayDate=moment(data.publishDate);if(displayDate.isValid()){this.displayDateText(displayDate.format(dateFormat));this.displayRocDateText(displayDate.year()-1911+"-"+displayDate.format(rocDateFormat))}this.messageCount(data.totalCommentCount);
this.meta.workDurationDays=ko.observable(data.workDurationDays);if(data.actProcessStatus==="完成了")this.displayStatusText("完成了");else this.displayStatusText("進行中");if(data.isGpivp&&data.gpivp!=null){if(!_.isNil(data.gpivpYearROC))this.title(data.actTitle+"("+data.gpivpYearROC+"年度辦理情形)");this.meta.gpivpCateName=ko.observable(data.gpivp.category);var gpivpClsName="absolute-center ";var hasAnyMatch=false;for(var k in _actMajorOutlookCateMap){var actCateItem=_actMajorOutlookCateMap[k];if(actCateItem.name===
data.gpivp.category){gpivpClsName+=actCateItem.class1;hasAnyMatch=true}}if(!hasAnyMatch)gpivpClsName+=" cate-basic";this.meta.gpivpClassName=ko.observable(gpivpClsName)}else{this.meta.gpivpCateName=ko.observable("計畫");this.meta.gpivpClassName=ko.observable("absolute-center cate-basic")}}else if(module==="pdis"){this.uid(data.uid);this.dataType=ko.observable(data.dataType);this.title(data.title);this.ideaTitle=ko.observable(data.ideaTitle);this.displayTitle=ko.pureComputed(function(){if(this.dataType()===
"Idea")return this.ideaTitle();else return this.title()},this);this.startTime=ko.observable(data.startTime);var startTimeVal=moment(data.startTime);this.oldCase=ko.observable(data.oldCase);this.oldCaseUrl=ko.observable(data.oldCaseUrl);this.isOldCase=ko.pureComputed(function(){return this.oldCase()==="Y"},this);if(startTimeVal.isValid())this.displayDateText(startTimeVal.format(dateFormat))}else if(module==="budget"){this.uid(data.uid);this.title(data.title);if(data.isHistory)this.displayStatusText("已完成");
else this.displayStatusText("進行中");var useEnType=ko.utils.arrayFirst(_enableBudgetEntranceTypes,function(item){return item.id===data.entranceType});if(useEnType==null)throw"useEnType is null.";this.meta.entranceTypeName=ko.observable(useEnType.name)}this.isLoadDataDone(true)};this.loadData(module,data);this.needToShowOrgName=ko.pureComputed(function(){if(this.module()!=="policy")return true;var orgName=this.masterOrgName();var title=this.title();if(orgName==null||orgName===""||title==null||title===
"")return false;return title.indexOf(orgName)===-1},this);this.firstMajorCategoryName=ko.pureComputed(function(){if(this.useSectionMode===true)return this.firstSectionName();if(this.majorCategoryList()==null||this.majorCategoryList().length===0)return"";return this.majorCategoryList()[0].name},this);this.firstMajorCategoryCls=ko.pureComputed(function(){if(this.useSectionMode===true)return this.firstSectionCls();if(this.majorCategoryList()==null||this.majorCategoryList().length===0)return"absolute-center cate-basic";
var useMap=window[this.useCategoryIconMap];if(useMap==null)return"absolute-center cate-basic";var cate=this.majorCategoryList()[0];var m=useMap[cate.firstMapperCode];if(m==null)return"absolute-center cate-basic";return"absolute-center "+m.class1},this);this.firstSectionName=ko.pureComputed(function(){if(this.sectionList()==null||this.sectionList().length===0)return"";return this.sectionList()[0].sectionName},this);this.firstSectionCls=ko.pureComputed(function(){if(this.sectionList()==null||this.sectionList().length===
0)return"absolute-center cate-basic";var useMap=window[this.useCategoryIconMap];if(useMap==null)return"absolute-center cate-basic";var firstItem=this.sectionList()[0];var m=useMap[firstItem["sectionId"]];if(m==null)return"absolute-center cate-basic";return"absolute-center "+m.class1},this);this.toUrl=ko.pureComputed(function(){var url="";var module=this.module();if(module==="idea")url="/idea/detail/"+this.uid();else if(module==="policy")url="/policies/detail/"+this.uid();else if(module==="act")url=
"/acts/detail/"+this.uid();else if(module==="pdis"){if(this.isOldCase()===true)return this.oldCaseUrl();url="/pdis/detail/"+this.uid()}else if(module==="budget")url="/pb/budget/detail/"+this.uid();var host="";if(this.entranceType()!=="ey")host=_findLocalGovHost(this.entranceType());if(host!=null&&host!=="")return"//"+host+contextPath+url;return contextPath+url},this);this.titleTip=ko.pureComputed(function(){return"點擊前往"+this.title()},this);this.urlTarget=ko.pureComputed(function(){if(window["_entranceType"])if(this.entranceType()!==
window["_entranceType"])return"_blank";if(this.module()==="pdis"&&this.isOldCase()===true)return"_blank";return"_self"},this);this.doClick=function(){};this.hasChildren=ko.pureComputed(function(){return this.children().length>0},this);this.hasChildrenOrVoteFlag=ko.pureComputed(function(){if(this.meta.voteFlag==null||typeof this.meta.voteFlag!=="function")return this.hasChildren();return this.meta.voteFlag()||this.hasChildren()},this);this.accordionId=ko.pureComputed(function(){return"ta_"+this.module()+
"_"+this.uid()},this);this.isShowEntranceName=ko.pureComputed(function(){if(window["_entranceType"]!=null&&window["_entranceType"]!=="ey")return false;return this.entranceType()!=="ey"},this);this.displayEntranceName=ko.pureComputed(function(){if(!this.isShowEntranceName())return"";if(window["_localGovConfigMap"]){var v=this.entranceType();var c=window["_localGovConfigMap"][v];if(!c)return"";return c.name}return""},this)}
function PolicyVoteView(data,dataIndex){var exData=$.extend({"uid":null,"name":null,"policyUid":null,"enable":false,"seq":0,"voteCount":0,"percentage":0,"voted":false},data);ko.mapping.fromJS(exData,{},this);this.policyData=null;this.isVoted=ko.observable(exData.voted===true);var clsNames=["btn-agree","btn-contra","btn-noComment"];this.clsName=ko.observable(clsNames[dataIndex||0]);this.useClassName=ko.pureComputed(function(){var c1="";if(this.isVoted())c1="active";return"btn my-2 "+this.clsName()+
" "+c1},this);this.showTitle=ko.pureComputed(function(){return"我要投"+this.name()},this);var self=this;this.postData=function(){return{"uid":self.uid()}};this.voteProcessing=ko.observable(false);this.doVoteOption=function(vm,ent){ent.preventDefault();self.doVoteOptionS2(vm,{"fp":"list","cu":window.location.pathname+window.location.search});return false};this.doVoteOptionS2=function(vm,opt){if(self.policyData==null)return;var eOpt=$.extend({"fp":"detail","bc":null},opt);var voteIdentifyFlag=false;if(typeof self.policyData.voteIdentifyFlag===
"function")voteIdentifyFlag=self.policyData.voteIdentifyFlag();else if(typeof self.policyData.voteIdentifyFlag==="boolean")voteIdentifyFlag=self.policyData.voteIdentifyFlag;if(voteIdentifyFlag===true){var qs=$.param(eOpt);window.location.href=contextPath+"/policies/voteProcess/"+self.policyUid()+"/"+self.uid()+"?"+qs;return}if(self.voteProcessing())return;var toVoteUrl=contextPath+"/policies/"+self.policyUid()+"/voteCustomOption";$.ajax({type:"POST",url:toVoteUrl,data:ko.toJSON(vm.postData()),dataType:"json",
contentType:"application/json",beforeSend:function(){self.voteProcessing(true);$.blockUI()},success:function(resp){if(!resp.success){alert(resp.result);return}if(typeof window["_reloadChildrenVoteItems"]==="function")window["_reloadChildrenVoteItems"](vm,resp.result);else if(typeof window["_reloadChildrenVoteItems2"]==="function")window["_reloadChildrenVoteItems2"](vm,resp.result)},error:function(xhr){if(xhr.status===403){loginProcess();return false}alert("投票失敗")},complete:function(){self.voteProcessing(false);
$.unblockUI()}})}}function _findLocalGovHost(type){if(type==="ey")return null;else if(type==="ly")return window["_lyServerName"]||null;else if(type==="cy")return window["_cyServerName"]||null;if(window["_localGovConfigMap"]==null)return null;var config=window["_localGovConfigMap"][type];if(!config)return null;return config.domainName}
function NaviBarStack(){var self=this;this.items=[];this.add=function(item){self.items.push(item)};this.clear=function(){this.items=[]};this.resetThenAdd=function(item){self.clear();self.add(item)};this.resetThenAdd2=function(e,$elt,nextVal){if($elt==null)return;var nextVal=nextVal||$elt.attr("data-c-navi-next");if(nextVal==null||nextVal=="")return;self.resetThenAdd({"elt":$elt,"next":nextVal})};this.hasAnyItem=function(){return self.items.length>0};this.focusNext=function(){if(self.items.length==
0)return;var item=self.items.pop();var nextVal=item.next;self.executeFocus(nextVal)};this.executeFocus=function(attrVal){if(attrVal==null||attrVal=="")return;var $matchElts=$("[data-c-navi-level\x3d'"+attrVal+"']");if($matchElts.length==0){if(attrVal!="data")self.executeFocus("data");return}var $first=$matchElts.filter(":focusable").first();$first.focus()};this.init=function(){$(window).on("join.navi.push",self.resetThenAdd2);$(window).on("join.navi.focus",self.focusNext)};this.init()}
var _naviBarStack=new NaviBarStack;
function _isNavigationBackForwardType(event){if(event==null||event.originalEvent==null)return false;if(event.originalEvent.persisted)return true;try{if(window["performance"]){var performance=window["performance"];var navEntries=performance.getEntriesByType("navigation");if(navEntries.length>0&&navEntries[0]["type"]==="back_forward")return true;var pn=performance["navigation"];if(pn&&pn.type===pn.TYPE_BACK_FORWARD)return true}}catch(ex){return false}return false}var _BFDataManager=new BFDataManager;
function BFDataManager(){this.isNeedToRun=false;this.firstCall=function(){};this.loadBFData=function(){};this.init=function(options){var opts=$.extend({"firstCall":function(){},"loadBFData":function(){}},options);this.firstCall=opts.firstCall;this.loadBFData=opts.loadBFData;var self=this;$(window).on("pageshow",function(e){if(_isNavigationBackForwardType(e)){$(window).trigger("join.bfCache.loadData");self.loadBFData(self)}else{$(window).trigger("join.bfCache.firstCall");self.firstCall()}});$(window).on("join.bfCache.save",
$.proxy(self.onSaveData,self))};this.makeKey=function(key){var urlPath=window.location.pathname;return urlPath+"#"+key};this.saveData=function(key,data){var useKey=this.makeKey(key);window.sessionStorage.setItem(useKey,JSON.stringify(data))};this.getData=function(key){var useKey=this.makeKey(key);var jsonStr=window.sessionStorage.getItem(useKey);if(jsonStr==null)return null;try{return $.parseJSON(jsonStr)}catch(ex){return null}};this.removeData=function(key){var useKey=this.makeKey(key);window.sessionStorage.removeItem(useKey)};
this.onSaveData=function(e,dataToSave){if(dataToSave==null)return;var exData=$.extend({"id":null,"data":{}},dataToSave);if(exData.id==null)return;this.saveData(exData.id,exData.data)}}function _isSupportSessionStorage(){try{var storage=window.sessionStorage;storage.setItem("testKey","testValue");storage.removeItem("testKey");return true}catch(e){return false}}
function _bfDataManagerIfNeed(options){try{if(!_isSupportSessionStorage()||!window["_BFDataManager"])return false;_BFDataManager.init(options)}catch(ex){return false}return true}
function TopicSearchView(options){var self=this;this.options=$.extend({"enable":true,"module":"idea","isHistoryMode":false,"countUrl":contextPath+"/entrance/data/v2/searchCount","dataUrl":contextPath+"/entrance/data/v2/search","firstKeyword":"","keyword":"","majorCateList":[],"minorCateList":[],"tabName":"","queryCountOnInit":false,"useSectionMode":false,"statusTabs":[],"entranceTypeTabs":[],"bfCache":false,"customPageSelector":"#dtPageNumber","majorCatePickerEnable":false},options);this.enable=ko.observable(this.options.enable);
this.showOnDataNotExist=ko.observable(false);this.reqDataFlag=false;this.tab=new SearchTabView({"id":this.options.module,"name":this.options.tabName});this.isActive=ko.observable(false);this.isActive.subscribe(function(newValue){if(newValue&&!self.options.bfCache)self.doSearch()});this.statusTabs=ko.observableArray(this.options.statusTabs||[]);this.currentStatusTab=ko.pureComputed(function(){return ko.utils.arrayFilter(this.statusTabs(),function(item){return item.isActive()})},this);this.entranceTypeTabs=
ko.observableArray(this.options.entranceTypeTabs||[]);this.entranceTypeTabsOnlyAll=ko.pureComputed(function(){return ko.utils.arrayFilter(this.entranceTypeTabs(),function(tab){return tab.id()==="all"})},this);this.entranceTypeTabsExcludeAll=ko.pureComputed(function(){return ko.utils.arrayFilter(this.entranceTypeTabs(),function(tab){return tab.id()!=="all"})},this);this.hasEntranceTypeTabs=ko.pureComputed(function(){return this.entranceTypeTabsExcludeAll().length>0},this);this.currentEntranceTypeTab=
ko.pureComputed(function(){return ko.utils.arrayFilter(this.entranceTypeTabs(),function(item){return item.isActive()})},this);this.currentEntranceTypeTabId=ko.pureComputed(function(){var tab=ko.utils.arrayFirst(this.entranceTypeTabs(),function(item){return item.isActive()});if(tab===null)return"";else return tab.id()},this);this.firstKeyword=ko.observable(this.options.firstKeyword||"");this.keyword=ko.observable(this.options.keyword||"");this.selectedSortType=ko.observable("v2ByDate");this.selectedSortDir=
ko.observable("desc").extend({notify:"always"});this.selectedMajorCateList=ko.observableArray([]);this.selectedSectionList=ko.observableArray([]);this.datalist=ko.observableArray([]);this.isLoading=ko.observable(false);this.isShowNoData=ko.pureComputed(function(){if(this.isLoading())return false;return!this.hasData()},this);this.hasData=ko.pureComputed(function(){return this.datalist().length>0},this);this.showNoDataInfo=ko.pureComputed(function(){return this.showOnDataNotExist()===false&&this.hasData()===
false},this);this.itemRenderTemplate=ko.pureComputed(function(){switch(this.options.module){case "idea":return"v2DataItemIdea";case "policy":return"v2DataItemPolicy";case "act":return"v2DataItemAct";case "budget":return"v2DataItemBudget"}return null},this);this.afterRenderStatusTab=function(elts,tabItem){};this.paramValueMutated=function(){self.firstKeyword.valueHasMutated();self.keyword.valueHasMutated()};this.page={"number":ko.observable(1),"size":ko.observable(10),"totalCount":ko.observable(0),
"totalPage":ko.observable(0),"toJS":function(){return{"page":this.number(),"size":this.size()}}};this.allStatusValues=function(){var statusValues=[];$.each(this.statusTabs(),function(index,item){statusValues.push(item.id())});return statusValues};this.allEntranceTypeValues=function(){var sa=[];$.each(this.entranceTypeTabsExcludeAll(),function(index,item){sa.push(item.id())});return sa};this.buildStatusValues=function(){var statusValues=[];$.each(this.currentStatusTab(),function(index,item){statusValues.push(item.id())});
return statusValues};this.firstStatusValue=function(){var a=this.buildStatusValues();if(a.length===0)return null;return a[0]};this.buildParam=function(){return $.extend({"module":self.options.module,"historyMode":self.options.isHistoryMode,"singleStatus":self.firstStatusValue(),"status":this.allStatusValues(),"enTypeScope":this.allEntranceTypeValues(),"enTypeValue":this.currentEntranceTypeTabId(),"firstKeyword":self.firstKeyword(),"keyword":self.keyword(),"ideaSectionList":self.selectedSectionList(),
"majorCategoryList":self.options.majorCateList,"minorCategoryList":self.options.minorCateList,"sortType":self.selectedSortType(),"sortDir":self.selectedSortDir()},self.page.toJS())};this.doQueryCount=function(){if(!this.enable()||this.reqDataFlag)return null;return $.ajax({type:"POST",url:this.options.countUrl,data:JSON.stringify({"module":this.options.module,"historyMode":self.options.isHistoryMode,"status":this.allStatusValues(),"enTypeScope":this.allEntranceTypeValues(),"enTypeValue":this.currentEntranceTypeTabId(),
"firstKeyword":self.firstKeyword(),"keyword":self.keyword(),"majorCategoryList":self.options.majorCateList,"minorCategoryList":self.options.minorCateList}),contentType:"application/json",viewModel:self,success:function(resp){if(!resp.success){alert("發生異常"+resp.result);return}var vm=this.viewModel;var result=resp.result;var tabCount=result.totalCount||0;if(vm.options.isHistoryMode)if(vm.options.module==="policy"||vm.options.module==="act")tabCount=result.finish||0;vm.tab.count(tabCount);vm.loadStatusCount(result);
$(window).trigger("join.bfCache.save",[vm.buildBFSaveData()])},error:function(){alert("發生異常")}})};this.loadStatusCount=function(data){$.each(this.statusTabs(),function(index,tab){var val=data[tab.id()];if(typeof val=="number"&&!isNaN(val))tab.count(val)});$.each(this.entranceTypeTabs(),function(idx,tab){var val=data["et-"+tab.id()];if(typeof val=="number"&&!isNaN(val))tab.count(val)})};this.doChangeStatusTab=function(tab,isActive){if(isActive&&!self.options.bfCache){$.each(self.statusTabs(),function(index,
otherTab){if(otherTab.id()===tab.id())return;otherTab.isActive(false)});this.page.number(1);this.doSearchInner()}};this.doChangeLocalGovTab=function(tab,isActive){if(isActive&&!self.options.bfCache){$.each(self.entranceTypeTabs(),function(index,otherTab){if(otherTab.id()===tab.id())return;otherTab.isActive(false)});this.page.number(1);this.doSearchInner()}};this.goPageToFirst=function(){self.page.number(1);self.goPage()};this.goPage=function(){this.doSearchInner()};this.doSearchKeywordByKeydown=function(vm,
e){if(e.type==="keydown"&&e.keyCode===13){e.preventDefault();var $elt=$(e.target);$(window).trigger("join.navi.push",[$elt,"data"]);self.doSearchKeyword();return false}return true};this.doSearchKeyword=function(){self.page.number(1);this.doSearchInner()};this.doChangeSortValue=function(sortType,sortDir){self.selectedSortType(sortType);self.selectedSortDir(sortDir);self.page.number(1);self.doSearchInner()};this.reqDataTimestamp=ko.observable(-1);this.reqData=function(options){if(!this.enable())return;
this.reqDataFlag=true;var opts=$.extend({"scope":"container","customPageSelector":self.options.customPageSelector},options);$.ajax({type:"POST",url:this.options.dataUrl,data:JSON.stringify(this.buildParam()),contentType:"application/json",viewModel:self,fetchOptions:opts,beforeSend:function(){$.blockUI();this.viewModel.isLoading(true);if(this.fetchOptions.scope==="container")showTabContentContainer(false);if(this.fetchOptions.scope==="content")showTabContent(false)},success:function(resp){if(!resp.success){alert("發生異常 "+
resp.result);return}var vm=this.viewModel;var result=resp.result;vm.datalist([]);$.each(result,function(index,item){var itemView=new TopicItemView(vm.options.module,item);vm.setupIconMap(itemView,item);vm.datalist.push(itemView)});vm.page.totalCount(resp.totalResults);vm.page.totalPage(resp.totalPages);_firePageNumberPickerM(this.fetchOptions.customPageSelector||"#dtPageNumber",{"current":vm.page.number(),"max":vm.page.totalPage(),"currentAccessor":vm.page.number});var statusCountMap=resp["otherResultCountMap"];
if(statusCountMap){var allCount=statusCountMap["all"];if(typeof allCount==="number"&&!isNaN(allCount))vm.tab.count(allCount);vm.loadStatusCount(statusCountMap)}$(window).trigger("join.navi.focus");$(window).trigger("join.bfCache.save",[vm.buildBFSaveData()])},error:function(){alert("發生異常")},complete:function(){$.unblockUI();this.viewModel.isLoading(false);this.viewModel.reqDataTimestamp((new Date).getTime());if(this.fetchOptions.scope==="container")showTabContentContainer(true);if(this.fetchOptions.scope===
"content")showTabContent(true)}})};this.doSearchInner=function(){if(this.showOnDataNotExist())return;this.reqData({"scope":"content"})};this.doSearch=function(){if(this.showOnDataNotExist())return;this.reqData({"scope":"container"})};this.clean=function(){this.page.number(1);this.keyword("");this.datalist([])};this.setupIconMap=function(itemView,item){var checkUseSectionMode=item["useSectionMode"]===true||this.options.useSectionMode===true;if(checkUseSectionMode){if(window["_sectionIconMap"])itemView.useCategoryIconMap=
"_sectionIconMap";else if(window["_sectionIconMap_"+item.entranceType])itemView.useCategoryIconMap="_sectionIconMap_"+item.entranceType;itemView.useSectionMode=true}};this.buildBFSaveData=function(){var dataArr=[];$.each(self.datalist(),function(i,item){dataArr.push(item.odata)});var statusCountMap={};$.each(self.statusTabs(),function(index,tab){statusCountMap[tab.id()]=tab.count()});statusCountMap.all=self.tab.count();return{id:self.options.module+"View",data:{"param":self.buildParam(),"pagination":{"number":self.page.number(),
"size":self.page.size(),"totalCount":self.page.totalCount(),"totalPage":self.page.totalPage()},"datalist":dataArr,"countMap":statusCountMap}}};this.init=function(){$.each(this.statusTabs(),function(index,statusTab){if(index===0)statusTab.isActive(true);statusTab.options.onActive=$.proxy(self.doChangeStatusTab,self)});$.each(this.entranceTypeTabs(),function(index,localGovTab){if(index===0)localGovTab.isActive(true);localGovTab.options.onActive=$.proxy(self.doChangeLocalGovTab,self)});if(this.options.majorCatePickerEnable===
true)this.selectedMajorCateList.subscribe(function(newValue){self.options.majorCateList=newValue})};this.init()}
function SearchTabView(options){var self=this;this.options=$.extend({"id":"","name":"","onActive":function(tab,isActive){},"param":{}},options);this.id=ko.observable(this.options.id);this.name=ko.observable(this.options.name);this.count=ko.observable(0);this.param={};this.exParam=null;this.exParamBuilder=options.exParamBuilder;this.paramValueMutated=function(){for(var k in this.param){var paramAccessor=this.param[k];if(typeof paramAccessor=="function"&&paramAccessor["valueHasMutated"])paramAccessor["valueHasMutated"]()}};
this.buildParam=function(){var p=this.param;if(!$.isEmptyObject(this.exParam))p=$.extend(this.param,this.exParam);if(typeof this.exParamBuilder=="function")p=$.extend(p,this.exParamBuilder());return ko.mapping.toJS(p)};this.isVisible=ko.observable(true);this.isActive=ko.observable(false);this.isActive.subscribe(function(newValue){if(self.options.onActive)self.options.onActive(self,newValue)});this.toggleActive=function(){this.isActive(!this.isActive())};this.clickToActive=function(){if(this.isActive()){$(window).trigger("join.navi.focus");
return}this.isActive(true)};this.showText=ko.pureComputed(function(){return this.name()+"("+this.count()+")"},this);this.toJS=function(){return{id:this.id(),name:this.name(),count:this.count(),param:this.buildParam()}};this.loadDataS1=function(data){if(this.id()!==data.id)return;try{this.count(data.count);for(var paramKey in data.param){var value=data.param[paramKey];if(self.param[paramKey]!=null&&typeof self.param[paramKey]==="function")self.param[paramKey](value);else if(self.exParam!=null&&typeof self.exParam[paramKey]===
"function")self.exParam[paramKey](value)}}catch(e){}};this.init=function(){if(!$.isEmptyObject(this.options.param))ko.mapping.fromJS(this.options.param,{},this.param)};this.init()}
function CSearchView(options){this.options=$.extend({"viewId":"cSearchView","module":"policy","dataUrl":"","exportDataUrl":"","exportDataMethod":"POST","reqCountMode":false,"tabLayer1":[],"tabLayer2":[],"tabClickAndSearch":true,"param":{},"sort":"","autoSearchOnChangeParam":[],"onActiveTabCallback":function(tab){},"pageNumberPickerId":null},options);var self=this;this.tabLayer1=ko.observableArray([]);this.tabLayer2=ko.observableArray([]);this.keyword=ko.observable("");this.sort=ko.observable(this.options.sort);
this.param={};this.visibleParam={};this.paramValueMutated=function(){for(var k in this.param){var paramAccessor=this.param[k];if(typeof paramAccessor=="function"&&paramAccessor["valueHasMutated"])paramAccessor["valueHasMutated"]()}this.keyword.valueHasMutated();$.each(self.tabLayer1(),function(i,tab){if(!tab.isActive())return;tab.paramValueMutated()});$.each(self.tabLayer2(),function(i,tab){if(!tab.isActive())return;tab.paramValueMutated()})};this.buildParam=function(){var params=ko.mapping.toJS(this.param);
$.each(self.tabLayer1(),function(i,tab){if(!tab.isActive())return;var p=tab.buildParam();if(!$.isEmptyObject(p))params=$.extend(params,p)});$.each(self.tabLayer2(),function(i,tab){if(!tab.isActive())return;var p=tab.buildParam();if(!$.isEmptyObject(p))params=$.extend(params,p)});return $.extend({"page":this.page.number(),"size":parseInt(this.page.size()),"keyword":this.keyword()},params)};this.buildPageParam=function(){var paramData={"page":this.page.number(),"size":parseInt(this.page.size())};if(this.sort()!==
"")paramData.sort=this.sort();return $.param(paramData)};this.reqDataTimestamp=ko.observable(-1);this.datalist=ko.observableArray([]);this.page=new SearchPageView;this.makePagination=function(){if(this.options.pageNumberPickerId)_firePageNumberPickerM("#"+this.options.pageNumberPickerId,{current:this.page.number(),max:this.page.totalPage(),currentAccessor:this.page.number})};this.hasData=ko.pureComputed(function(){return this.datalist().length>0},this);this.hasMoreData=ko.pureComputed(function(){return this.page.number()>=
1&&this.page.number()<this.page.totalPage()},this);this.isLoading=ko.observable(false);this.isShowNoData=ko.pureComputed(function(){if(this.isLoading())return false;return!this.hasData()},this);this.findTabLayer=function(layerNum){var tabs=[];if(layerNum===1)tabs=self.tabLayer1();else if(layerNum===2)tabs=self.tabLayer2();return tabs};this.findTab=function(layerNum,tabId){var tabs=self.findTabLayer(layerNum);return ko.utils.arrayFirst(tabs,function(tab){return tab.id()===tabId})};this.doActiveTab=
function(tab){if(tab.isActive()){$(window).trigger("join.navi.focus");return}tab.isActive(true);if(self.options.onActiveTabCallback)self.options.onActiveTabCallback(tab);if(tab.options.paramName&&self.param[tab.options.paramName])self.param[tab.options.paramName](tab.id());if(self.options.tabClickAndSearch)self.doSearch()};this.onActiveTab=function(tab,isActive){if(isActive){var tabs=self.findTabLayer(tab.options.layer);$.each(tabs,function(i,itemTab){if(itemTab.id()!==tab.id())itemTab.isActive(false)})}};
this.loadCountMap=function(countMap){if(countMap==null)return;if(self.options.reqCountMode===true){$.each(self.tabLayer1(),function(i,tab){if(!tab.isActive())return;var val=countMap[tab.id()];if(typeof val=="number")tab.count(val)});return}$.each(self.tabLayer1(),function(i,tab){var val=countMap[tab.id()];if(typeof val=="number")tab.count(val)});$.each(self.tabLayer2(),function(i,tab){var val=countMap[tab.id()];if(typeof val=="number")tab.count(val)})};this.fetchCountLayer1=function(){$.each(self.tabLayer1(),
function(i,tabLayer){var params={};if(self.options.tabToParam["tabLayer1"]){var pn=self.options.tabToParam["tabLayer1"];params[pn]=tabLayer.id()}params=$.extend(params,tabLayer.buildParam());var pageParam={"page":1,"size":1,"onlyCount":true};$.ajax({type:"POST",url:self.options.dataUrl+"?"+$.param(pageParam),data:JSON.stringify(params),contentType:"application/json",viewModel:self,tabLayer:tabLayer,beforeSend:function(){},success:function(resp){if(!resp.success)return;this.tabLayer.count(resp.totalResults)},
error:function(){},complete:function(){}})})};this.fetchData=function(options){var opts=$.extend({"cleanArrayBefore":true},options);$.ajax({type:"POST",url:self.options.dataUrl+"?"+self.buildPageParam(),data:JSON.stringify(self.buildParam()),contentType:"application/json",viewModel:self,customOptions:opts,beforeSend:function(){$.blockUI();this.viewModel.isLoading(true)},success:function(resp){if(!resp.success){alert("發生錯誤");return}var vm=this.viewModel;vm.page.totalCount(resp.totalResults);vm.page.totalPage(resp.totalPages);
vm.makePagination();if(this.customOptions.cleanArrayBefore)vm.datalist([]);$.each(resp.result,function(index,item){vm.datalist.push(new TopicItemView(vm.options.module,item))});vm.loadCountMap(resp.otherResultCountMap);$(window).trigger("join.navi.focus");$(window).trigger("join.search.completed",[this]);$(window).trigger("join.bfCache.save",[vm.makeBFDataToSave()])},error:function(){},complete:function(){$.unblockUI();this.viewModel.isLoading(false);this.viewModel.reqDataTimestamp((new Date).getTime())}})};
this.doFetchCountLayer1=function(){this.fetchCountLayer1()};this.doSearchByKeydown=function(vm,e){if(e.type==="keydown"&&e.keyCode===13){var $elt=$(e.target);$(window).trigger("join.navi.push",[$elt]);self.doSearch()}return true};this.doSearch=function(){self.page.number(1);self.fetchData()};this.doExport=function(){var formContainer=$("#exportDataFormContainer");if(formContainer.length===0)return;var exportDataUrl=self.options.exportDataUrl;if(exportDataUrl==null||exportDataUrl==="")return;var qs=
self.buildPageParam();var sendUrl=exportDataUrl+"?r\x3d"+Math.floor(Math.random()*100)+"\x26"+qs;var postData=self.buildParam();$.blockUI();fetch(sendUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(postData)}).then(function(resp){return resp.blob()}).then(function(blob){var downloadUrl=window.URL.createObjectURL(blob);var a=document.createElement("a");a.style.display="none";if(typeof a.download==="undefined")window.open(downloadUrl);else{a.href=downloadUrl;a.download=
"匯出資料_"+(new Date).getTime()+".csv";document.body.appendChild(a);a.click();a.remove()}window.URL.revokeObjectURL(downloadUrl);$.unblockUI()}).catch(function(){alert("發生異常");$.unblockUI()})};this.doExportByKeydown=function(vm,e){if(e.type==="keydown"&&e.keyCode===13)self.doExport();return true};this.goPageToFirst=function(v,e){self.page.number(1);self.goPage(v,e)};this.goPage=function(v,e){this.fetchData();var opts={findClosest:true,fromElt:e==null?null:$(e.currentTarget)};if(window["_entranceType"]!==
"ey")opts=null;_scrollMoveToElt("[data-c-container]",opts)};this.goNextPage=function(){this.page.nextPage();this.fetchData()};this.appendNextPage=function(){this.page.nextPage();this.fetchData({"cleanArrayBefore":false})};this.goPrevPage=function(){this.page.prevPage();this.fetchData()};this.makeBFDataToSave=function(){var toArr=[];$.each(this.datalist(),function(idx,item){toArr.push(item.odata)});return{"id":this.options.viewId,"data":{"param":this.buildParam(),"page":{"page":this.page.number(),
"size":parseInt(this.page.size()),"sort":this.sort()},"pagination":{current:this.page.number(),max:this.page.totalPage(),totalCount:this.page.totalCount(),totalPage:this.page.totalPage()},"tabLayer1":this.tabLayerToJS(this.tabLayer1()),"tabLayer2":this.tabLayerToJS(this.tabLayer2()),"datalist":toArr}}};this.loadBFData=function(bfData){};this.tabLayerToJS=function(tabLayer){var r=[];$.each(tabLayer,function(index,tab){r.push(tab.toJS())});return r};this.init=function(){if(!$.isEmptyObject(this.options.param))ko.mapping.fromJS(this.options.param,
{},this.param);if(!$.isEmptyObject(this.options.visibleParam))ko.mapping.fromJS(this.options.visibleParam,{},this.visibleParam);if(this.options.autoSearchOnChangeParam)$.each(this.options.autoSearchOnChangeParam,function(i,paramName){var va=self.param[paramName];if(!va)return;va.subscribe(function(newValue){self.doSearch()})});$.each(this.options.tabLayer1,function(i,item){var tab=new SearchTabView(item);tab.options.layer=1;if(self.options.tabToParam)tab.options.paramName=self.options.tabToParam["tabLayer1"];
tab.options.onActive=$.proxy(self.onActiveTab,self);self.tabLayer1.push(tab);if(i===0)tab.isActive(true)});$.each(this.options.tabLayer2,function(i,item){var tab=new SearchTabView(item);tab.options.layer=2;if(self.options.tabToParam)tab.options.paramName=self.options.tabToParam["tabLayer2"];tab.options.onActive=$.proxy(self.onActiveTab,self);self.tabLayer2.push(tab);if(i===0)tab.isActive(true)})};this.init()}
function IdeaMetaVisibleControlView(ideaData){this.showEndorseCountStatusArr=["FirstSigned","SecondSigned","PendingFirst","PendingSecond","Completed","Advice","PendingAdvice","PendingCompleted","FirstFailed","SecondFailed"];this.isShowEndorseCount=ko.observable(false);this.isShowNotEndorseStage=ko.observable(false);this.isShowDaysLeft=ko.observable(false);this.isShowMessageCount=ko.observable(false);this.init=function(idea){var ideaStatus=idea.odata.status;this.isShowMessageCount(["Ready","PendingReady"].indexOf(ideaStatus)==
-1);var daysLeft=idea.odata.daysLeft;if(daysLeft!=null&&!isNaN(daysLeft)&&daysLeft>0&&["FirstSigned","SecondSigned","Completed","Advice"].indexOf(ideaStatus)!=-1)this.isShowDaysLeft(true);if(this.showEndorseCountStatusArr.indexOf(ideaStatus)!=-1)this.isShowEndorseCount(true);this.isShowNotEndorseStage(["Rejected","Revoked","Ready","PendingReady"].indexOf(ideaStatus)!=-1)};this.init(ideaData)}
function SearchPageView(options){var opts=$.extend({size:20},options);this.number=ko.observable(1);this.size=ko.observable(opts.size);this.totalCount=ko.observable(0);this.totalPage=ko.observable(0);this.nextPage=function(){var pageNumber=this.number()+1;if(pageNumber>this.totalPage())return;this.number(pageNumber)};this.prevPage=function(){var pageNumber=this.number()-1;if(pageNumber<=0)return;this.number(pageNumber)}}
function BMessageModalBoxView(options){var self=this;this.options=$.extend(true,{"header":"","subTitle":"","content":"","buttons":[{"text":"關閉","onClick":function(){}}],"onShow":function(){},"onHidden":function(){}},options);this.header=ko.observable(this.options.header);this.subTitle=ko.observable(this.options.subTitle);this.content=ko.observable(this.options.content);this.isShown=ko.observable(false);this.show=function(data){if(this.isShown())return;if(data==null)return;if(data.header)self.header(data.header);
if(data.subTtile)self.subTitle(data.subTtile);if(data.content)self.content(data.content);this.isShown(true)};this.close=function(){this.clean();this.isShown(false)};this.clean=function(){this.header("");this.subTitle("");this.content("")};this.afterShown=function(){if(this.options.onShow&&typeof this.options.onShow=="function")this.options.onShow()};this.afterHidden=function(){if(this.options.onHidden&&typeof this.options.onHidden=="function")this.options.onHidden();this.close()}}
function OutlookCategoryPickerView(options){var self=this;this.options=$.extend(true,{"selectedModule":["idea"],"selectedMajor":[],"selectedMinor":[],"onConfirm":function(jsonData,vm){}},options);this.moduleList=ko.observableArray([new JoinModuleItemModel("idea","來附議"),new JoinModuleItemModel("policy","眾開講"),new JoinModuleItemModel("act","來監督")]);this.selectedModuleList=ko.observableArray(this.options.selectedModule);this.majorCategoryList=ko.observableArray([]);this.selectedMajor=ko.observableArray([]);
this.onAfterRenderMajor=function(elts){$(elts).filter("label.c-label-checkbox").keydown(_labelClickHandler)};this.useMajorCategory=function(mapperCode){if(this.majorCategoryList().length==0)return null;var target=null;$.each(this.majorCategoryList(),function(index,item){if(item.mapperCode()==mapperCode)target=item});return target};this.findMajorByCode=function(code){var r=null;$.each(self.majorCategoryList(),function(index,major){if(major.mapperCode()==code)r=major});return r};this.findSelectedMajor=
function(){var r=[];$.each(self.majorCategoryList(),function(index,major){if(major.selected())r.push(major)});return r};this.show=function(){$("#issueFilter").modal("show")};this.hide=function(){$("#issueFilter").modal("hide")};this.clear=function(){$.each(this.majorCategoryList(),function(index,item){item.clear()})};this.reset=function(){this.majorCategoryList([])};this.toJS=function(){var majorValues=[],minorValues=[];$.each(self.selectedMajor(),function(i,major){if(major.selected())majorValues.push(major.mapperCode());
$.each(major.findSelectedMinorAll(),function(j,minor){minorValues.push(minor.data.mapperCode())})});return{module:self.selectedModuleList(),major:majorValues,minor:minorValues}};this.doClickMinorItem=function(minorItem){if(minorItem==null)return;var isSelected=minorItem.selected();minorItem.selected(!isSelected)};this.doConfirm=function(){if(typeof this.options.onConfirm=="function")this.options.onConfirm(this.toJS(),this);this.hide()};this.doChange=function(codes){if(codes==null)codes=[];var a=[];
$.each(codes,function(index,code){var major=self.findMajorByCode(code);if(!major)return;major.selected(true);a.push(major)});self.selectedMajor(a);$.each(self.majorCategoryList(),function(index,item){var isExist=codes.indexOf(item.mapperCode())!=-1;if(!isExist){item.selected(false);item.clear()}})};this.notifySelect2=ko.observable(1);this.buildSelectedMajorMapperCode=function(){var r=[];$.each(self.selectedMajor(),function(index,item){r.push(item.mapperCode())});return r};this.onSelectMajor=function(major,
isSelected){if(isSelected)self.selectedMajor.push(major);else ko.utils.arrayRemoveItem(self.selectedMajor(),major);self.notifySelect2(Math.random().toString(36).substring(7))};this.setupSubscribe=function(){$.each(self.majorCategoryList(),function(index,major){major.selected.subscribe($.proxy(self.onSelectMajor,self,major))})};this.loadFromOption=function(){$.each(self.majorCategoryList(),function(index,major){var uid=major.uid();if(self.options.selectedMajor.indexOf(uid)==-1)return;major.selected(true);
major.loadMinor(self.options.selectedMinor)})};this.init=function(){$.ajax({type:"GET",url:contextPath+"/api/outlookCategory",contentType:"application/json",viewModel:this,beforeSend:function(){this.viewModel.reset()},success:function(resp){if(!resp.success){console.error("happened error.",resp);return}var vm=this.viewModel;$.each(resp.result,function(index,item){vm.majorCategoryList.push(new MajorOutlookCategoryModel(item))});vm.setupSubscribe();vm.loadFromOption()},error:function(){console.error("happened error.")}})};
this.init()}function showTabContentContainer(isShow){if(isShow){$("#tabContentContainer").addClass("show");_scrollMoveToElt("#cSearchContainer")}else $("#tabContentContainer").removeClass("show")}function showTabContent(isShow){if(isShow){$("#tabContent").addClass("show");_scrollMoveToElt("#cSearchContainer")}else $("#tabContent").removeClass("show")}
function _calBodyPaddingTop(){var $page=$(".page_new_box");var bodyPadding=0;if($page.length>0){bodyPadding=$page.css("padding-top");bodyPadding=parseInt(bodyPadding.replace("px",""))}if(isNaN(bodyPadding))bodyPadding=0;return bodyPadding}
function _scrollMoveToElt(selector,options){var opts=$.extend({findParent:false,findSiblings:false,findClosest:false,fromElt:null},options);var $target=null;if(opts.findParent)$target=$(opts.fromElt).parents(selector);else if(opts.findSiblings)$target=$(opts.fromElt).siblings(selector);else if(opts.findClosest)$target=$(opts.fromElt).closest(selector);else $target=$(selector);if($target==null||$target.length===0)return;try{var pos=$target.offset();var topVal=_calBodyPaddingTop();$("body,html").scrollTop(pos.top-
topVal)}catch(ex){console.error(ex)}}
function _makePageNumberPicker(elt){var $elt;if(elt)$elt=$(elt);else $elt=$("select.c-page-number-picker");$elt.off("join-page-reload").on("join-page-reload",function(e,curValAcc){var $this=$(this);var minPage=parseInt($this.attr("data-c-page-min"));if(isNaN(minPage))minPage=1;var maxPage=parseInt($this.attr("data-c-page-max"));if(isNaN(maxPage))maxPage=1;var currentPage=parseInt($this.attr("data-c-page-current"));if(isNaN(currentPage))currentPage=1;$this.empty();for(var i=minPage;i<=maxPage;i++){var $opt=
$("\x3coption/\x3e",{"value":i,"html":i});if(currentPage===i)$opt.attr("selected","selected");$opt.appendTo($this)}})}function _firePageNumberPicker(option){var opt=$.extend({"current":1,"max":1,"currentAccessor":null},option);_firePageNumberPickerM("select.c-page-number-picker",opt)}
function _firePageNumberPickerM(eltSelector,option){var opt=$.extend({"current":1,"max":1,"currentAccessor":null},option);$(eltSelector).attr("data-c-page-current",opt.current).attr("data-c-page-max",opt.max).trigger("join-page-reload",[opt.currentAccessor])}function _toUrlByAsync(toUrl){if(toUrl==null||toUrl==="")return;setTimeout(function(){window.location.href=toUrl},10)}
function _toDateFormatROC(date){if(date==null)return"";var year=date.getFullYear()-1911;var month=date.getMonth()+1;var day=date.getDate();return year+"年"+month+"月"+day+"日"}function _resolveQueryParam(paramName){paramName=paramName.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\?\x26]"+paramName+"\x3d([^\x26#]*)");var results=regex.exec(location.search);return results===null?"":decodeURIComponent(results[1].replace(/\+/g," "))}
function _resolveQueryString(){var r={};var queryStr=window.location.search.substring(1);var vars=queryStr.split("\x26");for(var i=0;i<vars.length;i++){var pair=vars[i].split("\x3d");if(typeof r[pair[0]]==="undefined")r[pair[0]]=pair[1];else if(typeof r[pair[0]]==="string"){var arr=[r[pair[0]],pair[1]];r[pair[0]]=arr}else r[pair[0]].push(pair[1])}return r}
function VCodeViewModel(options){var self=this;this.options=$.extend({"type":"f1","vCodeKey":null,"imgElement":null,"url":window["contextPath"]+"/vCode/img.jpeg","soundUrl":window["contextPath"]+"/vCode/sound.mp3"},options);if(!_.isEmpty(this.options.vCodeKey)){this.options.url=window["contextPath"]+("/vCode/"+this.options.vCodeKey+"/img.jpeg");this.options.soundUrl=window["contextPath"]+("/vCode/"+this.options.vCodeKey+"/sound.mp3")}this.isReady=ko.observable(false);this.doReady=function(){if(this.isReady())return;
this.isReady(true)};this.ctVal=ko.observable((new Date).getTime());this.qs=function(){return $.param({"ct":self.ctVal(),"t":self.options.type})};this.imgSrc=ko.pureComputed(function(){if(self.isReady())return self.options.url+"?"+self.qs();return""},this);this.remake=function(){self.ctVal((new Date).getTime())};this.remakeImgSrc=function(){this.remake();return this.imgSrc()};this.showImgAtElt=function(elt){$(elt).attr("src",self.imgSrc())};this.audioPlayer=null;this.playAudio=function(){var useUrl=
self.options.soundUrl+"?"+self.qs();if(self.audioPlayer!=null&&!self.audioPlayer.paused)return;self.audioPlayer=new Audio(useUrl);var promise=self.audioPlayer.play();if(promise!==undefined)promise.then(function(){}).catch(function(error){console.log(error)})};this.buildAnswer=function(vCodeInput){return btoa(this.options.vCodeKey+"::"+vCodeInput)}}function _hasVCodeFeature(){return $("#vCodeInputAtBottom").length>0}function _findCsrfValue(){return $("input[data-csrf-value]").first().val()}
function EyeView(options){var self=this;this.options=$.extend({"text":"","value":"","enable":true},options);this.value=ko.observable(this.options.value);this.show=ko.observable(false);this.toggleShow=function(){self.show(!self.show())};this.displayTitle=ko.pureComputed(function(){return self.show()?"點擊以隱藏"+self.options.text:"點擊以顯示"+self.options.text},this);this.isEnable=ko.pureComputed(function(){return self.options.enable===true},this);this.useInputType=ko.pureComputed(function(){if(self.options.enable===
false)return"text";return self.show()?"text":"password"},this)};