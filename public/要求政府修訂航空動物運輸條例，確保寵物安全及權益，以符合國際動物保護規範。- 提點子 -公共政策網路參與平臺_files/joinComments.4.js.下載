var _rdqImageUploaderCounter=0;var _rdqLinkCounter=0;var _rdqFormCounter=0;var BoardViewType={Basic:1,Debate:2};$(function(){setupAuthorImageLazyload($("img.j-lazyload"))});
function BoardViewModel(data){var self=this;this.boardUid=ko.observable(data.boardUid);this.subjectUid=ko.observable(data.subjectUid);this.subjectType=ko.observable(data.subjectType);this.isLogin=ko.observable(data.isLogin==="true");this.isSubscribed=ko.observable(data.isSubscribed==="true");this.isEnabled=ko.observable(data.isEnable==="true");var endTime=null;if(data.boardEndTime&&!isNaN(parseInt(data.boardEndTime))){endTime=parseInt(data.boardEndTime)-8*60*60*1E3;if(endTime<0)endTime=null}this.boardEndTime=
ko.observable(endTime);this.checkBeforeEndTime=function(){return true};this.isDisabled=ko.pureComputed(function(){return!this.isEnabled()},this);this.enableVCode=data.enableVCode===true;this.vCodeKey=data.vCodeKeyMap["base"];this.boardLoadTimestamp=data.boardLoadTimestamp;this.showAreaHeader=ko.observable(this.isEnabled());this.showAreaMessage=ko.observable(this.isEnabled());this.viewType=data.viewType||BoardViewType.Basic;this.messageListViewMap={};if(this.viewType==BoardViewType.Basic){var msgListView=
new MessageListView(data,self);this.messageListViewMap={"basic":msgListView}}else if(this.viewType==BoardViewType.Debate){this.messageListViewMap={"Positive":new MessageListView($.extend(data,{sortEltId:"leftSortSelector",sideType:"Positive",pageSize:10}),self),"Negative":new MessageListView($.extend(data,{sortEltId:"rightSortSelector",sideType:"Negative",pageSize:10}),self)};this.leftMessageListView=this.messageListViewMap.Positive;this.rightMessageListView=this.messageListViewMap.Negative}this.basicMessageListView=
function(){var msgListView=this.messageListViewMap.basic;if(!msgListView)return;return msgListView};this.joinComments=ko.pureComputed(function(){return this.messageListViewMap.basic.list()},this);this.changeSortOption=function(viewModel,event){var msgListView=viewModel.basicMessageListView();msgListView.sortChangedCall()};this.moreMessage=function(viewModel,event){var msgListView=viewModel.basicMessageListView();if(!msgListView)return;msgListView.moreMessageCall(msgListView,event)};this.isScreenDesktop=
function(){return $(window).width()>=768};this.isScreenMobile=function(){return $(window).width()<768};this.hasMoreAnyMessageView=ko.pureComputed(function(){return this.leftMessageListView.hasMoreData()||this.rightMessageListView.hasMoreData()},this);this.readMorePage=function(viewModel,event){this.leftMessageListView.readMorePage(this.leftMessageListView,event);this.rightMessageListView.readMorePage(this.rightMessageListView,event)};this.currentMessageView=ko.observable();this.currentSideType=ko.observable();
this.currentSideType.subscribe(function(newValue){if(self.leftMessageListView.sideType==newValue)self.currentMessageView(self.leftMessageListView);else if(self.rightMessageListView.sideType==newValue)self.currentMessageView(self.rightMessageListView);var formView=self.activeFormView();if(formView)formView.sideType(newValue)});this.clsNameForActiveFormView=ko.pureComputed(function(){if(this.currentSideType()==="Positive")return"secondary-background";else if(this.currentSideType()==="Negative")return"primary-background";
else return""},this);this.isSideTypePositive=ko.pureComputed(function(){return this.currentSideType()=="Positive"},this);this.isSideTypeNegative=ko.pureComputed(function(){return this.currentSideType()=="Negative"},this);this.sortChanged2=function(viewModel,event){var $slt=$(event.currentTarget);var sltId=$slt.attr("id");if(sltId=="leftSortSelector")self.leftMessageListView.sortChangedCall();else if(sltId=="rightSortSelector")self.rightMessageListView.sortChangedCall()};this.afterRenderCallback=function(elts){setupAuthorImageLazyload($("img.j-lazyload"));
setupLinkTitleFromRemote(elts)};this.visibleLoginForm=ko.observable(false);this.focusPostContent=function(){self.visibleLoginForm(true)};this.visibleAnonymousLogin=ko.observable(false);this.openAnonymousLogin=function(event){var $target=$(event.currentTarget).addClass("on");var siblings=$target.siblings("p.visit_btn");var isOpened=siblings.hasClass("on");if(isOpened){siblings.removeClass("on");return}var b=self.visibleAnonymousLogin();var n=!b;self.visibleAnonymousLogin(n);if(!n)$target.removeClass("on")};
this.postContent=ko.observable("");this.postMessage=function(form){var p=$(form).form2json();if(!validPostMessageParam(p,self))return;var url=joinCommentsUrl["postMessage"];if(self.subjectType()==="policy_scholar")url=joinCommentsUrlScholar["postMessage"];$.ajax({url:url,type:"POST",data:JSON.stringify(p),contentType:"application/json",beforeSend:function(){},complete:function(){},success:function(resp){if(!resp.success){alert("新增留言失敗 "+resp.result);return}var newMessageViewModel=new MessageViewModel(resp.result,
null);self.joinComments.splice(0,0,newMessageViewModel);form.reset();_reloadPageOverDay(self.boardLoadTimestamp)},error:function(){alert("新增留言失敗")}})};this.postMessageLoadmaskView=new SimpleLoadmaskView;this.postMessaageV2=function(form,reqData,formViewModel){var url=joinCommentsUrl["postMessage"];if(self.subjectType()==="policy_scholar")url=joinCommentsUrlScholar["postMessage"];if(self.subjectType()==="policy")if(discussionType!=="All")if(reqData.identity==="scholar"){alert("你無法使用此帳號留言");return}if(!self.checkBeforeEndTime()){alert("討論版已暫停討論");
window.location.reload();return}$.ajax({url:url,type:"POST",data:JSON.stringify(reqData),contentType:"application/json",beforeSend:function(){$(".disableOnMessageRequest").prop("disabled",true);self.postMessageLoadmaskView.show(true);formViewModel.loadmaskStart(form)},complete:function(){$(".disableOnMessageRequest").prop("disabled",false);self.postMessageLoadmaskView.show(false);formViewModel.loadmaskStop(form)},success:function(resp){if(!resp.success){if(resp.result.indexOf("code:-106")>-1){alert("新增留言失敗 討論版已暫停討論");
window.location.reload();return}alert("新增留言失敗 "+resp.result);formViewModel.clearVCodeIfNeed();return}var newMessageViewModel=new MessageViewModel(resp.result,self);for(var msgListKey in self.messageListViewMap){var msgList=self.messageListViewMap[msgListKey];msgList.addMessageAtFirst(newMessageViewModel,{reloadSortByNew:true})}formViewModel.cleanAll();formViewModel.isVisible(false);if(self.scoreView)self.scoreView.onCompleteAddMessage(newMessageViewModel);if(self.viewType===BoardViewType.Debate)self.activeFormViewVisible(false);
else if(self.viewType===BoardViewType.Basic)self.activeFormViewVisible(false);_reloadPageOverDay(self.boardLoadTimestamp)},error:function(){alert("新增留言失敗")}})};this.showShareBox=function(viewModel,event){var target=$(event.currentTarget).siblings(".rdq_sharepop").toggleClass("opened");$("body").unbind("click",self.closeShareBox);if(target.hasClass("opened"))$("body").bind("click",{showBoxElement:target},self.closeShareBox)};this.closeShareBox=function(event){var $target=$(event.target);var box=event.data.showBoxElement;
var btn=box.siblings("button");if($target.is(box)||$target.is(btn))return;box.removeClass("opened")};this.subscribeBtnText=ko.computed(function(){if(self.isSubscribed())return _locale=="en_US"?"Subscribe Finish":"訂閱完成";else return _locale=="en_US"?"Subscribe":"訂閱"},this);this.openSubscribeBox=function(viewModel,event){if(self.isSubscribed())return};this.closeSubscribeBox=function(viewModel,event){var $btn=$(event.currentTarget)};this.subscribe=function(form){var p=$(form).form2json();if(!p.email){alert("請輸入email");
return}if(!ko.validation.rules.emailS1.validator(p.email,true)){alert("請輸入正確的email");return}var ajaxReqs=[$.ajax({url:joinCommentsUrl["subscribe"].toSubstitution({"board_uid":self.boardUid()}),type:"POST",data:JSON.stringify(p),contentType:"application/json",success:function(resp){if(!resp.success){alert("訂閱失敗 "+resp.result);return}alert("訂閱成功");self.isSubscribed(true);$("#rdqBoardSubscribeFormDialog, #rdqBoardSubscribeFormDialog2").modal("hide")},error:function(resp){alert("訂閱失敗")},complete:function(){}})];
$.when.apply($,ajaxReqs).then(function(){})};this.subscribeOnLogin=function(){if(!self.isLogin()){alert("請先登入方可操作");return}if(self.isSubscribed()){var ajaxReqs=[$.ajax({url:joinCommentsUrl["subscribeRe"].toSubstitution({"board_uid":self.boardUid()}),type:"POST",data:JSON.stringify({}),contentType:"application/json",success:function(resp){if(!resp.success){alert("取消訂閱失敗 "+resp.result);return}alert("取消訂閱成功");self.isSubscribed(false)},error:function(resp){alert("取消訂閱失敗")}})];$.when.apply($,ajaxReqs).then(function(){})}else{var ajaxReqs=
[$.ajax({url:joinCommentsUrl["subscribe"].toSubstitution({"board_uid":self.boardUid()}),type:"POST",data:JSON.stringify({}),contentType:"application/json",success:function(resp){if(!resp.success){alert("訂閱失敗 "+resp.result);return}alert("訂閱成功");self.isSubscribed(true)},error:function(resp){alert("訂閱失敗")}})];$.when.apply($,ajaxReqs).then(function(){})}};this.activeFormView=ko.observable();this.activeFormViewVisible=ko.observable(true);this.postMessageForm=new RdqFormViewModel({formType:"post",enableVCode:self.enableVCode,
vCodeKey:self.vCodeKey,onFormSubmit:self.postMessaageV2},self);this.activeFormView(this.postMessageForm);this.activeFormCSSBySideType=ko.pureComputed(function(){if(this.activeFormView()==null)return"";var formView=this.activeFormView();if(formView.sideType()==="Positive")return"new agreen item clearfix";if(formView.sideType()==="Negative")return"new insorg item clearfix";return""},this);this.doRdqStartOnKeydown=function(viewModel,e){if(e.type=="keydown"&&e.keyCode==13){e.preventDefault();var $this=
$(e.target);$(window).trigger("join.navi.push",[$this]);viewModel.doRdqStart(viewModel,e);$(window).trigger("join.navi.focus");return false}return true};this.doRdqStart=function(viewModel){if(viewModel.activeFormViewVisible()){viewModel.activeFormViewVisible(false);viewModel.activeFormView().isVisible(false)}else{viewModel.activeFormViewVisible(true);viewModel.activeFormView().isVisible(true)}};this.doDebateStartOutside=function(){var sideType=this.currentSideType();this.doDebateStartInner(this,sideType)};
this.doDebateStartOnKeydown=function(viewModel,e){if(e.type=="keydown"&&e.keyCode==13){e.preventDefault();var $this=$(e.target);$(window).trigger("join.navi.push",[$this]);viewModel.doDebateStartIfNeed(viewModel,e);$(window).trigger("join.navi.focus");return false}return true};this.doDebateStartIfNeed=function(viewModel,event){var btn=$(event.currentTarget);var sideType=btn.attr("data-sideType");viewModel.doDebateStart(viewModel,event);viewModel.currentSideType(sideType);var curWidth=$(window).width();
if(curWidth<768)viewModel.activeFormViewVisible(false);var $list=$(".c-message-list").filter('[data-sideType\x3d"'+sideType+'"]');$list.addClass("c-show-mobile").siblings(".c-message-list").removeClass("c-show-mobile");$list.find("[data-mcb]").trigger("mcb-detect")};this.doDebateStart=function(viewModel,event){var btn=$(event.currentTarget);var sideType=btn.attr("data-sideType");viewModel.doDebateStartInner(viewModel,sideType)};this.doDebateStartInner=function(viewModel,sideType){var formView=viewModel.activeFormView();
var currentSideType=formView.sideType();if(formView==null)return;if(viewModel.activeFormViewVisible()==true&&currentSideType==sideType){viewModel.activeFormViewVisible(false);return}formView.sideType(sideType);viewModel.activeFormViewVisible(true);viewModel.activeFormView().isVisible(true)};this.cancelDebate=function(){self.activeFormViewVisible(false);return};this.cancelFormView=function(){self.activeFormViewVisible(false);return};this.imageAltEditorView=new ImageAltEditorView;this.linkEditorView=
new LinkEditorView;this.spamRemarkEditorView=new DeleteRemarkEditorView({container:"#spamRemarkContainer",saveType:"spam"});this.deleteRemarkEditorView=new DeleteRemarkEditorView({container:"#deleteRemarkContainer",saveType:"del"});this.blackListEditorView=new BlackListEditorView;this.scoreView=new BoardScoreView;this.detectAreaNeedToShow=function(){if(this.isEnabled()){this.showAreaHeader(true);this.showAreaMessage(true);return}var hasAnyData=false;if(this.viewType==BoardViewType.Debate)hasAnyData=
this.leftMessageListView.hasData()||this.rightMessageListView.hasData();else if(this.viewType==BoardViewType.Basic)hasAnyData=this.messageListViewMap.basic.hasData();if(hasAnyData){this.showAreaHeader(true);this.showAreaMessage(true);return}this.showAreaHeader(false);this.showAreaMessage(false)};this.firstLoadmaskView=new SimpleLoadmaskView;this.init=function(){if(this.viewType==BoardViewType.Debate){this.activeFormViewVisible(false);this.firstLoadmaskView.show(true);var firstCalls=[this.leftMessageListView.firstCall(),
this.rightMessageListView.firstCall(),this.scoreView.firstCall()];$.when.apply($,firstCalls).then(function(){self.detectAreaNeedToShow();self.firstLoadmaskView.show(false);redoMessageEllipsis($(".cHtmlEllipsis"))})}else if(this.viewType==BoardViewType.Basic){this.currentMessageView(this.messageListViewMap.basic);this.activeFormViewVisible(false);this.firstLoadmaskView.show(true);var firstCalls=[this.messageListViewMap.basic.firstCall()];$.when.apply($,firstCalls).then(function(){self.detectAreaNeedToShow();
self.firstLoadmaskView.show(false);redoMessageEllipsis($(".cHtmlEllipsis"))})}return this};this.init()}
function BoardScoreView(data){var exData=$.extend({voteCount:0,messageCount:0,positiveCount:0,negativeCount:0},data);this.voteCount=ko.observable(exData.voteCount);this.messageCount=ko.observable(exData.messageCount);this.positiveCount=ko.observable(exData.positiveCount);this.negativeCount=ko.observable(exData.negativeCount);this.voteCountText=ko.pureComputed(function(){return this.voteCount()},this);this.messageCountText=ko.pureComputed(function(){return this.messageCount()},this);this.positiveCountText=
ko.pureComputed(function(){var count=this.positiveCount(),base=1E3;if(count>=base)return Math.floor(count/base)+"K+";return this.positiveCount()},this);this.negativeCountText=ko.pureComputed(function(){var count=this.negativeCount(),base=1E3;if(count>=base)return Math.floor(count/base)+"K+";return this.negativeCount()},this);this.calculatePercentage=function(value,divisor){if(divisor==0)return 0;var percentage=Math.round(value/divisor*100);return percentage};this.positivePercentage=ko.pureComputed(function(){return"50%"},
this);this.negativePercentage=ko.pureComputed(function(){return"50%"},this);this.positivePercentageTip=ko.pureComputed(function(){return"贊成論點有"+this.positiveCount()+"則"},this);this.negativePercentageTip=ko.pureComputed(function(){return"其他想法有"+this.negativeCount()+"則"},this);this.styleDisplay=function(val){if(val==0)return"none";return"block"};this.styleDisplayPositive=ko.pureComputed(function(){return this.styleDisplay(this.positiveCount())},this);this.styleDisplayNegative=ko.pureComputed(function(){return this.styleDisplay(this.negativeCount())},
this);this.onCompleteAddMessage=function(msgViewModel){var sideType="";if(typeof msgViewModel.sideType==="function")sideType=msgViewModel.sideType();if(sideType==="")return;if(sideType==="Positive")_increaseObservableNumber(this.positiveCount);else if(sideType=="Negative")_increaseObservableNumber(this.negativeCount);_increaseObservableNumber(this.messageCount)};this.onCompleteDelMessage=function(msgViewModel){var sideType="";if(typeof msgViewModel.sideType==="function")sideType=msgViewModel.sideType();
if(sideType==="")return;var isStop=true;if(isStop)return;if(sideType==="Positive")_decreaseObservbleNumber(this.positiveCount);else if(sideType==="Negative")_decreaseObservbleNumber(this.negativeCount);_decreaseObservbleNumber(this.messageCount)};this.onCompleteVote=function(value){_increaseObservableNumber(this.voteCount,value)};this.fetchCall=function(){return $.ajax({type:"GET",url:joinCommentsUrl["score"],data:{ct:(new Date).getTime()},contentType:"application/json",viewModel:this,success:function(resp){if(!resp.success)return;
this.viewModel.loadData(resp.result)}})};this.loadData=function(scoreData){this.voteCount(scoreData.voteCount);this.messageCount(scoreData.messageCount);this.positiveCount(scoreData.positiveCount);this.negativeCount(scoreData.negativeCount)};this.firstCall=function(){return this.fetchCall()}}
function MessageListView(data,tmpBoardView){var tmpSortId=tmpBoardView.subjectType()=="policy_scholar"?"boardSortSlt_scholar":"boardSortSlt";var exData=$.extend({pageNumber:1,pageSize:20,sortEltId:tmpSortId,sideType:"",firstCallCompletedCallback:function(){}},data);var self=this;this.sideType=exData.sideType;this.list=ko.observableArray([]);this.hasData=ko.pureComputed(function(){return this.list().length>0},this);this.hasMoreData=ko.pureComputed(function(){return this.page.number()<this.page.totalPage()},
this);this.page={number:ko.observable(parseInt(exData.pageNumber)),size:ko.observable(parseInt(exData.pageSize)),total:ko.observable(0),totalCount:ko.observable(0),sortEltId:exData.sortEltId||tmpSortId,totalPage:ko.pureComputed(function(){var size=self.page.size();if(typeof size=="string")size=parseInt(size);return Math.ceil(self.page.totalCount()/size)},this),next:function(){var c=this.number()+1;if(c>this.total())c=this.total();this.number(c)},prev:function(){var c=this.number()-1;if(c<=1)c=1;this.number(c)}};
this.addMessage=function(msgView){var sideType="";if(msgView.sideType!=null&&typeof msgView.sideType=="function")sideType=msgView.sideType();if(this.sideType!=sideType)return;this.list.push(msgView)};this.addMessageAtFirst=function(msgView,opt){var sideType="";if(msgView.sideType!=null&&typeof msgView.sideType=="function")sideType=msgView.sideType();if(this.sideType!=sideType)return;this.list.splice(0,0,msgView);if(opt==null)opt={};if(opt.reloadSortByNew){var $btnWrap=$(".c-"+this.page.sortEltId);
if($btnWrap.length>0){var $sortBtn=$btnWrap.find('button[data-sortName\x3d"SortByNew"]');if(!$sortBtn.hasClass("active"))$sortBtn.trigger("click")}else{var sortOption=$("#"+this.page.sortEltId).find('option[data-sortName\x3d"SortByNew"]');if(sortOption.is(":selected"))return;sortOption.prop("selected",true);this.sortChangedCall()}}};this.firstCallDone=false;this.firstCall=function(){this.firstCallDone=false;this.loadmaskFrozen=true;this.page.number(0);this.page.total(0);return this.fetchMessage(this)};
this.sortChangedCall=function(){this.cleanCall()};this.cleanCall=function(){this.page.number(0);this.page.total(0);this.list([]);this.fetchMessage(this)};this.prevPageCall=function(viewModel,event){var btn=event!=null?$(event.currentTarget):null;viewModel.page.prev();viewModel.list([]);viewModel.fetchMessage(viewModel,event);return true};this.nextPageCall=function(viewModel,event){var btn=event!=null?$(event.currentTarget):null;viewModel.page.next();viewModel.list([]);viewModel.fetchMessage(viewModel,
event);return true};this.goPageCall=function(viewModel,event){var btn=event!=null?$(event.currentTarget):null;viewModel.list([]);viewModel.fetchMessage(viewModel,event);_scrollMoveToElt("#joinBoardContainer");return true};this.readMorePage=function(viewModel,event){if(!viewModel.hasMoreData())return;viewModel.moreMessageCall(viewModel,event)};this.moreMessageCall=function(viewModel,event){var btn=event!=null?$(event.currentTarget):null;viewModel.page.next();viewModel.fetchMessage(viewModel,event,
{fireButton:btn})};this.fetchMessage=function(viewModel,event,opt){var fireButton=opt!=null?opt.fireButton:null;var url=joinCommentsUrl["message"].toSubstitution({sideType:viewModel.sideType});if(tmpBoardView.subjectType()=="policy_scholar")url=joinCommentsUrlScholar["message"].toSubstitution({sideType:viewModel.sideType});return $.ajax({url:url,type:"GET",data:{page:viewModel.page.number(),size:viewModel.page.size(),sort:$("#"+viewModel.page.sortEltId).val(),ct:(new Date).getTime()},contentType:"application/json",
viewModel:viewModel,beforeSend:function(){viewModel.loadmask(fireButton)},complete:function(){viewModel.loadunmask(fireButton);if(viewModel.firstCallDone==false){viewModel.firstCallDone=true;viewModel.loadmaskFrozen=false}},success:function(resp){if(!resp.success)return;this.viewModel.page.number(resp.currentPage);this.viewModel.page.total(resp.totalPages);this.viewModel.page.totalCount(resp.totalResults);if(resp.surplusResults>0)if(tmpBoardView.subjectType()=="policy_scholar")$("#moreMsgBtn_schoar").show();
else $("#moreMsgBtn").show();else if(tmpBoardView.subjectType()=="policy_scholar")$("#moreMsgBtn_schoar").hide();else $("#moreMsgBtn").hide();var viewModel=this.viewModel;$.each(resp.result,function(idx,item){viewModel.addMessage(new MessageViewModel(item,tmpBoardView))})},error:function(resp){}})};this.simpleLoadmaskView=new SimpleLoadmaskView;this.loadmaskFrozen=false;this.loadmask=function(btn){if(self.loadmaskFrozen)return;var containerId,btnId;if(tmpBoardView.subjectType()=="policy_scholar"){containerId=
"#boardLoadmaskContainer_scholar";btnId="#moreMsgBtn_schoar"}else{containerId="#boardLoadmaskContainer";btnId="#moreMsgBtn"}if(!btn){var $cont1=$(containerId);if($cont1.length>0){(new Spinner({position:"relative"})).spin($cont1.show()[0]);$(btnId).hide()}self.simpleLoadmaskView.show(true);return}(new Spinner({position:"relative"})).spin(btn.parent()[0]);btn.hide()};this.loadunmask=function(btn){if(self.loadmaskFrozen)return;var containerId,btnId;if(tmpBoardView.subjectType()=="policy_scholar"){containerId=
"#boardLoadmaskContainer_scholar";btnId="moreMsgBtn_schoar"}else{containerId="#boardLoadmaskContainer";btnId="moreMsgBtn"}if(!btn){$(containerId).hide().find(".spinner").remove();self.simpleLoadmaskView.show(false);return}var container=btn.parent();container.find(".spinner").remove();if(btn.attr("id")!=btnId)btn.show()};this.sortChanged=function(viewModel,event){viewModel.sortChangedCall()};this.prevPageVisible=ko.pureComputed(function(){return this.page.number()>1},this);this.enablePrevPageTrigger=
ko.pureComputed(function(){return this.nextPageVisible()},this);this.nextPageVisible=ko.pureComputed(function(){return this.page.number()<this.page.total()},this);this.enableNextPageTrigger=ko.pureComputed(function(){return this.nextPageVisible()},this);this.paginationInfo=ko.pureComputed(function(){var num=this.page.number();var total=this.page.total();if(total==0)num=0;return"第"+num+"頁；共"+total+"頁"},this)}
function MessageViewModel(data,tmpBoardView){var self=this;this.boardView=tmpBoardView;this.insertMessage=function(viewModel,msgData){if(msgData==null)return;var index=$.inArray(viewModel,self.replyMessages());var m=new MessageViewModel(msgData,tmpBoardView);m.parentViewModel=self;self.replyMessages.splice(index+1,0,m)};var wordFilter=boardWordFilter.split(",");if(data.author&&data.author.displayName){var useDisplayName=data.author.displayName;if(data.fixNickname===1&&!_.isNil(data.queryNickname))useDisplayName=
data.queryNickname;var tn=useDisplayName;$.each(wordFilter,function(idx,item){var reg=new RegExp(item,"ig");tn=tn.replace(reg,"***")});data.author.displayName=tn}ko.mapping.fromJS(data,{"replyMessages":{create:function(options){var m=new MessageViewModel(options.data,tmpBoardView);m.parentViewModel=options.parent;return m}},"links":{create:function(options){var m=new RdqLinkViewModel(options.data);return m}},"images":{create:function(options){var m=new RdqImageViewModel(options.data);return m}}},
this);this.urlTextReplace=function(text){var stopFlag=true;if(stopFlag)return;var alist=text.match(/<a[^>]*>([\s\S]*?)<\/a>/gi);var html=$.parseHTML(text);$.each(html,function(i,elt){var $elt=$(elt);var href=$elt.text();var pattern=/^((http|https):\/\/)/;if(pattern.test(href)===false)return;var oldTag;$.each(alist,function(i,obj){if(obj.indexOf(href)>0)oldTag=obj});$.base64.utf8encode=true;$.ajax({url:contextPath+"/api/remotePageTitle",headers:{"x-join-token":$.base64.btoa(href)},data:{url:href},
success:function(resp){if(!resp.success)return;var title=resp.result||"";$elt.text(title)},complete:function(){var newTag=$elt[0].outerHTML;var msg=self.content4Html();msg=msg.replace(oldTag,newTag);self.content4Html(msg)}})})};self.urlTextReplace(self.content4Html());this.isScholar=ko.pureComputed(function(){return self.identity()==="scholar"},this);this.overlayLoadmaskView=new SimpleLoadmaskView;this.editMessageLoadmaskView=new SimpleLoadmaskView;this.overlayLoadmaskStart=function(){this.overlayLoadmaskView.show(true);
this.editMessageLoadmaskView.show(true)};this.overlayLoadmaskStop=function(){this.overlayLoadmaskView.show(false);this.editMessageLoadmaskView.show(false)};this.page={number:ko.observable(1),size:ko.observable(10)};this.templateToUse=function(){if(self.displayStyle()=="normal")return"templateMessageContent";else if(self.displayStyle()=="pending")return"templateMessageContentPending";else if(self.displayStyle()=="spam")return"templateMessageContentSpam";else if(self.displayStyle()=="deleted")return"templateMessageContentDeleted";
else if(self.displayStyle()=="deleteByAdmin")return"templateMessageContentDeleteByAdmin";else if(self.displayStyle()=="black")return"templateMessageContentBlack";else if(self.displayStyle()=="editing"){self.activeFormView(self.editingFormView);return"templateMessageContentEditing"}};this.afterRenderMessageShowTemplate=function(elts){if(self.displayStyle()=="editing")self.activeFormView().init();setupLinkTitleFromRemote(elts)};this.afterRenderMessageCallback=function(elts){setupAuthorImageLazyload($("img.j-lazyload"))};
this.checkAuthorPicture=function(element){if(self.author.profilePicture())return self.author.profilePicture();else return $(element).attr("data-original")};this.likeRemoveAction=function(viewModel,event){if(self.liked()==false)return;if(!_checkUserIsLogin(tmpBoardView)){alert("請先登入後才能回收讚");return}var ajaxReqs=[$.ajax({url:joinCommentsUrl["likeRemove"].toSubstitution({"message_uid":self.msgUid()}),type:"POST",contextPath:"application/json",success:function(resp){if(!resp.success){alert("回收讚失敗");return}self.liked(false);
var after=self.likeCount()-1;if(after<0)after=0;self.likeCount(after)},error:function(resp){alert("回收讚失敗")}})];$.when.apply($,ajaxReqs).then(function(){})};this.likeAction=function(viewModel,event){if(self.liked())return;if(!_checkUserIsLogin(tmpBoardView)){alert("請先登入後才能按讚");return}var ajaxReqs=[$.ajax({url:joinCommentsUrl["like"].toSubstitution({"message_uid":self.msgUid()}),type:"POST",contextPath:"application/json",success:function(resp){if(!resp.success){alert("按讚失敗");return}self.liked(true);
self.likeCount(self.likeCount()+1)},error:function(resp){alert("按讚失敗")}})];$.when.apply($,ajaxReqs).then(function(){})};this.genMsgUid=function(){return"rdqMsg"+self.msgUid()};this.shareAction=function(viewModel,event){var target=$(event.currentTarget).siblings(".rdq_sharepop").toggleClass("opened");$("body").unbind("click",self.closeShareBox);if(target.hasClass("opened"))$("body").bind("click",{showBoxElement:target},self.closeShareBox);target.find("a.facebook,a.googleplus").each(function(index){var $this=
$(this);var shareUrl=$this.attr("data-base-url")+"#"+self.genMsgUid();$this.attr("href",shareUrl)})};this.closeShareBox=function(event){var $target=$(event.target);var box=event.data.showBoxElement;var btn=box.siblings("button");if($target.is(box)||$target.is(btn))return;box.removeClass("opened");$("body").unbind("click",self.closeShareBox)};this.isReported=ko.observable(true);this.reportBtnText=ko.computed(function(){if(self.isReported())return"已檢舉過";else return"檢舉為不當發言"},this);this.reportAction=
function(viewModel,event){if(!_checkUserIsLogin(tmpBoardView)){alert("請先登入才能檢舉為不當留言");return}if(!confirm("確定要檢舉為不當留言"))return;var ajaxReqs=[$.ajax({url:joinCommentsUrl["report"].toSubstitution({"message_uid":self.msgUid()}),type:"POST",contextPath:"application/json",success:function(resp){if(!resp.success){alert(resp.result);return}alert("已成功檢舉");if(resp.result.status==="REPORT_PENDING")self.displayStyle("pending")},error:function(resp){alert("檢舉失敗")}})];$.when.apply($,ajaxReqs).then(function(){})};
this.spamAction=function(viewModel,event){if(!confirm("確定要標示為垃圾訊息？"))return;var ajaxReqs=[$.ajax({url:joinCommentsUrl["spam"].toSubstitution({"message_uid":self.msgUid()}),type:"POST",data:JSON.stringify({"boardUid":tmpBoardView.boardUid(),"remark":self.remark()}),contentType:"application/json",success:function(resp){if(!resp.success){alert("標示為垃圾訊息失敗");return}self.deleteRemark(self.remark());self.displayStyle("spam");self.closeRemarkBox();if(tmpBoardView.scoreView)tmpBoardView.scoreView.onCompleteDelMessage(self)},
error:function(resp){alert("標示為垃圾訊息失敗")}})];$.when.apply($,ajaxReqs).then(function(){})};this.delAction=function(viewModel,event){if(!confirm("確定要刪除訊息？"))return;var ajaxReqs=[$.ajax({url:joinCommentsUrl["del"].toSubstitution({"message_uid":self.msgUid()}),type:"POST",data:JSON.stringify({"boardUid":tmpBoardView.boardUid(),"remark":self.remark()}),contentType:"application/json",beforeSend:function(){self.overlayLoadmaskStart()},complete:function(){self.overlayLoadmaskStop()},success:function(resp){if(!resp.success){alert("刪除訊息失敗");
return}self.deleteRemark(self.remark());self.displayStyle("deleteByAdmin");self.closeRemarkBox();if(tmpBoardView.scoreView)tmpBoardView.scoreView.onCompleteDelMessage(self)},error:function(resp){alert("刪除訊息失敗")}})];$.when.apply($,ajaxReqs).then(function(){})};this.blackBoxFlag={userName:ko.observable(false),userEmail:ko.observable(false),ip:ko.observable(false),retroactivity:ko.observable(false),toParam:function(){var p=[];if(this.userName())p.push(this.toItem("User_Uid",self.author.userUid()));if(this.userEmail())p.push(this.toItem("User_Email",
self.author.userEmail()));if(this.ip())p.push(this.toItem("Request_IP",self.requestIp()));return p},toItem:function(key,val){return{"targetType":key,"targetValue":val,"retroactivity":this.retroactivity()?"Y":"N"}}};this.blackBoxText={displayName:ko.computed(function(){if(self.anonymous())return self.author.displayName()+"(訪客不適用)";return self.author.displayName()}),userEmail:ko.computed(function(){if(self.author.userEmail()=="")return self.author.userEmail()+"(沒有email，故停用)";return self.author.userEmail()})};
this.showBlackBox=ko.observable(false);this.openBlackBox=function(viewModel,event){if(self.remarkBoxOpened())self.closeRemarkBox();self.showBlackBox(true);self.remark("")};this.closeBlackBox=function(viewModel,event){self.showBlackBox(false)};this.validateBeforeBlackAction=function(){var blackData=self.blackBoxFlag.toParam();if(blackData.length==0){alert("請至少選擇一項規則");return false}return true};this.blackAction=function(viewModel,event){if(self.validateBeforeBlackAction()==false)return;var btn=$(event.currentTarget),
btnContainer=btn.parents("div.black_people");var ajaxReqs=[$.ajax({url:joinCommentsUrl["blacklist"],type:"POST",data:JSON.stringify({boardUid:tmpBoardView.boardUid(),msgUid:self.msgUid(),black:self.blackBoxFlag.toParam(),remark:self.remark()}),contentType:"application/json",beforeSend:function(){if(btnContainer.length>0){btnContainer.children().hide();(new Spinner({position:"relative"})).spin(btnContainer[0]);return}self.overlayLoadmaskStart()},complete:function(){if(btnContainer.length>0){btnContainer.find(".spinner").remove();
btnContainer.children().show();return}self.overlayLoadmaskStop()},success:function(resp){if(!resp.success){alert("加到黑名單失敗");return}alert("加到黑名單成功");self.deleteRemark(self.remark());self.displayStyle("black");if(tmpBoardView.scoreView)tmpBoardView.scoreView.onCompleteDelMessage(self)},error:function(resp){alert("加到黑名單失敗")}})];$.when.apply($,ajaxReqs).then(function(){})};this.replyBtnText=ko.observable("回覆");this.replyBoxOpened=ko.observable(false);this.toggleReplyBox=function(viewModel,event){if(self.replyBoxOpened())self.closeReplyBox();
else{self.replyBoxOpened(true);self.replyBtnText("取消回覆");self.replyFormWrapper.activeFormView.show();self.replyFormWrapper.visibleLoginForm(true)}};this.closeReplyBox=function(){self.replyBoxOpened(false);self.replyBtnText("回覆");self.postContent("");self.replyFormWrapper.activeFormView.hide();self.replyFormWrapper.visibleLoginForm(false)};this.postMessageLoadmaskView=new SimpleLoadmaskView;this.replyAction=function(form){var p=$(form).form2json();if(!validPostMessageParam(p,tmpBoardView))return;var targetMsgUid=
self.msgUid();if(self.parentViewModel){targetMsgUid=self.parentViewModel.msgUid();p.replyMsgUid=self.msgUid()}var ajaxReqs=[$.ajax({url:joinCommentsUrl["reply"].toSubstitution({message_uid:targetMsgUid}),type:"POST",data:JSON.stringify(p),contentType:"application/json",beforeSend:function(){self.postMessageLoadmaskView.show(true)},complete:function(){self.postMessageLoadmaskView.show(false)},success:function(resp){if(!resp.success){alert("回覆留言失敗 "+resp.result);return}if(self.parentViewModel)self.parentViewModel.insertMessage(self,
resp.result);else{var m=new MessageViewModel(resp.result,tmpBoardView);m.parentViewModel=self;self.replyMessages.splice(0,0,m)}self.closeReplyBox();_reloadPageOverDay(self.boardView.boardLoadTimestamp)},error:function(resp){alert("回覆留言失敗")}})];$.when.apply($,ajaxReqs).then(function(){})};this.replyActionV2=function(form,reqData,formView){var targetMsgUid=self.msgUid();if(self.parentViewModel){targetMsgUid=self.parentViewModel.msgUid();reqData.replyMsgUid=self.msgUid()}if(tmpBoardView.subjectType()==
"policy")if(discussionType!="All")if(reqData.identity=="scholar"){alert("你無法使用此帳號留言");return}$.ajax({url:joinCommentsUrl["reply"].toSubstitution({message_uid:targetMsgUid}),type:"POST",data:JSON.stringify(reqData),contentType:"application/json",beforeSend:function(){formView.loadmaskStart(form);self.postMessageLoadmaskView.show(true)},complete:function(){formView.loadmaskStop(form);self.postMessageLoadmaskView.show(false)},success:function(resp){if(!resp.success){alert("回覆留言失敗 "+resp.result);formView.clearVCodeIfNeed();
return}if(self.parentViewModel)self.parentViewModel.insertMessage(self,resp.result);else{var m=new MessageViewModel(resp.result,tmpBoardView);m.parentViewModel=self;self.replyMessages.splice(0,0,m)}self.closeReplyBox();_reloadPageOverDay(self.boardView.boardLoadTimestamp)},error:function(resp){alert("回覆留言失敗")}})};this.loadmask=function(btn){(new Spinner({position:"relative"})).spin(btn.parent()[0]);btn.hide()};this.loadunmask=function(btn){var container=btn.parent();container.find(".spinner").remove()};
this.loadmaskInContainer=function(container){if(container.length>0){container.children().hide();(new Spinner({position:"relative"})).spin(container[0]);return}};this.loadunmaskInContainer=function(container){if(container.length>0){container.find(".spinner").remove();container.children().show();return}};this.moreReplyMessage=function(viewModel,event){if(!self.parentViewModel)return;var btn=$(event.currentTarget);var tmpSortId=tmpBoardView.subjectType()=="policy_scholar"?"#replyListSortType_scholar":
"#replyListSortType";var ajaxReqs=[$.ajax({url:joinCommentsUrl["moreReply"].toSubstitution({message_uid:self.parentViewModel.msgUid()}),type:"GET",data:{page:self.parentViewModel.page.number()+1,sort:$(tmpSortId).val()},contentType:"application/json",moreBtn:event.currentTarget,beforeSend:function(){self.loadmask(btn)},complete:function(){self.loadunmask(btn)},success:function(resp){if(!resp.success){alert("取得更多回覆留言失敗");return}self.parentViewModel.page.number(resp.currentPage);for(var i=0;i<resp.result.length;i++){var m=
new MessageViewModel(resp.result[i],tmpBoardView);m.parentViewModel=self.parentViewModel;self.parentViewModel.replyMessages.push(m)}$(this.moreBtn).hide();self.parentViewModel.hasMoreReply(resp.totalPages>resp.currentPage)},error:function(resp){alert("取得更多回覆留言失敗")}})];$.when.apply($,ajaxReqs).then(function(){})};this.postContent=ko.observable("");this.postMessage=function(form){self.replyAction(form)};this.toggleModifyBox=function(viewModel,event){var target=$(event.currentTarget).parents("div.message_edit").toggleClass("open");
$("body").unbind("click",self.closeModifyBox);if(target.hasClass("open"))$("body").bind("click",{showBoxElement:target},self.closeModifyBox)};this.closeModifyBox=function(event){var $target=$(event.target);var box=event.data.showBoxElement;var btn=box.find("button");if($target.is(box)||$target.is(btn))return;box.removeClass("open");$("body").unbind("click",self.closeModifyBox)};this.toggleEditBox=function(viewModel,event){var style=self.displayStyle();if(style=="normal")style="editing";else if(style==
"editing")style="normal";self.displayStyle(style)};this.editMessage=function(form){var p=$(form).form2json();if(!validPostMessageParam(p,tmpBoardView))return;var container=$(form).parents("div.message_show");var ajaxReqs=[$.ajax({url:joinCommentsUrl["editBySelf"].toSubstitution({message_uid:self.msgUid()}),type:"POST",data:JSON.stringify(p),contentType:"application/json",beforeSend:function(){self.loadmaskInContainer(container)},complete:function(){self.loadunmaskInContainer(container)},success:function(resp){if(!resp.success){alert("編輯留言失敗");
return}var msg=resp.result;self.content4Html(msg.content4Html);self.displayStyle("normal")},error:function(resp){alert("編輯留言失敗")}})];$.when.apply($,ajaxReqs).then(function(){})};this.editMessageV2=function(form,reqData,formView){if(!self.boardView.checkBeforeEndTime()){alert("討論版已暫停討論");window.location.reload();return}var container=$(form).parents("div.message_show");$.ajax({url:joinCommentsUrl["editBySelf"].toSubstitution({message_uid:self.msgUid()}),type:"POST",data:JSON.stringify(reqData),contentType:"application/json",
beforeSend:function(){self.loadmaskInContainer(container);self.overlayLoadmaskStart();formView.loadmaskStart(form)},complete:function(){self.loadunmaskInContainer(container);self.overlayLoadmaskStop();formView.loadmaskStop(form)},success:function(resp){if(!resp.success){if(resp.result.indexOf("code:-106")>-1){alert("編輯留言失敗 討論版已暫停討論");window.location.reload();return}alert("編輯留言失敗");return}var msg=resp.result;self.oriContent(msg.oriContent);self.content4Html(msg.content4Html);self.images([]);$.each(msg.images,
function(i,item){self.images.push(new RdqImageViewModel(item))});self.links([]);$.each(msg.links,function(i,item){self.links.push(new RdqLinkViewModel(item))});self.displayStyle("normal");formView.hide();self.createEditingFormView()},error:function(resp){alert("編輯留言失敗")}})};this.removeAction=function(viewModel,event){if(!confirm("確定要刪除此留言？"))return;if(!self.boardView.checkBeforeEndTime()){alert("討論版已暫停討論");window.location.reload();return}var container=$(event.currentTarget).parents("div.message_show");
var ajaxReqs=[$.ajax({url:joinCommentsUrl["removeBySelf"].toSubstitution({message_uid:self.msgUid()}),type:"DELETE",contentType:"application/json",beforeSend:function(){self.loadmaskInContainer(container);self.overlayLoadmaskStart()},complete:function(){self.loadunmaskInContainer(container);self.toggleModifyBox(self,event);self.overlayLoadmaskStop()},success:function(resp){if(!resp.success){if(resp.result.indexOf("code:-106")>-1){alert("刪除留言失敗 討論版已暫停討論");window.location.reload();return}alert("刪除留言失敗");
return}self.displayStyle("deleted");if(tmpBoardView.scoreView)tmpBoardView.scoreView.onCompleteDelMessage(self)},error:function(resp){alert("刪除留言失敗")}})];$.when.apply($,ajaxReqs).then(function(){})};this.visibleLoginForm=ko.observable(false);this.focusPostContent=function(){self.visibleLoginForm(true)};this.visibleAnonymousLogin=ko.observable(false);this.openAnonymousLogin=function(){var b=self.visibleAnonymousLogin();self.visibleAnonymousLogin(!b)};this.hasImages=ko.pureComputed(function(){return self.images().length>
0});this.hasLinks=ko.pureComputed(function(){return self.links().length>0});this.activeFormView=ko.observable();this.editingFormView=null;this.createEditingFormView=function(){this.editingFormView=new RdqFormViewModel({formId:self.msgUid(),formType:"edit",oriContent:self.oriContent(),images:self.images(),links:self.links(),sideType:self.sideType==null?"":self.sideType(),onCloseForm:function(){self.toggleEditBox()},onFormSubmit:self.editMessageV2},tmpBoardView)};this.createEditingFormView();this.replyFormWrapper=
{postMessageLoadmaskView:self.postMessageLoadmaskView,activeFormView:new RdqFormViewModel({formId:self.msgUid(),formType:"reply",enableVCode:tmpBoardView.enableVCode,vCodeKey:tmpBoardView.vCodeKey,onCloseForm:function(){},onFormSubmit:self.replyActionV2},tmpBoardView),visibleLoginForm:ko.observable(false),cancelFormView:function(){self.toggleReplyBox()}};this.hasDeleteRemark=ko.pureComputed(function(){if(this.deleteRemark()==null)return false;return this.deleteRemark().length>0},this);this.deleteRemarkHtml=
ko.pureComputed(function(){if(this.deleteRemark()==null)return"";return this.deleteRemark().replace(/\n/g,"\x3cbr/\x3e")},this);this.remark=ko.observable("");this.isRemarkInputFocus=ko.observable(false);this.remarkBoxOpened=ko.observable(false);this.remarkBoxType=ko.observable("");this.remarkBoxPlaceholder=ko.pureComputed(function(){var text="請輸入刪除原因..";if(this.remarkBoxType()=="spam")text="請輸入標示為垃圾訊息原因..";return text},this);this.openRemarkBoxDiffType=function(viewModel,event){if(self.showBlackBox())self.closeBlackBox();
var $target=$(event.currentTarget);self.remarkBoxType($target.attr("data-remarkBoxType"));self.remark("");self.remarkBoxOpened(true);self.isRemarkInputFocus(true)};this.toggleRemarkBox=function(viewModel,event){var $target=$(event.currentTarget);if(self.remarkBoxOpened())self.closeRemarkBox();else{self.remarkBoxType($target.attr("data-remarkBoxType"));self.remarkBoxOpened(true);self.remark("")}};this.closeRemarkBox=function(){self.remarkBoxType("");self.remarkBoxOpened(false)};this.doSendRemarkBox=
function(viewModel,event){if(self.remarkBoxType()=="spam")self.spamAction(viewModel,event);else if(self.remarkBoxType()=="deleteByAdmin")self.delAction(viewModel,event)};this.voteLoadmaskStart=function(btn){self.overlayLoadmaskStart()};this.voteLoadmaskStop=function(btn){self.overlayLoadmaskStop()};this.agreeAction=function(viewModel,event){if(!_checkUserIsLogin(tmpBoardView)){alert("請先登入後才可使用贊同功能");redirectToLogin();return}if(self.agreed()){viewModel.removeAgreeAction(viewModel,event);return}var btn=
$(event.currentTarget);$.ajax({type:"POST",url:joinCommentsUrl["agree"].toSubstitution({"message_uid":self.msgUid()}),contentType:"application/json",viewModel:viewModel,beforeSend:function(){viewModel.voteLoadmaskStart(btn)},complete:function(){viewModel.voteLoadmaskStop(btn)},success:function(resp){if(!resp.success){alert("贊成失敗");return}var tc=1;if(this.viewModel.disagreed()){_decreaseObservbleNumber(this.viewModel.disagreeCount);tc--}_increaseObservableNumber(this.viewModel.agreeCount);tmpBoardView.scoreView.onCompleteVote(tc);
this.viewModel.loadOnVoteComplete(resp.result)},error:function(){alert("贊成失敗")}})};this.removeAgreeAction=function(viewModel,event){if(!_checkUserIsLogin(tmpBoardView)){alert("請先登入後才可使用回收贊同功能");redirectToLogin();return}if(!self.agreed()){alert("尚未贊成，無法執行");return}var btn=$(event.currentTarget);$.ajax({type:"POST",url:joinCommentsUrl["agreeRemove"].toSubstitution({"message_uid":self.msgUid()}),contentType:"application/json",viewModel:viewModel,beforeSend:function(){viewModel.voteLoadmaskStart(btn)},
complete:function(){viewModel.voteLoadmaskStop(btn)},success:function(resp){if(!resp.success){alert("回收贊成失敗");return}_decreaseObservbleNumber(this.viewModel.agreeCount);tmpBoardView.scoreView.onCompleteVote(-1);this.viewModel.loadOnVoteComplete(resp.result)},error:function(){alert("回收贊成失敗")}})};this.disagreeAction=function(viewModel,event){if(!_checkUserIsLogin(tmpBoardView)){alert("請先登入後才可使用反對功能");redirectToLogin();return}if(self.disagreed()){viewModel.removeDisagreeAction(viewModel,event);return}var btn=
$(event.currentTarget);$.ajax({type:"POST",url:joinCommentsUrl["disagree"].toSubstitution({"message_uid":self.msgUid()}),contentType:"application/json",viewModel:viewModel,beforeSend:function(){viewModel.voteLoadmaskStart(btn)},complete:function(){viewModel.voteLoadmaskStop(btn)},success:function(resp){if(!resp.success){alert("反對失敗");return}var tc=1;if(this.viewModel.agreed()){_decreaseObservbleNumber(this.viewModel.agreeCount);tc--}_increaseObservableNumber(this.viewModel.disagreeCount);tmpBoardView.scoreView.onCompleteVote(tc);
this.viewModel.loadOnVoteComplete(resp.result)},error:function(){alert("反對失敗")}})};this.removeDisagreeAction=function(viewModel,event){if(!_checkUserIsLogin(tmpBoardView)){alert("請先登入後才可使用回收反對功能");redirectToLogin();return}if(!self.disagreed()){alert("尚未反對，無法執行");return}var btn=$(event.currentTarget);$.ajax({type:"POST",url:joinCommentsUrl["disagreeRemove"].toSubstitution({"message_uid":self.msgUid()}),contentType:"application/json",viewModel:viewModel,beforeSend:function(){viewModel.voteLoadmaskStart(btn)},
complete:function(){viewModel.voteLoadmaskStop(btn)},success:function(resp){if(!resp.success){alert("回收反對失敗");return}_decreaseObservbleNumber(this.viewModel.disagreeCount);tmpBoardView.scoreView.onCompleteVote(-1);this.viewModel.loadOnVoteComplete(resp.result)},error:function(){alert("回收反對失敗")}})};this.loadOnVoteComplete=function(data){this.agreed(data.agreed);this.disagreed(data.disagreed);this.voted(data.voted)};this.agreeButtonText=ko.pureComputed(function(){return this.agreed()?"贊成":"贊成"},this);
this.disagreeButtonText=ko.pureComputed(function(){return this.disagreed()?"反對":"反對"},this);this.agreeBtnTitle=ko.pureComputed(function(){return this.agreed()?"點擊取消贊成此留言":"點擊贊成此留言"},this);this.disagreeBtnTitle=ko.pureComputed(function(){return this.disagreed()?"點擊取消反對此留言":"點擊反對此留言"},this);this.sideFloorNumberText=ko.pureComputed(function(){if(this.sideFloorNumberText==null)return"";return"#"+this.sideFloorNumber()+"\x26nbsp;"},this);this.isSideTypePositive=ko.pureComputed(function(){if(!this["sideType"])return false;
return this.sideType()==="Positive"},this);this.isSideTypeNegative=ko.pureComputed(function(){if(!this["sideType"])return false;return this.sideType()==="Negative"},this)}function FileItemView(file){var self=this;this.fileData=file;this.title=ko.observable("");this.name=ko.pureComputed(function(){if(self.fileData==null)return"";return self.fileData.name},this)}
function RdqLinkViewModel(data){if(data==null)data={};data=$.extend({uid:generateRdqLinkId(),url:""},data);ko.mapping.fromJS(data,{},this);this.urlElementId=ko.pureComputed(function(){return"rdqlink_"+this.uid()},this);this.aText=ko.pureComputed(function(){var n=this.name();if(n=="")n=this.url();return n},this);this.aHref=ko.pureComputed(function(){return this.url()},this);this.aTitle=ko.pureComputed(function(){var n=this.title();if(n=="")n=this.url();return"點擊另開視窗前往"+n},this)}
function RdqImageViewModel(data){var self=this;ko.mapping.fromJS(data,{},this);this.imgSrc=ko.pureComputed(function(){return this.url()},this);this.imgTitle=ko.pureComputed(function(){return this.title()},this);this.imgAlt=ko.pureComputed(function(){return this.title()},this);this.previewFileName=ko.pureComputed(function(){return this.name()},this);this.hasPreviewFileName=ko.observable(false);this.showFileNameForPreview=function(file){this.hasPreviewFileName(true)};this.showPreview=function(file){var fileObj=
null;var showFileNameMode=false;try{fileObj=file.getSource().getSource();if(fileObj==null){self.showFileNameForPreview(file);return}var reader=new FileReader;reader.onload=function(ent){self.url(ent.target.result)};reader.onerror=function(){self.showFileNameForPreview(file)};reader.readAsDataURL(fileObj)}catch(ex){self.showFileNameForPreview(file)}}}
function RdqFormViewModel(data,tmpBoardView){if(data==null)data={};this.option=$.extend({formId:generateFormId(),formType:"post",oriContent:"",images:[],links:[],sideType:"",onFormSubmit:function(form,reqData,formView){},onCloseForm:function(){},tmpBoardView:tmpBoardView,enableVCode:false,vCodeKey:""},data);var self=this;this.form=null;this.formType=data.formType;this.formId=ko.observable("form_"+this.option.formType+"_"+this.option.formId);this.isVisible=ko.observable(false);this.visibleAdditionBox=
ko.observable(false);this.postContent=ko.observable("");this.oriContent=ko.observable(data.oriContent);this.imagesEditing=ko.observableArray([]);this.linksEditing=ko.observableArray([]);this.rdqImageUploader=null;this.rdqImageUploaderId=ko.observable("rdqImageUploder_"+this.option.formType+"_"+this.option.formId);this.rdqImageUploaderContainer=null;this.rdqImageUploadFile=ko.observableArray([]);this.sideType=ko.observable(this.option.sideType);this.showSendButton=ko.observable(false);this.onFireAgreementByLabel=
function(viewModel,event){if(event.type==="keydown"&&event.keyCode===13){event.preventDefault();var $target=$(event.target);var chkId=$target.attr("for");if(chkId==null||chkId==="")return;$("#"+chkId).trigger("click");return false}return true};this.onFireAgreement=function(viewModel,event){var $elt=$(event.currentTarget);var isChecked=$elt.prop("checked");self.showSendButton(isChecked===true)};this.isVisible.subscribe(function(newValue){if(newValue)self.show();else self.hide()});this.hasRdqImages=
ko.pureComputed(function(){return self.rdqImages().length>0});this.hasImagesEditing=ko.pureComputed(function(){return self.imagesEditing().length>0});this.isEmptyImagesEditing=ko.pureComputed(function(){return self.imagesEditing().length==0},this);this.hasLinksEditing=ko.pureComputed(function(){return self.linksEditing().length>0});this.loadmaskStart=function(form){var $form=$(form);var submitBtn=$form.find('button[type\x3d"submit"]');var loadmaskBtn=$form.find("button.cloadmask");if(loadmaskBtn.length==
0)return;submitBtn.hide();(new Spinner({position:"relative",scale:.5,top:"7px"})).spin(loadmaskBtn.show()[0])};this.loadmaskStop=function(form){var $form=$(form);var submitBtn=$form.find('button[type\x3d"submit"]');submitBtn.show();var loadmaskBtn=$form.find("button.cloadmask");if(loadmaskBtn.length==0)return;loadmaskBtn.hide().find(".spinner").remove()};this.doSubmit=function(form){var p=$(form).form2json();var boardView=self.option.tmpBoardView;if(self.option.enableVCode&&!validVCode(p))return;
if(!validPostMessageParam(p,boardView))return;if(!validImageUploader(self))return;if(!validLink(self))return;if(self.rdqImageUploader&&self.rdqImageUploader.files.length>0){self.loadmaskStart(form);self.rdqImageUploader.start();return}self.fireSubmit()};this.fireSubmit=function(){var form=$("#"+self.formId());var reqData=form.form2json();reqData.rdqImage=ko.mapping.toJS(self.imagesEditing);reqData.rdqLink=ko.mapping.toJS(self.linksEditing);reqData.sideType=self.sideType();reqData.vCodeAnswer=self.vCodeView.buildAnswer(reqData.vCode);
reqData.vCode=null;self.option.onFormSubmit(form[0],reqData,self)};this.clickSubmit=function(viewModel,event){var form=$(event.currentTarget).parents("form");viewModel.doSubmit(form[0])};this.focusPostContent=function(){self.isVisible(true)};this.openAdditionBox=function(event){var $target=$(event.currentTarget).addClass("on");var siblings=$target.siblings("p.visit_btn");var isOpened=siblings.hasClass("on");if(isOpened){siblings.removeClass("on");return}var b=self.visibleAdditionBox();var n=!b;self.visibleAdditionBox(n);
self.repositionUploader();if(!n)$target.removeClass("on")};this.openFilePickerKeydown=function(viewModel,event){if(!self.rdqImageUploader)return;if(event.keyCode==13){self.openFilePicker(viewModel,event);return false}return true};this.openFilePicker=function(viewModel,event){if(!self.rdqImageUploader)return;$(self.rdqImageUploader.settings.browse_button[0]).trigger("click")};this.doRemoveImageItem=function(rdqImageVM,event){self.imagesEditing.removeAll();self.rdqImageUploadFile.removeAll();self.rdqImageUploader.splice();
self.repositionUploader()};this.resetImagesEditing=function(){self.imagesEditing([])};this.resetLinksEditing=function(){self.linksEditing([])};this.vCodeView=new VCodeViewModel({vCodeKey:self.option.vCodeKey});this.vCodeValue=ko.observable("");this.vCodeImgSrc=ko.observable("");this.refreshVCodeImg=function(){self.vCodeImgSrc(self.vCodeView.remakeImgSrc())};this.playVCodeAudio=function(){if(self.vCodeView)self.vCodeView.playAudio()};this.clearVCodeIfNeed=function(){if(self.option.enableVCode!==true)return;
self.vCodeValue("");self.refreshVCodeImg()};this.onKeyDownVCode=function(vm,e){if(e.keyCode===13){e.preventDefault();e.stopPropagation();return false}return true};this.emptyVCode=function(){if(self.option.enableVCode!==true)return;self.vCodeValue("");self.vCodeImgSrc("")};this.init=function(){if(this.rdqImageUploader==null)this.createImageUploader();$.each(this.option.images,function(i,item){var obj=ko.mapping.fromJS(ko.mapping.toJS(item));self.imagesEditing.push(obj)});$.each(this.option.links,function(i,
item){var obj=new RdqLinkViewModel(item);self.linksEditing.push(obj)});if(this.linksEditing().length===0)this.linksEditing.push(new RdqLinkViewModel);this.showSendButton(false);if(this.option.enableVCode){this.vCodeView.isReady(true);this.refreshVCodeImg()}};this.show=function(){this.init();return this};this.hide=function(){var form=$("#"+this.formId());if(form.length>0)form[0].reset();this.rdqImageUploadFile.removeAll();this.resetImagesEditing();this.resetLinksEditing();if(self.rdqImageUploader)self.cleanImageUploader();
if(this.option.enableVCode)this.emptyVCode();return this};this.cleanAll=function(){self.hide();self.option.images=[];self.option.links=[]};this.doCloseForm=function(viewModel,event){self.hide();if(self.option.onCloseForm)self.option.onCloseForm()};this.onRdqImageAdded=function(file){self.rdqImageUploadFile.removeAll();self.rdqImageUploadFile.push(new FileItemView(file));self.imagesEditing.removeAll();var newImg=new RdqImageViewModel({fileId:file.id,url:"",name:file.name,title:file.name,isNewUpload:true,
imageUpload:null});self.imagesEditing.push(newImg);newImg.showPreview(file)};this.onRdqImageUploaded=function(file,resp){var rdqImageFile=ko.utils.arrayFirst(self.rdqImageUploadFile(),function(item){return item.fileData.id=file.id});self.rdqImageUploader.removeFile(file);if(rdqImageFile==null)rdqImageFile=new FileItemView;rdqImageFile.fileData=null;rdqImageFile.attachment=resp.result;var imagesEditingItem=ko.utils.arrayFirst(self.imagesEditing(),function(item){return item.fileId()==file.id});if(imagesEditingItem==
null&&self.imagesEditing().length>0)imagesEditingItem=ko.utils.arrayIndexOf(self.imagesEditing(),0);if(imagesEditingItem)imagesEditingItem.imageUpload(rdqImageFile);self.loadmaskStop();self.fireSubmit()};this.repositionUploader=function(){if(self.rdqImageUploader==null)return;if(self.visibleAdditionBox()==false)return;var $uploadBtn=$("#"+self.rdqImageUploaderId());var $container=self.rdqImageUploaderContainer;var pluploadContainer=$container.children("div");var pluploadBtn=$container.find("input").attr("tabindex",
"-1");var pluploadBtnSize={width:$uploadBtn.width(),height:$uploadBtn.height()};$container.css({position:"absolute",top:"0px",left:"0px",width:pluploadBtnSize.width,height:pluploadBtnSize.height,overflow:"hidden","z-index":5});pluploadContainer.css({position:"relative",top:"0px",left:"0px",width:pluploadBtnSize.width,height:pluploadBtnSize.height})};this.cleanImageUploader=function(){if(self.rdqImageUploader==null)return;if(typeof self.rdqImageUploader["destroy"]=="function");if(self.rdqImageUploaderContainer)self.rdqImageUploaderContainer.empty();
self.rdqImageUploader=null};this.createImageUploader=function(){var buttonId=self.rdqImageUploaderId();var $btn=$("#"+buttonId);self.rdqImageUploaderContainer=$btn.siblings("div.rdqImageInputContainer").attr("id",buttonId+"_container");var useContainer=null;if(self.rdqImageUploaderContainer.length>0)useContainer=self.rdqImageUploaderContainer[0];else useContainer=$btn.parent()[0];var uploader=new plupload.Uploader({runtimes:"html5",browse_button:buttonId,container:useContainer,url:joinCommentsUrl["uploadResource"],
multi_selection:false,filters:{max_file_size:"2mb",mime_types:[{title:"Image files",extensions:"jpg,png,jpeg"}]},koViewModel:self,init:{Init:function(up){var $container=$(up.settings.container);var $t=$container.children("div.moxie-shim-html5").each(function(idx,item){$(item).css({"top":0,"left":0})})},PostInit:function(up){},Browse:function(up){},FilesAdded:function(up,files){if(files==null||files.length==0)return;var koViewModel=up.settings.koViewModel;if(!koViewModel)return;if(up.files.length>
1)up.splice(0,up.files.length-1);koViewModel.onRdqImageAdded(files[0])},FileUploaded:function(up,file,info){var resp=$.parseJSON(info.response);if(!resp.success)return;up.settings.koViewModel.onRdqImageUploaded(file,resp)},UploadProgress:function(up,file){},Error:function(up,err){var msg=err.message;if(err.code==-600)msg+="檔案大小上限：2MB。";alert(msg)}}});uploader.init();self.rdqImageUploader=uploader};this.showImageAltEditor=function(viewModel,event){var a=viewModel.imagesEditing();if(a.length<1){alert("請先上傳圖片");
return}var firstImageView=a[0];tmpBoardView.imageAltEditorView.open(firstImageView)};this.showLinkEditor=function(viewModel,event){var a=viewModel.linksEditing();if(a.length<1){console.error("link size must not 0");return}var firstLinkView=a[0];tmpBoardView.linkEditorView.open(firstLinkView)}}
function BlackListEditorView(){this.container="#blackListContainer";this.isEditorFocus=ko.observable(false);this.targetMessageView=ko.observable();var self=this;this.open=function(msgView){msgView.openBlackBox();self.targetMessageView(msgView);openEditorView({container:self.container});self.isEditorFocus(true)};this.close=function(viewModel,event){if(viewModel.targetMessageView()!=null)viewModel.targetMessageView().closeBlackBox();viewModel.reset();closeEditorView({container:viewModel.container});
return true};this.reset=function(){this.targetMessageView(null)};this.doSave=function(viewModel,event){if(viewModel.targetMessageView()!=null){var msgView=viewModel.targetMessageView();if(msgView.validateBeforeBlackAction()==false)return;msgView.blackAction(msgView,event)}viewModel.close(viewModel,event)}}
function DeleteRemarkEditorView(opt){var exOpt=$.extend({container:"#deleteRemarkContainer",saveType:"del"},opt);this.reason=ko.observable("");this.isEditorFocus=ko.observable(false);this.saveType=exOpt.saveType;this.container=exOpt.container;this.targetMessageView=null;var self=this;this.open=function(msgView){self.targetMessageView=msgView;openEditorView({container:self.container});self.isEditorFocus(true)};this.close=function(viewModel,event){viewModel.reset();closeEditorView({container:viewModel.container});
return true};this.reset=function(){this.reason("")};this.doSave=function(viewModel,event){if(viewModel.reason().trim()==""){alert("原因不可為空白");return}viewModel.targetMessageView.remark(viewModel.reason());if(self.saveType=="del")viewModel.targetMessageView.delAction(viewModel.targetMessageView);else if(self.saveType=="spam")viewModel.targetMessageView.spamAction(viewModel.targetMessageView);viewModel.close(viewModel,event)}}
function ImageAltEditorView(){this.altValue=ko.observable("");this.isEditorFocus=ko.observable(false);this.container="#imageAltEditorContainer";this.targetImageView=null;this.loadImageView=function(imgView){if(imgView==null)return null;this.targetImageView=imgView;this.altValue(imgView.title())};this.open=function(imgView){this.loadImageView(imgView);openEditorView({container:this.container});this.isEditorFocus(true);return this};this.close=function(viewModel,event){viewModel.reset();closeEditorView({container:viewModel.container});
return true};this.reset=function(){this.altValue("")};this.doSave=function(viewModel,event){if(viewModel.altValue().trim()==""){alert("圖片說明不可為空白");return}if(viewModel.targetImageView!=null)viewModel.targetImageView.title(viewModel.altValue());viewModel.close(viewModel,event)}}
function LinkEditorView(){this.linkUrl=ko.observable("");this.isEditorFocus=ko.observable(false);this.container="#linkEditorContainer";this.targetLinkView=null;this.loadLinkView=function(linkView){if(linkView==null)return null;this.targetLinkView=linkView;this.linkUrl(linkView.url())};this.open=function(linkView){this.loadLinkView(linkView);openEditorView({container:this.container});this.isEditorFocus(true);return this};this.close=function(viewModel,event){viewModel.reset();closeEditorView({container:viewModel.container});
return true};this.reset=function(){this.linkUrl("")};this.doSave=function(viewModel,event){var linkUrl=viewModel.linkUrl();if(linkUrl.length>0&&urlValidate(linkUrl)==false){alert("請輸入正確的網址");return}if(viewModel.targetLinkView!=null)viewModel.targetLinkView.url(viewModel.linkUrl());viewModel.close(viewModel,event)}}function generateRdqLinkId(){var random=Math.floor(Math.random()*100);return++_rdqLinkCounter+"_"+random}
function generateRdqImageUploaderId(){var random=Math.floor(Math.random()*100)+100;return++_rdqImageUploaderCounter+"_"+random}function generateFormId(){var random=Math.floor(Math.random()*100)+1E3;return++_rdqFormCounter+"_"+random}function redoMessageEllipsis(elts){elts.removeClass("dotFinish").addClass("redoDot");setupMessageEllipsis(elts)}
function setupMessageEllipsis(elts){elts.each(function(index){var $this=$(this);if($this.hasClass("dotFinish"))return;$this.addClass("dotFinish");var cont=$this;function createDots(){cont.attr("data-initDotDotDot","true");cont.dotdotdot({ellipsis:"",height:maxHeight,after:"button.read_more"})}function destroyDots(){cont.trigger("destroy")}if(cont.hasClass("redoDot")){cont.off("click","button.read_more");destroyDots()}var contHeight=cont.height();var maxHeight=120;if(contHeight>maxHeight)cont.append('\x3cbutton type\x3d"button" class\x3d"read_more"\x3e...查看更多\x3c/button\x3e');
createDots();cont.on("click","button.read_more",function(){cont.toggleClass("opened");var moreButton;if(cont.hasClass("opened")){destroyDots();moreButton=cont.find("button.read_more").html("...隱藏內容")}else{createDots();moreButton=cont.find("button.read_more").html("...查看更多")}var moreButtonFocus=cont.data("moreButtonFocus");if(moreButtonFocus==="true")moreButton.focus();return false}).on("keydown","button.read_more",function(e){var $elt=$(this);if(e.keyCode==13){cont.data("moreButtonFocus","true");
$elt.trigger("click");return false}return true}).on("blur","button.read_more",function(e){})})}function setupAuthorImageLazyload(elts){elts.each(function(){var $this=$(this);var loadOriginal=function(){var original=$this.attr("data-original");$this.unbind("error").attr("src",original)};var src=$this.attr("src");if(src==="")loadOriginal();$this.unbind("error").bind("error",function(){loadOriginal()})})}
function setupLinkTitleFromRemote(elts){var links=$(elts).find("a.clinkTitleFromRemote");links.each(_linkTitleFromRemote)}function _increaseObservableNumber(fc,value){var av=1;if(value!=null)av=value;var c=fc();fc(c+av)}function _decreaseObservbleNumber(fc){var c=fc();fc(Math.max(c-1,0))}var _checkUserIsLogin=function(tmpBoardView){if(tmpBoardView&&tmpBoardView.isLogin())return true;return false};function redirectToLogin(){window.location.href=contextPath+"/login"}
function validVCode(param){if(param.vCode===null||param.vCode.length===0){alert("請輸入圖形驗證碼");return false}return true}
function validPostMessageParam(param,tmpBoardView){if(param.content==null||param.content===""){alert("請輸入留言內容");return false}if(param.content.length>1E3){alert("留言上限為1000字");return false}if(param.agreeTerms!=="Y"){alert("請勾選同意留言相關規範");return false}if(_checkUserIsLogin(tmpBoardView))return true;if(param.displayName===""){alert("請輸入名稱");return false}if(param["anonymousEmail"]!=null&&param["anonymousEmail"].length>0)try{if(!ko.validation.rules.emailS1.validator(param["anonymousEmail"],true)){alert("請輸入正確的聯絡信箱");
return false}}catch(e){}if(param.email===""){alert("請輸入聯絡信箱");return false}return true}function validImageUploader(viewModel){var msg="";$.each(viewModel.imagesEditing(),function(i,item){if(item.title()=="")msg="請輸入圖片說明"});if(msg!=""){alert(msg);return false}return true}function validLink(viewModel){var msg="";$.each(viewModel.linksEditing(),function(i,item){var url=item.url();if(url=="")return;if(urlValidate(url)==false)msg="請輸入正確的網址"});if(msg!=""){alert(msg);return false}return true}
function urlValidate(value){return/^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})).?)(?::\d{2,5})?(?:[/?#]\S*)?$/i.test(value)}
String.prototype.toSubstitution=function(data){var formatted=this;for(var key in data){var regexp=new RegExp("\\{"+key+"\\}","gi");formatted=formatted.replace(regexp,data[key])}return formatted};function _toPageWithButton(v,e){var $btn=$(e.currentTarget);if($btn.length===0)return;window.location.href=$btn.attr("data-c-toUrl")}
function _reloadInBackGround(){if(window.location.href.indexOf("/policies/detail")>0||window.location.href.indexOf("/acts/detail")>0)$.ajax({url:window.location.href,type:"GET",success:function(){}})}function _reloadPageOverDay(prevTimestamp){if(prevTimestamp==null){_reloadInBackGround();return}var now=moment(new Date);var prev=moment(prevTimestamp);if(!prev.isValid()){_reloadInBackGround();return}if(!now.isSame(prev,"day")){window.location.reload();return}};