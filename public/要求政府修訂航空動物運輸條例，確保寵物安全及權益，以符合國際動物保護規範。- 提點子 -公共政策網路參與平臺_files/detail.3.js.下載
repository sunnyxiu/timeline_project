$(function(){_koCustomBinding3()});
function _koCustomBinding3(){ko.bindingHandlers.tabEnter={init:function(element,valueAccessor,allBindingsAccessor,viewModel){$(element).keydown(function(event){if(event.which===13)viewModel.showOfficalResponse(viewModel)})}};ko.bindingHandlers.uImg={init:function(element,valueAccessor){var value=valueAccessor();var valueUnwrapped=ko.unwrap(value);var $elt=$(element);if(valueUnwrapped===null||valueUnwrapped==="")return;$.ajax({type:"GET",url:contextPath+"/idea/endorse/user/picture/"+valueUnwrapped,
contentType:"application/json",targetElt:$elt,onLoadImageFail:function(){var defImgSrc=$elt.attr("data-def-img");if(defImgSrc){$elt.attr("src",defImgSrc);return}$elt.css({"visibility":"hidden"})},success:function(resp){if(!resp.success){this.onLoadImageFail();return}$elt.attr("src",resp.result)},error:function(){this.onLoadImageFail()}})}};ko.bindingHandlers.escModal={init:function(element){$(element).on("shown.bs.modal",function(){var $this=$(this),$moreBtn=$this.find(".user-read-more");$moreBtn.each(function(i,
btn){var $btn=$(btn),$msgContent=$btn.siblings("p.message-paragraph");if($msgContent.length>0)if($msgContent[0].scrollHeight<=$msgContent[0].clientHeight)$btn.hide();else $btn.show()})})}};ko.bindingHandlers.escCollapse={init:function(element){var $elt=$(element),$msgContent=$elt.siblings("p.message-paragraph");if($msgContent.length>0)if($msgContent[0].scrollHeight<=$msgContent[0].clientHeight)$elt.hide();else $elt.show();$elt.click(function(e){e.preventDefault();var $this=$(this),$msgContent=$this.siblings("p.message-paragraph");
$msgContent.toggleClass("user-height-auto");if($msgContent.hasClass("user-height-auto"))$this.text("隱藏內容");else $this.text("查看更多");return false})}}}Date.prototype.addDays=function(days){var date=new Date(this.valueOf());date.setDate(date.getDate()+days);return date};var defaultVisibleNumberOfOfficialComments=2;
var ideaStatus={READY:"Ready",PENDING_READY:"PendingReady",PROPOSING:"Proposing",ADJUSTED:"Adjusted",REVOKED:"Revoked",FIRSTSIGNED:"FirstSigned",SECONDSIGNED:"SecondSigned",ADVICE:"Advice",COMPLTETED:"Completed",FIRSTFAILED:"FirstFailed",SECONDFAILED:"SecondFailed"};function electionRuleModel(data){var self=this;ko.mapping.fromJS(data,{},self)}function endorseModel(data){var self=this;ko.mapping.fromJS(data,{},self)}function attachmentModel(data){var self=this;ko.mapping.fromJS(data,{},self)}
function govResponseModel(data){var self=this;ko.mapping.fromJS(data,{},self);self.isCurrentBlockOpen=ko.observable(false);self.showOfficalResponse=function(gov){var id="#"+gov.id();var isOpen=$(id).toggleClass("open").hasClass("open");self.isCurrentBlockOpen(isOpen);if(isOpen){if(self.relatedIdeaIds()!=null)self.retrieveGovRelateIdeas();if(self.attachments()!=null)self.retrieveGovAttachments()}};self.relateIdeas=ko.observableArray();self.retrieveGovRelateIdeas=ko.pureComputed(function(){var relate_ideas_url=
contextPath+"/idea/gov/relate/ideas/"+self.relatedIdeaIds();$.ajax({type:"GET",url:relate_ideas_url,contentType:"application/json",success:function(data){if(data.success)self.relateIdeas(ko.utils.arrayMap(data.result,function(item){return new ideaModel(item)}))},error:function(){}})},this);self.relateAttachments=ko.observableArray();$.each(data.relateAttachments(),function(index,item){var itemJson=ko.toJS(item);self.relateAttachments.push(new attachmentModel(itemJson))});self.retrieveGovAttachments=
ko.pureComputed(function(){return;var relate_attachments_url=contextPath+"/idea/gov/relate/attachments/"+self.attachments();$.ajax({type:"GET",url:relate_attachments_url,contentType:"application/json",success:function(data){if(data.success)self.relateAttachments(ko.utils.arrayMap(data.result,function(item){return new attachmentModel(item)}))},error:function(){}})},this);self.retrieveGovLinkUrls=ko.pureComputed(function(){if(self.linkUrls())return self.linkUrls().split(";");return[]},this)}
function ideaModel(data){var self=this;ko.mapping.fromJS(data,{},self);self.diffDays=function(day1,day2,isAdded){var oneDay=1E3*60*60*24;var left=day1-day2;var isPassed=left<0;var leftDays=isAdded?Math.ceil(Math.abs(left)/oneDay):Math.floor(Math.abs(left)/oneDay);leftDays=isPassed?leftDays*-1:leftDays;return leftDays};self.countDown=ko.pureComputed(function(){if(self.endorseDueDate())return self.diffDays(self.endorseDueDate(),new Date,true);return 0},this);self.runtime=ko.pureComputed(function(){if(self.approvedTime()){var approvedDate=
new Date(self.approvedTime());var now=new Date;if(new Date(approvedDate.getFullYear(),approvedDate.getMonth(),approvedDate.getDate())-new Date(now.getFullYear(),now.getMonth(),now.getDate())==0)return 0;return self.diffDays(new Date,approvedDate,true)}return 0},this);self.firstSignedFieldText=ko.pureComputed(function(){if(self.firstSignedTime()==null&&currentTime<self.endorseDueDate()&&(new Date(self.approvedTime())).format("Y-m-d")<(new Date(currentTime)).format("Y-m-d"))return"附議中";else if(self.firstSignedTime()!=
null)return"通過";else if(self.firstSignedTime()==null&&self.endorseDueDate()<currentTime)return"不通過";else if(self.firstSignedTime()==null&&(new Date(self.approvedTime())).format("Y-m-d")==(new Date(currentTime)).format("Y-m-d"))return"次日開始附議";return""},this);self.firstSignedFieldDate=ko.pureComputed(function(){if(self.firstSignedTime()!=null)return(new Date(self.firstSignedTime())).format("Y-m-d");else if(self.firstSignedTime()==null&&self.endorseDueDate()<currentTime)return(new Date(self.endorseDueDate())).format("Y-m-d");
return""},this);self.secondSignedFieldText=ko.pureComputed(function(){if(self.secondSignedTime()==null&&currentTime<self.endorseDueDate())return"附議中";else if(self.secondSignedTime()!=null)return"通過";else if(self.secondSignedTime()==null&&self.endorseDueDate()<currentTime)return"不通過";return""},this);self.secondSignedFieldDate=ko.pureComputed(function(){if(self.secondSignedTime()!=null)return(new Date(self.secondSignedTime())).format("Y-m-d");else if(self.secondSignedTime()==null&&self.endorseDueDate()<
currentTime)return(new Date(self.endorseDueDate())).format("Y-m-d");return""},this);self.requireEndorseCount=ko.pureComputed(function(){var count=self.endorseGoal()-self.endorseCount();return count>0?count:0},this);self.isAllowAttention=ko.pureComputed(function(){switch(self.status()){case "Draft":case "PendingDraft":case "Proposing":case "Adjusted":return false;default:return true}},this);self.isAllowEndorse=ko.pureComputed(function(){var isAllowed=false;switch(self.status()){case "FirstSigned":case "SecondSigned":var approvedTime=
new Date(self.approvedTime());var approvedDate=new Date(approvedTime.getFullYear(),approvedTime.getMonth(),approvedTime.getDate());if(approvedDate.addDays(1).getTime()<=currentTime)isAllowed=true;break;case "Advice":if(currentTime<=self.endorseDueDate())isAllowed=true;break;case "Completed":if(currentTime<=self.endorseDueDate())isAllowed=true;break}return isAllowed},this);self.govResponseModels=ko.observableArray();self.revokeFunctionText=ko.pureComputed(function(){var t="提點子";var t2="提案";if(self.entranceType()===
"ly"){t="立法倡議";t2="提議"}switch(self.status()){case ideaStatus.PROPOSING:case ideaStatus.ADJUSTED:return t2+"狀態：「"+t+"」審核中";case ideaStatus.FIRSTSIGNED:case ideaStatus.SECONDSIGNED:return t2+"狀態：「"+t+"」附議中";default:return""}});self.organizationsList=ko.pureComputed(function(){var master="";var second="";if(self.organizations==null)return"";var organiztions=self.organizations().sort(function(left,right){return left.organization.orgOrder()-right.organization.orgOrder()});for(var key in organiztions)if(organiztions[key].isDefault())master+=
organiztions[key].organization.organizationName()+" ";else second+=organiztions[key].organization.organizationName()+" ";return master+" "+second},this);self.masterOrganizationsList=ko.pureComputed(function(){var master="";if(self.organizations==null)return"";var organiztions=self.organizations().sort(function(left,right){return left.organization.orgOrder()-right.organization.orgOrder()});for(var key in organiztions)if(organiztions[key].isDefault())master+=organiztions[key].organization.organizationName()+
" ";return master},this);self.secondOrganizationsList=ko.pureComputed(function(){var second="";if(self.organizations==null)return"";var organiztions=self.organizations().sort(function(left,right){return left.organization.orgOrder()-right.organization.orgOrder()});for(var key in organiztions)if(!organiztions[key].isDefault())second+=organiztions[key].organization.organizationName()+" ";return second},this);self.entranceTypePath=ko.pureComputed(function(){return""})}
var ideaViewModel={pageResultEndorses:ko.observableArray(),isEndorsed:ko.observable(false),isIdeaOwner:ko.observable(false),isAttentioned:ko.observable(false),hyperlinks:ko.observableArray(),checkEndorsed:function(){var self=this;$.ajax({type:"GET",url:is_endorsed_url,contentType:"application/json",success:function(data){self.isEndorsed(data.success)},error:function(xhr,textStatus,thrownError){alert("檢查附議狀態失敗，請重新附議。")}})},checkIdeaOwner:function(){var self=this;$.ajax({type:"GET",url:is_idea_owner_url,
contentType:"application/json",success:function(data){self.isIdeaOwner(data.success)},error:function(xhr,textStatus,thrownError){alert("檢查提議人失敗")}})},checkattentioned:function(){var self=this;$.ajax({type:"GET",url:is_attentioned_url,contentType:"application/json",success:function(data){self.isAttentioned(data.success)},error:function(xhr,textStatus,thrownError){alert("檢查關注狀態失敗")}})},openDiscuss:function(){var self=this;$.ajax({type:"GET",url:open_disqus_url,contentType:"application/json",success:function(data){if(data.success)window.location.reload();
else alert(data.result)},error:function(xhr,textStatus,thrownError){alert("開啟討論串失敗")}})},closeDiscuss:function(){var self=this;$.ajax({type:"GET",url:close_disqus_url,contentType:"application/json",success:function(data){if(data.success)window.location.reload();else alert(data.result)},error:function(xhr,textStatus,thrownError){alert("關閉討論串失敗")}})},incrementAttention:function(){var self=this;var state=self.isAttentioned();var previousCount=self.ideaDetail.attentionCount();if(!state)self.sendAttentionRequest();
else self.rejectAttentionRequest()},sendAttentionRequest:function(){var self=this;return $.ajax({type:"POST",url:attention_url,viewModel:self,contentType:"application/json",success:function(data){if(!data.success){if(window["_entranceType"]==="ly"){$("#messageDialog").find(".msg_01").children(".c-box-header").text("請先登入");$("#messageDialog").find(".msg_01").children(".c-box-content").text("")}else{$("#messageDialog").find(".msg_01").children(".c-box-header").text("想要關注提點子嗎？");$("#messageDialog").find(".msg_01").children(".c-box-content").text("請先登入")}loginProcess();
return}var previousCount=this.viewModel.ideaDetail.attentionCount();this.viewModel.ideaDetail.attentionCount(previousCount+1);this.viewModel.isAttentioned(true);_displayMessage({header:"",message:$("#cModalDialogAttentionMessage").val()||"關注成功，您可隨時登入會員後至會員專區查看唷！"})},error:function(xhr,textStatus,thrownError){alert("關注失敗");ideaViewModel.isAttentioned(false)}})},rejectAttentionRequest:function(){var self=this;return $.ajax({type:"DELETE",url:attention_url,viewModel:self,contentType:"application/json",
success:function(data){if(!data.success){$("#messageDialog").children("h4").text("想要關注這個提議嗎?");$("#messageDialog").children("p").text("請先登入");loginProcess();return}var previousCount=this.viewModel.ideaDetail.attentionCount();if(previousCount>0)this.viewModel.ideaDetail.attentionCount(previousCount-1);this.viewModel.isAttentioned(false)},error:function(xhr,textStatus,thrownError){alert("取消關注失敗");ideaViewModel.isAttentioned(false)}})},officialCommentsVisibleCountSetting:ko.observable(defaultVisibleNumberOfOfficialComments),
showMoreOfficialComments:function(){var commentsCountSetting=this.officialCommentsVisibleCountSetting();this.officialCommentsVisibleCountSetting(commentsCountSetting+defaultVisibleNumberOfOfficialComments)},doShareEmail:function(viewModel,event){var url="mailto:?";var data={subject:$(".shareMailSubject").html()};window.open(url+$.param(data))},doDownload:function(viewModel,event){var url=$(event.currentTarget).attr("data-dl-url");window.open(url)},doPrint:function(viewModel,event){var a=$(".printable").siblings("div:not(.printable)").addClass("notPrintable");
window.print();a.removeClass("notPrintable");return true},toStatisticsMap:function(viewModel){var url=contextPath+"/idea/detail/"+viewModel.ideaDetail.id()+"/statistics#middle";if(_ideaStatisticMapVersion=="2")url=contextPath+"/idea/detail/"+viewModel.ideaDetail.id()+"/statistics2#middle";window.location.href=url},endorseSuggestionEditorView:new EndorseSuggestionEditorView,recommendIdeaView:new RecommendBaseView({"mode":"idea","fetchUrl":"","container":"#recommendIdeaContainer"}),recommendPolicyView:new RecommendBaseView({"mode":"policy",
"fetchUrl":"","container":"#recommendPolicyContainer"}),recommendPolicyCYView:new RecommendBaseView({"mode":"policyCY","fetchUrl":"","container":"#recommendPolicyCYContainer"}),endorseListView:new CEndorseListView({"ideaId":idea.id,"suggestionContainer":"#endorseListViewDialog"}),sidebarEndorse:function(){$("button.endorseButton").trigger("click")},sidebarDiscuss:function(){var board=window["boardViewModel"];if(!board)return;board.doDebateStartOutside();var ps=$("#joinBoardContainer").position();
$("html, body").animate({scrollTop:ps.top-150},500)},reasonBox:new BMessageModalBoxView({}),showReasonBox:function(){var status=ideaViewModel.ideaDetail.status();var data=null;if(status=="Rejected")data={"header":"檢核不通過原因","subTitle":"原因","content":ideaViewModel.ideaDetail.decisionComment()};else if(status=="Revoked"){data={};var byAdmin=ideaViewModel.ideaDetail.revokeByAdmin();if(byAdmin)data.header="管理人員撤案";else data.header="自行撤案";data.subTitle="原因";data.content=ideaViewModel.ideaDetail.revokedComment()}if(!data)return;
ideaViewModel.reasonBox.show(data)},moveToGResponse2:function(v,e){var $btn=$(e.currentTarget);var respUid=$btn.attr("data-resp-uid");var $targetContent=$(".c-govResp-content").filter('[data-resp-uid\x3d"'+respUid+'"]');var pos=$targetContent.offset();$("html,body").animate({scrollTop:pos.top-$("#top").height()-30})},moveToGResponse:function(){var $target=$(".c-govResp-content").first();if($target.length==0)return;var pos=$target.offset();$("html,body").animate({scrollTop:pos.top-$("#top").height()-
30})}};function deleteIdea(){_confirmMesage({header:"確認刪除提議?",message:"確認刪除請按確認?",onOk:function(){$.ajax({type:"DELETE",url:delete_idea_url,contentType:"application/json",beforeSend:function(){_closeDialog()},success:function(data){if(data.success)setTimeout(function(){window.location.assign(contextPath+ideaViewModel.ideaDetail.entranceTypePath()+"/idea/index#no-back-idea-deleted")},100)},error:function(xhr,textStatus,thrownError){alert("刪除失敗")}})}})}
function editIdea(){setTimeout(function(){document.location.href=edit_url},100)}
function revokeIdea(){_showOuterMessageDialog({title:"小提醒",selector:"#revokeDialog",maxWidth:"500px",buttons:[{"text":"確認","click":function(){var revoke_dicision=$("#revoke_dicision").val();ideaViewModel.ideaDetail.revokedComment(revoke_dicision);ideaViewModel.ideaDetail.status(ideaStatus.REVOKED);$.ajax({type:"POST",url:revoke_url,contentType:"application/json",data:ko.toJSON(ideaViewModel.ideaDetail),beforeSend:function(){$.blockUI()},success:function(data){if(data.success)setTimeout(function(){window.location.assign(contextPath+
ideaViewModel.ideaDetail.entranceTypePath()+"/idea/index#no-back-idea-revoked")},100);else alert("撤案失敗")},error:function(xhr,textStatus,thrownError){alert("撤案失敗")},complete:function(){$.unblockUI()}})}}]})}
function stepByStatus(status){switch(status){case ideaStatus.PROPOSING:return 1;break;case ideaStatus.ADJUSTED:return 2;break;case ideaStatus.FIRSTSIGNED:case ideaStatus.SECONDSIGNED:return 3;break;case ideaStatus.FIRSTFAILED:case ideaStatus.SECONDFAILED:return 3.5;break;case ideaStatus.ADVICE:case ideaStatus.COMPLTETED:return 4;break;default:return 0;break}}
function displayArea(status){switch(status){case ideaStatus.PROPOSING:case ideaStatus.ADJUSTED:case ideaStatus.FIRSTSIGNED:case ideaStatus.SECONDSIGNED:return true;default:return false}}
function pagerModel(totalResultSize){var self=this;self.currentPageIndex=ko.observable(1);self.pageStartIndex=ko.observable(1);self.pageEndIndex=ko.observable(defaultSearchResultPageIndexsRangeSize);self.pageSize=defaultSearchResultPageSize;self.totalSize=ko.observable(totalResultSize);self.maxPageIndex=ko.pureComputed(function(){return Math.ceil(self.totalSize()/self.pageSize)},this);self.pageIndexsRange=ko.observableArray();self.nextPage=function(){var pageIndex=self.currentPageIndex()+1;if(pageIndex<=
self.maxPageIndex())if(pageIndex>self.pageEndIndex())self.showNextPageIndexs();else self.replaceSearchResultByCondition(pageIndex,false)};self.showNextPageIndexs=function(){var startIndex=self.pageStartIndex()+defaultSearchResultPageIndexsRangeSize;var endIndex=self.pageEndIndex()+defaultSearchResultPageIndexsRangeSize;var maxIndex=self.maxPageIndex();if(startIndex<=maxIndex){self.pageStartIndex(startIndex);if(endIndex<=maxIndex)self.pageEndIndex(endIndex);else{endIndex=maxIndex;self.pageEndIndex(maxIndex)}self.pageIndexsRange(ko.utils.range(startIndex,
endIndex));self.replaceSearchResultByCondition(startIndex,false)}};self.previousPage=function(){var pageIndex=self.currentPageIndex()-1;if(pageIndex>0)if(pageIndex<self.pageStartIndex())self.showPreviousPageIndexs();else self.replaceSearchResultByCondition(pageIndex,false)};self.showPreviousPageIndexs=function(){var endIndex=self.pageStartIndex();var startIndex=endIndex-defaultSearchResultPageIndexsRangeSize;var defaultSelectionPageIndex=endIndex-1;if(startIndex>0){self.pageStartIndex(startIndex);
self.pageEndIndex(defaultSelectionPageIndex);self.pageIndexsRange(ko.utils.range(startIndex,defaultSelectionPageIndex));self.replaceSearchResultByCondition(defaultSelectionPageIndex,false)}};self.visiblePreviousPage=function(){var pageIndex=self.currentPageIndex()-1;if(pageIndex>0)return true;return false};self.visibleNextPage=function(){var pageIndex=self.currentPageIndex()+1;if(pageIndex<=self.maxPageIndex())return true;return false};self.replaceSearchResultByCondition=function(pageIndex,isResetPageIndexRange){var searchConditionUrl=
contextPath+"/idea/search/endorse?"+"page\x3d"+pageIndex+"\x26size\x3d"+self.pageSize+"\x26sort\x3dupdateDate,desc";searchConditionUrl+="\x26ideaId\x3d"+ideaViewModel.ideaDetail.id();$.ajax({type:"GET",url:searchConditionUrl,contentType:"application/json",success:function(data){ideaViewModel.pageResultEndorses(ko.utils.arrayMap(data.result,function(item){return new endorseModel(item)}));self.totalSize(data.totalResults);self.currentPageIndex(pageIndex);if(isResetPageIndexRange)if(data.totalResults>
defaultSearchResultPageIndexsRangeSize*defaultSearchResultPageSize){var range=ko.utils.range(1,defaultSearchResultPageIndexsRangeSize);self.pageIndexsRange(range)}else self.pageIndexsRange(ko.utils.range(1,self.maxPageIndex()))},error:function(xhr,textStatus,thrownError){try{console.log(thrownError)}catch(ex){}alert("取得資料失敗")}})}}function doExportEndorse(elt){var url=$(elt).attr("data-exportUrl");window.open(url)}var bakShowSuggestionLink;var _beforeShowSuggestionTop=0;
function popShowSuggestion(elt){var $elt=$(elt);bakShowSuggestionLink=$elt;var num=$elt.attr("data-no");$("#popShowSuggestionContainer").toggle().find('li[data-no\x3d"'+num+'"]').addClass("now").siblings("li").removeClass("now");_beforeShowSuggestionTop=Math.max($("body,html").scrollTop(),$("body").scrollTop());var liNow=$("#popShowSuggestionContainer li.now");var toY=liNow.offset().top;var halfWinHeight=Math.floor($(window).height()/2);var toCenterOffset=halfWinHeight-Math.floor(liNow.height()/2);
toY=Math.max(toY-toCenterOffset,0);$("body,html").scrollTop(toY);$("#popShowSuggestionContainer .bg").click(fireHideSuggestion);$("#popShowSuggestionContainer .close_btn").keydown(keydownHideShowSuggestion);$(document).keydown(ecsKeydownHideSuggestion);tabNavSuggestion();$("#popShowSuggestionContainer div.close_btn").focus()}function fireHideSuggestion(){hideShowSuggestion()}function keydownHideShowSuggestion(event){if(event.keyCode==13){event.preventDefault();hideShowSuggestion()}}
function ecsKeydownHideSuggestion(event){if(event.keyCode==27){event.preventDefault();hideShowSuggestion()}}
function tabNavSuggestion(){var list=$("#popShowSuggestionContainer *[tabindex]");var first=list.first();var last=list.filter(function(index){return $(this).parents().hasClass("hide")==false}).last();first.keydown(function(event){if(event.keyCode==9)if(event.shiftKey){event.preventDefault();last.focus()}});last.keydown(function(event){if(event.keyCode==9)if(!event.shiftKey){event.preventDefault();first.focus()}})}
function hideShowSuggestion(){$("#popShowSuggestionContainer").toggle();$("body,html").scrollTop(_beforeShowSuggestionTop);$("#popShowSuggestionContainer .bg").unbind("click",fireHideSuggestion);$("#popShowSuggestionContainer .close_btn").unbind("keydown");$(document).unbind("keydown",ecsKeydownHideSuggestion);$("#popShowSuggestionContainer *[tabindex]").unbind("keydown");if(bakShowSuggestionLink!=null)bakShowSuggestionLink.focus()}
function popShowSuggestionEditor(elts){ideaViewModel.endorseSuggestionEditorView.open(elts)}
function EndorseSuggestionEditorView(){this.container="#endorseSuggestionEditorContainer";this.suggestion=ko.observable("");this.overlayLoadmaskView=new SimpleLoadmaskView;this.isEditorFocus=ko.observable(false);this.data=null;this.triggerButton=null;this.open=function(elts){this.triggerButton=elts;$("#endorseSuggestionEditorDialog").modal("show");$.ajax({type:"GET",url:contextPath+"/idea/endorse/myLastEndorse/"+idea.id,contentPath:"application/json",viewModel:this,beforeSend:function(){this.viewModel.overlayLoadmaskView.show(true)},
complete:function(){this.viewModel.overlayLoadmaskView.show(false);this.viewModel.isEditorFocus(true)},success:function(resp){if(!resp.success){alert("取得附議記錄失敗");this.viewModel.doClose();return}var vm=this.viewModel;vm.data=ko.mapping.fromJS(resp.result,{});vm.suggestion(resp.result.suggestion)},error:function(){alert("取得附議記錄失敗");this.viewModel.doClose()}});return this};this.doClose=function(opt){this.close(this)};this.close=function(viewModel,event){viewModel.reset();$("#endorseSuggestionEditorDialog").modal("hide");
return true};this.reset=function(){this.triggerButton=null;this.suggestion("");this.overlayLoadmaskView.show(false);this.data=null;this.isEditorFocus(false)};this.doSave=function(viewModel,event){viewModel.data.suggestion(viewModel.suggestion());$.ajax({type:"POST",url:contextPath+"/idea/endorse/myLastEndorse/"+idea.id,data:ko.mapping.toJSON(viewModel.data),contentType:"application/json",viewModel:viewModel,beforeSend:function(){this.viewModel.overlayLoadmaskView.show(true)},complete:function(){this.viewModel.overlayLoadmaskView.show(false)},
success:function(resp){if(!resp.success){alert("更新附議意見失敗");this.viewModel.doClose();return}var btn=$(this.viewModel.triggerButton);var no=btn.attr("data-eid");var newText=this.viewModel.suggestion();ideaViewModel.endorseListView.afterChangeSuggestion(no,newText);alert("更新附議意見成功");this.viewModel.doClose()},error:function(){alert("更新附議意見失敗");this.viewModel.doClose()}})}}
function CEndorseListView(options){var self=this;this.options=$.extend({"ideaId":""},options);this.keyword=ko.observable("");this.cityName=ko.observable("");this.areaName=ko.observable("");this.citySelectOption=null;this.areaSelectOption=null;this.availableAreaOption=ko.pureComputed(function(){if(self.areaSelectOption==null||self.cityItem()==null)return[];return ko.utils.arrayFilter(self.areaSelectOption(),function(item){return item.cityId()===self.cityItem().id()})},this);this.cityItem=ko.observable();
this.areaItem=ko.observable();this.page=new SearchPageView;this.isLoading=ko.observable(false);this.simpleLoadmaskView=new SimpleLoadmaskView;this.reqDataTimestamp=ko.observable(-1);this.datalist=ko.observableArray([]);this.sdDatalist=ko.observableArray([]);this.hasData=ko.pureComputed(function(){return this.datalist().length>0},this);this.isShowNoData=ko.pureComputed(function(){if(this.isLoading())return false;return this.datalist().length===0},this);this.buildParam=function(){return{"ideaId":self.options.ideaId,
"keyword":self.keyword(),"page":self.page.number(),"size":self.page.size()}};this.showSuggestionDialog=function(viewModel){var sa=ko.utils.arrayFilter(self.datalist(),function(item){return item.hasSuggestion()});self.sdDatalist(sa);var targetContainer=self.options.suggestionContainer;$(targetContainer).modal("show")};this.goPageToFirst=function(){self.page.number(1);self.goPage()};this.goPage=function(){self.fetchData();_scrollMoveToElt("#endorses")},this.clickSearch=function(){if(self.cityName()!==
""){self.clickMapToSearch();return}self.page.number(1);self.fetchData()};this.clickSearchMobile=function(){self.page.number(1);self.fetchData({"mode":"mobile-list"})};this.clickMapToSearch=function(){self.page.number(1);self.fetchData({"mode":"desktop-map"})};this.fetchData=function(options){var opts=$.extend({"mode":"desktop-list"},options);var queryData=self.buildParam();if(opts.mode==="desktop-map")queryData=$.extend(queryData,{"cityName":self.cityName,"areaName":self.areaName});else if(opts.mode===
"mobile-list"){var od={};if(self.cityItem()!=null)od.cityName=self.cityItem().name();if(self.areaItem()!=null)od.areaName=self.areaItem().area();queryData=$.extend(queryData,od)}$.ajax({type:"GET",url:contextPath+"/idea/v2/data/endorser/list",data:queryData,contentType:"application/json",viewModel:self,beforeSend:function(){this.viewModel.isLoading(true)},success:function(resp){if(!resp.success)return;var vm=this.viewModel;vm.page.totalCount(resp.totalResults);vm.page.totalPage(resp.totalPages);setTimeout(function(){_firePageNumberPickerM("#dtPageNumber",
{"current":vm.page.number(),"max":vm.page.totalPage(),"currentAccessor":vm.page.number})},150);vm.datalist([]);$.each(resp.result,function(i,item){var itemView=new CEndorseItemView(item);itemView.calculateNo(vm.page,i);vm.datalist.push(itemView)})},error:function(){},complete:function(){this.viewModel.isLoading(false);this.viewModel.reqDataTimestamp((new Date).getTime())}})};this.afterChangeSuggestion=function(no,text){var dataItem=ko.utils.arrayFirst(self.datalist(),function(item){return item.id()==
no});if(dataItem)dataItem.suggestion(text)};this.doChangeCity=function(cityName){self.cityName(cityName);self.clickMapToSearch()};this.doChangeArea=function(areaName){self.areaName(areaName);self.clickMapToSearch()};this.doClearCity=function(){self.cityName("");self.areaName("");self.clickMapToSearch()};this.init=function(){this.isLoading.subscribe(function(newValue){self.simpleLoadmaskView.show(newValue===true)});this.fetchData()};this.init()}
function CEndorseItemView(data,index){var self=this;ko.mapping.fromJS(data,{},this);this.noVal=ko.observable("");this.displayNo=ko.pureComputed(function(){return this.noVal()},this);this.displayDate=ko.pureComputed(function(){return moment(this.updateDate()).format("YYYY-MM-DD")},this);this.hasSuggestion=ko.pureComputed(function(){return this.suggestion()!=null&&this.suggestion().length>0},this);this.calculateNo=function(page,index){if(typeof this.seqno=="function"){var val=this.seqno();if(val){this.noVal("#"+
val);return}}var val=page.totalCount()-(index+(page.number()-1)*page.size());this.noVal("#"+val)};this.isSameUser=ko.pureComputed(function(){if(this.matchCount==null||this.matchCount()==null)return false;return this.matchCount()>0},this)}
function RecommendBaseView(options){var opts=$.extend({"mode":"idea","pageSize":4,"pageMaxNumber":3,"fetchUrl":null,"fetchExcludeExist":true,"container":""},options);this.options=opts;this.container=opts.container;this.isVisible=ko.observable(false);this.hasData=ko.observable(false);this.items=ko.observableArray([]);this.loadmaskView=new SimpleLoadmaskView;var self=this;this.readMoreItem=new RecommendBaseItemView({type:"readMore",title:"閱讀更多"});this.toggleOpen=function(viewModel,event){event.preventDefault();
var $container=$(viewModel.container);var $target=$container.find("ul.main");var isOpened=$container.hasClass("open");var actionType="open";if(isOpened)actionType="close";$target.slideToggle({start:function(){if(actionType==="open")$container.addClass("open");else if(actionType==="close");},complete:function(){if(actionType==="open");else if(actionType==="close")$container.removeClass("open")}});return true};this.keydownToggleOpen=function(viewModel,event){if(event.keyCode===13){event.preventDefault();
$(event.currentTarget).trigger("click");return false}return true};this.page={number:ko.observable(1),size:ko.observable(this.options.pageSize),maxNumber:this.options.pageMaxNumber,isEnd:function(){return this.number()>=this.maxNumber}};this.clickItem=function(viewModel,event){event.stopPropagation();if(viewModel.options.type==="item")return true;event.preventDefault();var p=self.page.number()+1;self.page.number(p);self.fetchCall();return false};this.keydownItem=function(viewModel,event){if(event.keyCode===
13){event.preventDefault();event.stopPropagation();$(event.currentTarget).trigger("click");return false}return true};this.nextPage=function(){var p=self.page.number()+1;self.page.number(p);self.fetchCall()};this.fetchCall=function(){var existIdeaList=[];ko.utils.arrayForEach(this.items(),function(item){existIdeaList.push(item.uid())});var reqPage={page:this.page.number(),size:this.page.size()};if(this.options.fetchUrl==null||this.options.fetchUrl.length===0)return;$.ajax({type:"POST",url:this.options.fetchUrl+
"?"+$.param(reqPage),data:ko.toJSON({"mode":self.options.mode,"exclude":existIdeaList}),contentType:"application/json",viewModel:this,beforeSend:function(){this.viewModel.loadmaskView.show(true)},complete:function(){this.viewModel.loadmaskView.show(false)},success:function(resp){if(!resp.success)return;var vm=this.viewModel;if(vm.page.number()===1&&resp.totalResults>0)vm.hasData(true);$.each(resp.result,function(index,itemData){var itemView;if(vm.options.mode==="policy")itemView=new TopicItemView(vm.options.mode,
itemData.policy);else if(vm.options.mode==="policyCY")itemView=new TopicItemView("policy",itemData.policy);else itemView=new TopicItemView(vm.options.mode,itemData);vm.items.push(itemView)});if(resp.surplusResults<=0||vm.page.isEnd())vm.readMoreItem.isVisible(false);vm.isVisible(true)},error:function(){}})};this.cleanReadMoreItem=function(){if(this.items().length===0)return;this.items.pop()};this.init=function(){this.fetchCall()};this.init()}
function RecommendBaseItemView(options,itemData){if(itemData!=null)ko.mapping.fromJS(itemData,{},this);var opts=$.extend({title:"",type:"item",mode:"idea"},options);var self=this;this.options=opts;this.isVisible=ko.observable(true);if(this["title"]==null)this.title=ko.observable(this.options.title);this.titleTip=ko.pureComputed(function(){if(self.options.type=="readMore")return"點擊閱讀更多";if(self.options.mode=="idea")return"點擊進入提議 "+this.title();else if(self.options.mode=="policy")return"點擊進入政策 "+this.title();
else if(self.options.mode=="act")return"點擊進入計畫 "+this.title();else return""},this);this.url=ko.pureComputed(function(){if(self.options.type=="readMore")return"";if(self.options.mode=="idea")return contextPath+"/idea/detail/"+this.id();else if(self.options.mode=="policy")return contextPath+"/policies/detail/"+this.id();else if(self.options.mode=="act")return contextPath+"/acts/detail/"+this.id();else if(self.options.mode=="policyCY")return contextPath+"/policies/cy/detail/"+this.id();else return"#"},
this);this.attrTarget=ko.pureComputed(function(){if(self.options.type=="readMore")return"";if(self.options.mode=="policyCY")return"_blank";return""},this);this.init=function(){};this.init()}
function checkEndorseRepeatCount(){if(_enableVerification=="true")$.ajax({type:"POST",url:_checkMobileRepeatUrl,contentType:"application/json",success:function(resp){if(resp.success)if(resp.result>=_ideaEndorseMobileCount){_displayMessageHtml({header:"",message:"提醒您，此手機門號已附議三次，依使用者基本資料登錄規範，已達附議上限，請參閱\x3ca href\x3d'"+contextPath+userMobileQAUri+"' target\x3d'_blank' title\x3d'另開新視窗前往手機與綁定帳號規範'\x3e《手機與綁定帳號規範》\x3c/a\x3e。"});return}if(_isIdeaEndorseEasyEnable==true)getEndorse();else window.location.href=
contextPath+"/idea/endorse/step1/"+ideaViewModel.ideaDetail.id()}});else if(_isIdeaEndorseEasyEnable==true)getEndorse();else window.location.href=contextPath+"/idea/endorse/step1/"+ideaViewModel.ideaDetail.id()}
function getEndorse(){$.ajax({type:"POST",url:contextPath+"/idea/endorse/step1/"+ideaViewModel.ideaDetail.id(),contentType:"application/json",beforeSend:function(){$.blockUI()},success:function(resp){if(resp.success){endorseEasyModel.endorserInfo.load(resp.result.endorser);endorseEasyModel.endorseSmsInfo.load(resp.result.endorseSms);endorseEasyModel.onBeforeShow();var $box=$("#endorseEasy").show();var minusHeight=$("#top").height();var pos=$box.offset();$("html,body").animate({scrollTop:pos.top-minusHeight-
80})}else if(resp.result==="-1")window.location.href=contextPath+"/login";else alert("附議失敗 ("+resp.result+")")},error:function(){alert("附議失敗:系統異常")},complete:function(){$.unblockUI()}})}function pickupLoginStep(btn){if(btn==null)return;var $btn=$(btn);var isEasyLoginMode=$btn.attr("data-easylogin");if(isEasyLoginMode==="true"){var isMobile=$btn.hasClass("isMobile");if(isMobile)toLoginPage();else goLogin()}else{var toUrl=$btn.attr("data-endorse-url");window.location.href=toUrl}}
function toLoginPage(){window.location.href=contextPath+"/login"}
function doBeforeEndorse(){var btn=this;$.ajax({type:"POST",url:checkBeforeEndorseEndPoint,contentType:"application/json",targetButton:btn,beforeSend:function(){$.blockUI()},success:function(resp){$.unblockUI();if(!resp.success){if(resp.result==="-201")pickupLoginStep(this.targetButton);else if(["-202","-203"].indexOf(resp.result)!==-1)window.location.href=reverificationUrl;return}var msg="";var html="依使用者基本資料登錄規範，已達附議上限，請參閱\x3ca href\x3d'"+contextPath+userMobileQAUri+"' target\x3d'_blank' title\x3d'另開新視窗前往手機與綁定帳號規範'\x3e《手機與綁定帳號規範》\x3c/a\x3e。";
var code=resp.result.code;if(code==="-100")msg="提醒您，此手機與電子信箱已進行附議完成，"+html;else if(code==="-101")msg="提醒您，此手機門號已附議三次，"+html;if(msg.length>0){_displayMessageHtml({header:"",message:msg});return}if(_isIdeaEndorseEasyEnable)getEndorse();else window.location.href=contextPath+"/idea/endorse/step1/"+ideaViewModel.ideaDetail.id()},complete:function(){},error:function(){alert("系統異常")}})}
function loadEndorseMapData(options){var opt=$.extend({"id":null},options);if(opt.id===null)return;var $taiwanImgElt=$("#taiwan-img");if($taiwanImgElt.attr("data-c-init")!=="1"){$taiwanImgElt.attr("data-c-init","1");$("#taiwan-img path, div.city-area path").each(function(idx,item){var $item=$(item),showText=$item.attr("data-name")+"(0)",showDesc="附議人數："+showText;var attrTitle="";if($item.attr("data-key")!=="")attrTitle="點擊查看鄉鎮市區";$item.on("click",function(){var $this=$(this);if(/^C([0-9])+$/.test($this.attr("data-id"))){onCityArea($this.attr("data-key"));
try{ideaViewModel.endorseListView.doChangeCity($this.attr("data-name"))}catch(e){}}else if(/^A([0-9])+$/.test($this.attr("data-id")))try{ideaViewModel.endorseListView.doChangeArea($this.attr("data-name"))}catch(e$0){}}).on("keydown",function(e){if(e.keyCode===13){var $this=$(this);if(/^A([0-9])+$/.test($this.attr("data-id"))){e.preventDefault();$this.trigger("click")}return false}return true}).on("mouseenter",function(e){var $this=$(this);$(".c-map.countyName-box").addClass("active").html($this.attr("data-count"))}).on("mouseleave",
function(){$(".c-map.countyName-box").removeClass("active").html("")}).attr("data-count",showText).attr("data-count-value",0).attr("aria-label",attrTitle).attr("title",attrTitle).addClass("areaFill-zero");$item.find("desc").text(showDesc)});$("#taiwan-img, .city-area").on("mousemove",function(e){var parentOffset=$(this).offset();$(".c-map.countyName-box").css({left:e.pageX-parentOffset.left-10,top:e.pageY-parentOffset.top-70})});$(".countyTw").on("keyup",function(event){if(event.keyCode===13){$(event.target).trigger("click");
return false}return true})}$.ajax({type:"GET",url:contextPath+"/idea/v2/data/endorser/countMap",data:{"ideaId":opt.id},contentType:"application/json",success:function(resp){if(!resp.success){console.log("error: ",resp.result);return}var result=resp.result;var dataOnCity=result["endorseCountOnCity"]||[];$.each(dataOnCity,function(idx,data){var findId="C"+data.cityId;var showText=data.cityName+"("+data.value+")";var showDesc="附議人數："+showText;$('#taiwan-img path[data-id\x3d"'+findId+'"]').attr("data-count-value",
data.value).attr("data-count",showText).removeClass("areaFill-zero areaFill-one areaFill-two areaFill-three areaFill-four areaFill-five").addClass(resolveCountToMapClass(data.value)).find("desc").text(showDesc)});var dataOnArea=result["endorseCountOnArea"]||[];$.each(dataOnArea,function(idx,data){var findId="A"+data.areaId;var showText=data.areaName+"("+data.value+")";var showDesc="附議人數："+showText;$('div.city-area path[data-id\x3d"'+findId+'"]').attr("data-count-value",data.value).attr("data-count",
showText).removeClass("areaFill-zero areaFill-one areaFill-two areaFill-three areaFill-four areaFill-five").addClass(resolveCountToMapClass(data.value)).find("desc").text(showDesc)})},error:function(){console.log("happened error")}})}
function resolveCountToMapClass(val){if(val===null)return"areaFill-zero";if(val===0)return"areaFill-zero";else if(val<=500)return"areaFill-one";else if(val>=501&&val<=999)return"areaFill-two";else if(val>=1E3&&val<=1999)return"areaFill-three";else if(val>=2E3&&val<=4999)return"areaFill-four";else if(val>=5E3)return"areaFill-five";return""}function onCityArea(cityId){$("#taiwan-img").css("display","none");$("#"+cityId).addClass("active");$("#return-map-Btn").css("display","block")}
function returnBigMap(){$(".city-area.active").removeClass("active");$("#return-map-Btn").css("display","none");$("#taiwan-img").css("display","block");try{ideaViewModel.endorseListView.doClearCity()}catch(ex){}};